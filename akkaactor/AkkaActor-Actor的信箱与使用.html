<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Actor的信箱与使用 &mdash; 梦境迷离</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://dreamylost.cn/akkaactor/AkkaActor-Actor%E7%9A%84%E4%BF%A1%E7%AE%B1%E4%B8%8E%E4%BD%BF%E7%94%A8.html"><link rel="alternate" type="application/atom+xml" title="梦境迷离" href="https://dreamylost.cn/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/favicon.ico"><meta property="og:title" content="Actor的信箱与使用"><meta name="keywords" content="梦境迷离, jxnu-liguobin"><meta name="og:keywords" content="梦境迷离, jxnu-liguobin"><meta name="description" content=""><meta name="og:description" content=""><meta property="og:url" content="https://dreamylost.cn/akkaactor/AkkaActor-Actor%E7%9A%84%E4%BF%A1%E7%AE%B1%E4%B8%8E%E4%BD%BF%E7%94%A8.html"><meta property="og:site_name" content="梦境迷离"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2019-10-24"> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-8236444920328818" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://dreamylost.cn/" title="梦境迷离"><span class="octicon octicon-mark-github"></span> 梦境迷离</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://dreamylost.cn/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://dreamylost.cn/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://dreamylost.cn/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://dreamylost.cn/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://dreamylost.cn/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Actor的信箱与使用"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Actor的信箱与使用</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2019/10/24 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://dreamylost.cn/categories/#AkkaActor" title="AkkaActor">AkkaActor</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 8240 字，约 24 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/images/qrcode.jpg" alt="梦境迷离" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-8236444920328818" data-ad-slot="1650902835"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><ul id="markdown-toc"><li><a href="#依赖" id="markdown-toc-依赖">依赖</a></li><li><a href="#邮箱选择" id="markdown-toc-邮箱选择">邮箱选择</a><ul><li><a href="#actor需要的消息队列类型" id="markdown-toc-actor需要的消息队列类型">Actor需要的消息队列类型</a></li><li><a href="#调度器需要的消息队列类型" id="markdown-toc-调度器需要的消息队列类型">调度器需要的消息队列类型</a></li><li><a href="#如何选择邮箱类型" id="markdown-toc-如何选择邮箱类型">如何选择邮箱类型</a></li><li><a href="#默认邮箱" id="markdown-toc-默认邮箱">默认邮箱</a></li><li><a href="#将哪些配置传递给邮箱类型" id="markdown-toc-将哪些配置传递给邮箱类型">将哪些配置传递给邮箱类型</a></li></ul></li><li><a href="#内建邮箱的实现" id="markdown-toc-内建邮箱的实现">内建邮箱的实现</a></li><li><a href="#邮箱配置示例" id="markdown-toc-邮箱配置示例">邮箱配置示例</a><ul><li><a href="#优先级邮箱" id="markdown-toc-优先级邮箱">优先级邮箱</a></li><li><a href="#控制消息" id="markdown-toc-控制消息">控制消息</a></li></ul></li><li><a href="#创建自己的邮箱类型" id="markdown-toc-创建自己的邮箱类型">创建自己的邮箱类型</a></li><li><a href="#systemactorof的特殊语义" id="markdown-toc-systemactorof的特殊语义">system.actorOf的特殊语义</a></li></ul><h3 id="依赖">依赖</h3><p>若要使用邮箱，必须在项目中添加下列依赖项：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span><span class="err"> </span><span class="o">+=</span><span class="err"> </span><span class="s">"com.typesafe.akka"</span><span class="err"> </span><span class="o">%%</span><span class="err"> </span><span class="s">"akka-actor"</span><span class="err"> </span><span class="o">%</span><span class="err"> </span><span class="s">"2.5.26"</span>
</code></pre></div></div><p>Akka的邮箱保存着发送给Actor的消息。通常，每个Actor都有自己的邮箱，但是使用BalancingPool，所有的路由器都将共享一个邮箱实例。 此处的邮箱与信箱意思等同，传递意思等同发送。</p><p>PS：利用邮箱缓存消息并非Actor模型自带的功能，而是Akka库的功能。</p><h3 id="邮箱选择">邮箱选择</h3><h4 id="actor需要的消息队列类型">Actor需要的消息队列类型</h4><p>通过让某个Actor扩展参数化特征RequiresMessageQueue，可以为特定类型的Actor要求某种类型的消息队列。以下是一个例子：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">import</span><span class="err"> </span><span class="nv">akka</span><span class="o">.</span><span class="py">dispatch</span><span class="o">.</span><span class="py">RequiresMessageQueue</span>
<span class="n">import</span><span class="err"> </span><span class="nv">akka</span><span class="o">.</span><span class="py">dispatch</span><span class="o">.</span><span class="py">BoundedMessageQueueSemantics</span>

<span class="n">class</span><span class="err"> </span><span class="nc">MyBoundedActor</span><span class="err"> </span><span class="k">extends</span><span class="err"> </span><span class="nc">MyActor</span><span class="err"> </span><span class="k">with</span><span class="err"> </span><span class="nc">RequiresMessageQueue</span><span class="o">[</span><span class="kt">BoundedMessageQueueSemantics</span><span class="o">]</span>
</code></pre></div></div><p>需要将RequiresMessageQueue特质的类型参数映射到配置中的邮箱，如下所示：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bounded-mailbox {
  mailbox-type = "akka.dispatch.NonBlockingBoundedMailbox"
  mailbox-capacity = 1000 
}

akka.actor.mailbox.requirements {
  "akka.dispatch.BoundedMessageQueueSemantics" = bounded-mailbox
}
</code></pre></div></div><p>现在，每次创建MyBoundedActor类型的Actor时，它都会尝试获得一个有界的邮箱。如果Actor在部署中配置了不同的邮箱（直接或通过具有指定邮箱类型的dispatcher），则将覆盖此映射配置。</p><blockquote><p>为Actor创建的邮箱中的队列类型将根据该特质中的所需类型进行检查，如果队列没有实现所需的类型，则Actor的创建将失败。</p></blockquote><h4 id="调度器需要的消息队列类型">调度器需要的消息队列类型</h4><p>调度器还可能需要运行在其上的Actor使用的邮箱类型。一个例子是BalancingDispatcher，它需要一个对多个并发消费者来说是线程安全的消息队列。这样的要求是在dispatcher配置部分中配置的，如下所示：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>my-dispatcher {
  mailbox-requirement = org.example.MyInterface //暂称requirement为“要求的或需要的邮箱类型”
}
</code></pre></div></div><p>给定的是一个类或接口的全限定名，然后确保它是消息队列的实现的超类型。如有冲突，例如，如果Actor需要一个不能满足此要求的邮箱类型，那么Actor的创建就会失败。</p><h4 id="如何选择邮箱类型">如何选择邮箱类型</h4><p>当创建一个Actor时，ActorRefProvider首先确定将执行它的调度器，然后按以下方式确定邮箱：</p><ol><li>如果Actor的部署配置部分包含mailbox key，那么指定的此配置部分将描述要使用的邮箱类型。</li><li>如果actor的Props包含邮箱选择（即在其上调用了WithMailbox），那么指定的此配置部分将描述要使用的邮箱类型（请注意，这需要是一个绝对配置路径，例如myapp.Special-mailbox，而不是嵌套在Akka命名空间中的相对路径）。</li><li>如果dispatcher的配置部分包含mailbox-type key，则将使用相同部分来配置邮箱类型。</li><li>如果Actor需要如上所述的邮箱类型，则将使用该要求的映射来确定要使用的邮箱类型；如果失败则将尝试dispatcher的（如果有的话）。</li><li>如果dispatcher需要如上所述的邮箱类型，则将使用该要求的映射来确定要使用的邮箱类型。</li><li>默认邮箱akka.actor.default-mailbox将被使用。</li></ol><p>此处有点难以理解可能有偏差，可以参考英文理解，<a href="https://doc.akka.io/docs/akka/current/mailboxes.html">官网文档</a>。我理解这里是一个优先级关系，但可能描述不太好理解，这里“该要求的映射应该是指配置中mailbox-requirement的值”。</p><h4 id="默认邮箱">默认邮箱</h4><p>如果未如上所述指定需要的邮箱，则使用默认邮箱。默认情况下，它是一个无边界邮箱，由java.util.concurrent.concurrentlinkedqueue支持。</p><p>SingleConsumerOnlyUndeddedMailbox是一个更高效的邮箱，它可以用作默认邮箱，但不能与BalancingDispatcher一起使用。</p><p>将SingleConsumerOnlyUnderdedMailbox配置为默认邮箱：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>akka.actor.default-mailbox {
  mailbox-type = "akka.dispatch.SingleConsumerOnlyUnboundedMailbox"
}
</code></pre></div></div><h4 id="将哪些配置传递给邮箱类型">将哪些配置传递给邮箱类型</h4><p>每个邮箱类型都由一个类实现，该类扩展了MailboxType，并接受两个构造函数参数：ActorSystem.Settings对象和Config部分。后者是通过从Actor系统的配置中获取命名的配置部分，用邮箱类型的配置路径覆盖其id key并向默认邮箱配置部分添加fall-back来实现的</p><h3 id="内建邮箱的实现">内建邮箱的实现</h3><p>Akka附带了许多邮箱实现，如下所示：</p><p>这些邮箱几乎都是无界且非阻塞的。</p><ul><li>UnboundedMailbox（默认）<ul><li>默认邮箱</li><li>实现：基于java.util.concurrent.ConcurrentLinkedQueue</li><li>阻塞：否</li><li>有界性：否</li><li>配置名称：unbounded 或 akka.dispatch.UnboundedMailbox</li></ul></li><li>SingleConsumerOnUnedMailbox<ul><li>这个队列可能比默认队列快，也可能不快，这取决于您的用例（一定要正确地进行基准测试）</li><li>实现：基于多生产者单消费者的队列，不能与BalancingDispatcher同时使用</li><li>阻塞：否</li><li>有界性：否</li><li>配置名称：akka.dispatch.SingleConsumerOnlyUnboundedMailbox</li></ul></li><li>NonBlockingBoundedMailbox<ul><li>实现：基于一种高效的多生产者单消费者队列</li><li>阻塞：否，将溢出的消息丢弃到死信中</li><li>有界性：是</li><li>配置名称：akka.dispatch.NonBlockingBoundedMailbox</li></ul></li><li>UnboundedControlAwareMailbox<ul><li>传递具有更高优先级的继承自akka.dispatch.ControlMessage的消息</li><li>实现：基于两个java.util.concurrent.ConcurrentLinkedQueue</li><li>阻塞：否</li><li>有界性：否</li><li>配置名称：akka.dispatch.UnboundedControlAwareMailbox</li></ul></li><li>UnboundedPriorityMailbox<ul><li>相同优先级消息的传递顺序是未定义的（与StablePriorityMailbox形成对比）</li><li>实现：基于java.util.concurrent.PriorityBlockingQueue</li><li>阻塞：否</li><li>有界性：否</li><li>配置名称：akka.dispatch.UnboundedPriorityMailbox</li></ul></li><li>UnboundedStablePriorityMailbox<ul><li>对于优先级相同的消息保留FIFO顺序（与UnboundedPriorityMailbox形成对比）</li><li>实现：基于akka.util.PriorityQueueStabilizer（封装了java.util.concurrent.PriorityBlockingQueue）</li><li>阻塞：否</li><li>有界性：否</li><li>配置名称：akka.dispatch.UnboundedStablePriorityMailbox</li></ul></li></ul><p>当达到容量并配置的mailbox-push-timeout-time为非0，其他有界限的邮箱实现将阻止发送者。</p><blockquote><p>以下邮箱只应与mailbox-push-timeout-time为0的一起使用，因为当mailbox-push-timeout-time非0时，下面所有的信箱都是阻塞的，反应式不推荐使用阻塞，万不得已也应当隔离出阻塞操作到独立的调度线程。</p></blockquote><ul><li>BoundedMailbox<ul><li>实现：基于java.util.concurrent.LinkedBlockingQueue</li><li>阻塞：若与mailbox-push-timeout-time不为0时一起使用则是，否则不是</li><li>有界性：是</li><li>配置名称：bounded 或 akka.dispatch.BoundedMailbox</li></ul></li><li>BoundedPriorityMailbox<ul><li>实现：基于akka.util.BoundedBlockingQueue（封装了java.util.PriorityQueue）</li><li>相同优先级消息的传递顺序是未定义的（与BoundedStablePriorityMailbox形成对比）</li><li>阻塞：若与mailbox-push-timeout-time不为0时一起使用则是，否则不是</li><li>有界性：是</li><li>配置名称：akka.dispatch.BoundedPriorityMailbox</li></ul></li><li>BoundedStablePriorityMailbox<ul><li>实现：基于akka.util.PriorityQueueStabilizer（封装了java.util.PriorityQueue）</li><li>阻塞：若与mailbox-push-timeout-time不为0时一起使用则是，否则不是</li><li>有界性：是</li><li>配置名称：akka.dispatch.BoundedStablePriorityMailbox</li></ul></li><li>BoundedControlAwareMailbox<ul><li>传递具有更高优先级的继承自akka.dispatch.ControlMessage的消息</li><li>实现：基于两个java.util.concurrent.ConcurrentLinkedQueue，如果已达到容量，则阻塞队列。</li><li>阻塞：若与mailbox-push-timeout-time不为0时一起使用则是，否则不是</li><li>有界性：是</li><li>配置名称：akka.dispatch.BoundedControlAwareMailbox</li></ul></li></ul><h3 id="邮箱配置示例">邮箱配置示例</h3><h4 id="优先级邮箱">优先级邮箱</h4><p>如何创建PriorityMailbox：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.dispatch.PriorityGenerator</span>
<span class="k">import</span> <span class="nn">akka.dispatch.UnboundedStablePriorityMailbox</span>
<span class="k">import</span> <span class="nn">com.typesafe.config.Config</span>

<span class="c1">// We inherit, in this case, from UnboundedStablePriorityMailbox</span>
<span class="c1">// and seed it with the priority generator</span>
<span class="k">class</span> <span class="nc">MyPrioMailbox</span><span class="o">(</span><span class="n">settings</span><span class="k">:</span> <span class="kt">ActorSystem.Settings</span><span class="o">,</span> <span class="n">config</span><span class="k">:</span> <span class="kt">Config</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">UnboundedStablePriorityMailbox</span><span class="o">(</span>
      <span class="c1">// Create a new PriorityGenerator, lower prio means more important</span>
      <span class="nc">PriorityGenerator</span> <span class="o">{</span>
        <span class="c1">//如果可能的话，应该首先处理高优先级的消息</span>
        <span class="k">case</span> <span class="ss">'highpriority</span> <span class="k">=&gt;</span> <span class="mi">0</span>

        <span class="c1">//如果可能的话，应该最后处理低优先级的消息</span>
        <span class="k">case</span> <span class="ss">'lowpriority</span> <span class="k">=&gt;</span> <span class="mi">2</span>

        <span class="c1">// PoisonPill when no other left</span>
        <span class="k">case</span> <span class="nc">PoisonPill</span> <span class="k">=&gt;</span> <span class="mi">3</span>

        <span class="c1">// We default to 1, which is in between high and low</span>
        <span class="k">case</span> <span class="n">otherwise</span> <span class="k">=&gt;</span> <span class="mi">1</span>
      <span class="o">}</span>
</code></pre></div></div><p>然后将其添加到配置中：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prio-dispatcher {
  mailbox-type = "docs.dispatcher.DispatcherDocSpec$MyPrioMailbox"
  //Other dispatcher configuration goes here
}
</code></pre></div></div><p>然后是一个如何使用它的例子：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// We create a new Actor that just prints out what it processes</span>
<span class="k">class</span> <span class="nc">Logger</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">log</span><span class="k">:</span> <span class="kt">LoggingAdapter</span> <span class="o">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>

  <span class="n">self</span> <span class="o">!</span> <span class="ss">'lowpriority</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'lowpriority</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'highpriority</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'pigdog</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'pigdog2</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'pigdog3</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'highpriority</span>
  <span class="n">self</span> <span class="o">!</span> <span class="nc">PoisonPill</span>

  <span class="k">def</span> <span class="nf">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="nv">x</span><span class="o">.</span><span class="py">toString</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="nv">system</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Logger</span><span class="o">],</span> <span class="k">this</span><span class="o">).</span><span class="py">withDispatcher</span><span class="o">(</span><span class="s">"prio-dispatcher"</span><span class="o">))</span>

<span class="cm">/*
 * Logs:
 * 'highpriority
 * 'highpriority
 * 'pigdog
 * 'pigdog2
 * 'pigdog3
 * 'lowpriority
 * 'lowpriority
 */</span>
</code></pre></div></div><p>还可以像这样直接配置邮箱类型（这是顶级配置条目）：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prio-mailbox {
  mailbox-type = "docs.dispatcher.DispatcherDocSpec$MyPrioMailbox"
  //Other mailbox configuration goes here
}

akka.actor.deployment {
  /priomailboxactor {
    mailbox = prio-mailbox
  }
}
</code></pre></div></div><p>然后在部署中使用它，如下所示：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.actor.Props</span>
<span class="k">val</span> <span class="nv">myActor</span> <span class="k">=</span> <span class="nv">context</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">MyActor</span><span class="o">],</span> <span class="s">"priomailboxactor"</span><span class="o">)</span>
</code></pre></div></div><p>或者这样的代码：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.actor.Props</span>
<span class="k">val</span> <span class="nv">myActor</span> <span class="k">=</span> <span class="nv">context</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">MyActor</span><span class="o">].</span><span class="py">withMailbox</span><span class="o">(</span><span class="s">"prio-mailbox"</span><span class="o">))</span>
</code></pre></div></div><h4 id="控制消息">控制消息</h4><p>如果一个Actor需要能够立即接收控制消息，那么ControlAwareMailbox就会非常有用，而不管它的邮箱中已经有多少其他消息。如前介绍，这个消息类型优先级更高。</p><p>它可以配置如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>control-aware-dispatcher {
  mailbox-type = "akka.dispatch.UnboundedControlAwareMailbox"
  //Other dispatcher configuration goes here
}
</code></pre></div></div><p>控制消息需要扩展ControlMessage特质：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.dispatch.ControlMessage</span>

<span class="k">case</span> <span class="k">object</span> <span class="nc">MyControlMessage</span> <span class="k">extends</span> <span class="nc">ControlMessage</span>
</code></pre></div></div><p>然后是一个如何使用它的例子：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// We create a new Actor that just prints out what it processes</span>
<span class="k">class</span> <span class="nc">Logger</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">log</span><span class="k">:</span> <span class="kt">LoggingAdapter</span> <span class="o">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="nv">context</span><span class="o">.</span><span class="py">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>

  <span class="n">self</span> <span class="o">!</span> <span class="ss">'foo</span>
  <span class="n">self</span> <span class="o">!</span> <span class="ss">'bar</span>
  <span class="n">self</span> <span class="o">!</span> <span class="nc">MyControlMessage</span>
  <span class="n">self</span> <span class="o">!</span> <span class="nc">PoisonPill</span>

  <span class="k">def</span> <span class="nf">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="nv">x</span><span class="o">.</span><span class="py">toString</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="nv">system</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Logger</span><span class="o">],</span> <span class="k">this</span><span class="o">).</span><span class="py">withDispatcher</span><span class="o">(</span><span class="s">"control-aware-dispatcher"</span><span class="o">))</span>

<span class="cm">/*
 * Logs:
 * MyControlMessage
 * 'foo
 * 'bar
 */</span>
</code></pre></div></div><h3 id="创建自己的邮箱类型">创建自己的邮箱类型</h3><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Marker trait used for mailbox requirements mapping</span>
<span class="k">trait</span> <span class="nc">MyUnboundedMessageQueueSemantics</span>
</code></pre></div></div><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">boundedMailbox</span> <span class="k">extends</span> <span class="nc">MailboxType</span> <span class="k">with</span> <span class="nc">ProducesMessageQueue</span><span class="o">[</span><span class="kt">MyUnboundedMailbox.MyMessageQueue</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">MyUnboundedMailbox._</span>

  <span class="c1">// 此构造函数签名必须存在，它将由Akka调用。</span>
  <span class="k">def</span> <span class="nf">this</span><span class="o">(</span><span class="n">settings</span><span class="k">:</span> <span class="kt">ActorSystem.Settings</span><span class="o">,</span> <span class="n">config</span><span class="k">:</span> <span class="kt">Config</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// 将你的初始化代码放在这里</span>
    <span class="nf">this</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="c1">// 调用create方法来创建MessageQueue</span>
  <span class="k">final</span> <span class="k">override</span> <span class="k">def</span> <span class="nf">create</span><span class="o">(</span><span class="n">owner</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">],</span> <span class="n">system</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">ActorSystem</span><span class="o">])</span><span class="k">:</span> <span class="kt">MessageQueue</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">MyMessageQueue</span><span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div><p>然后将MailboxType的FQCN指定为dispatcher配置或邮箱配置中“mailbox-type”的值。</p><blockquote><p>确保包含一个构造函数，该构造函数需要akka.actor.ActorSystem.Settings和com.ypesafe.config.Config参数，因为此构造函数是以反射方式调用来构造你的邮箱类型的。作为第二个参数传入的配置是配置中使用此邮箱类型描述dispatcher或邮箱设置的部分；将对使用该配置类型的每个dispatcher或邮箱设置实例化邮箱类型一次。</p></blockquote><p>您还可以使用邮箱作为调度器的要求（requirement ），如下所示：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>custom-dispatcher {
  mailbox-requirement =
  "jdocs.dispatcher.MyUnboundedMessageQueueSemantics"
}

akka.actor.mailbox.requirements {
  "jdocs.dispatcher.MyUnboundedMessageQueueSemantics" =
  custom-dispatcher-mailbox
}

custom-dispatcher-mailbox {
  mailbox-type = "jdocs.dispatcher.MyUnboundedMailbox"
}
</code></pre></div></div><p>或者像这样定义Actor类的要求：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySpecialActor</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="k">with</span> <span class="nc">RequiresMessageQueue</span><span class="o">[</span><span class="kt">MyUnboundedMessageQueueSemantics</span><span class="o">]</span> <span class="o">{</span>
  <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div><h3 id="systemactorof的特殊语义">system.actorOf的特殊语义</h3><p>为了使system.actorOf同步和非阻塞，同时保持返回类型ActorRef（以及返回的ref全部功能的语义），对这种情况进行特殊处理。 在幕后，构造了一种无意义的Actor引用，它被发送给系统的监护人Actor，实际上是监护人Actor创建了该Actor及其上下文，并将这些内容放入到该Actor的引用中。在此之前，发送给ActorRef的消息将在本地排队，只有在交换了真正的填充后，它们才会被传输到真正的邮箱中。因此，</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">props</span><span class="k">:</span> <span class="kt">Props</span> <span class="o">=</span> <span class="o">...</span>
<span class="c1">//此actor使用MyCustomMailbox，假定它是一个单例</span>
<span class="nv">system</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nv">props</span><span class="o">.</span><span class="py">withDispatcher</span><span class="o">(</span><span class="s">"myCustomMailbox"</span><span class="o">))</span> <span class="o">!</span> <span class="s">"bang"</span>
<span class="nf">assert</span><span class="o">(</span><span class="nv">MyCustomMailbox</span><span class="o">.</span><span class="py">instance</span><span class="o">.</span><span class="py">getLastEnqueuedMessage</span> <span class="o">==</span> <span class="s">"bang"</span><span class="o">)</span>
</code></pre></div></div><p>可能会失败；您必须留出一些时间来通过并重试检查</p><ul><li>使用搜狗翻译、百度翻译、谷歌翻译，仅供参考</li><li>来自官方文档、参考《响应式架构 消息模式Actor实现与Scala、Akka应用集成》</li><li>后续随着理解深入会继续修改错误和描述，以便更好理解，本博客开源，欢迎指出错误</li></ul><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://dreamylost.cn" target="_blank">梦境迷离</a></li><li>本文链接：<a href="https://dreamylost.cn/akkaactor/AkkaActor-Actor%E7%9A%84%E4%BF%A1%E7%AE%B1%E4%B8%8E%E4%BD%BF%E7%94%A8.html" target="_blank">https://dreamylost.cn/akkaactor/AkkaActor-Actor%E7%9A%84%E4%BF%A1%E7%AE%B1%E4%B8%8E%E4%BD%BF%E7%94%A8.html</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/akkaactor/AkkaActor-Actor%E7%9A%84%E4%BF%A1%E7%AE', clientID: '061aadb5d449c0877d7d', clientSecret: '9aa7af7c248a7e36a07a86993e11a7acf7fbd353', repo: 'dreamylost-comments', owner: 'jxnu-liguobin', admin: ['jxnu-liguobin'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@built/assets/search_data.json?v=1617168839', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8236444920328818" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2019 <span title="梦境迷离">梦境迷离</span> <a href="http://www.beian.miit.gov.cn/publish/query/indexFirst.action" rel="nofollow" target="_blank">赣ICP备17017283号-1</a> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/jxnu-liguobin/jxnu-liguobin.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://dreamylost.cn/" title="首页" target="">首页</a></li><li> <a href="https://dreamylost.cn/categories/" title="分类" target="">分类</a></li><li> <a href="https://dreamylost.cn/wiki/" title="维基" target="">维基</a></li><li> <a href="https://dreamylost.cn/links/" title="链接" target="">链接</a></li><li> <a href="https://dreamylost.cn/about/" title="关于" target="">关于</a></li><li><a href="https://dreamylost.cn/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2019-09-20 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-147390701-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
