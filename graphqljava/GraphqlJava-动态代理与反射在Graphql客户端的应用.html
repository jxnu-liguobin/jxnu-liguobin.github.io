<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>动态代理与反射在Graphql客户端的应用 &mdash; 梦境迷离</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://dreamylost.cn/graphqljava/GraphqlJava-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%B0%84%E5%9C%A8Graphql%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8.html"><link rel="alternate" type="application/atom+xml" title="梦境迷离" href="https://dreamylost.cn/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/favicon.ico"><meta property="og:title" content="动态代理与反射在Graphql客户端的应用"><meta name="keywords" content="梦境迷离, jxnu-liguobin"><meta name="og:keywords" content="梦境迷离, jxnu-liguobin"><meta name="description" content=""><meta name="og:description" content=""><meta property="og:url" content="https://dreamylost.cn/graphqljava/GraphqlJava-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%B0%84%E5%9C%A8Graphql%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8.html"><meta property="og:site_name" content="梦境迷离"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2020-08-11"> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://dreamylost.cn/" title="梦境迷离"><span class="octicon octicon-mark-github"></span> 梦境迷离</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://dreamylost.cn/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://dreamylost.cn/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://dreamylost.cn/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://dreamylost.cn/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://dreamylost.cn/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="动态代理与反射在Graphql"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">动态代理与反射在Graphql客户端的应用</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2020/08/11 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://dreamylost.cn/categories/#GraphqlJava" title="GraphqlJava">GraphqlJava</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 15171 字，约 44 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/images/qrcode.jpg" alt="梦境迷离" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><ul id="markdown-toc"><li><a href="#反射与动态代理实践" id="markdown-toc-反射与动态代理实践">反射与动态代理实践</a><ul><li><a href="#简介" id="markdown-toc-简介">简介</a></li><li><a href="#普通方式" id="markdown-toc-普通方式">普通方式</a></li><li><a href="#动态代理--反射" id="markdown-toc-动态代理--反射">动态代理 &amp; 反射</a></li></ul></li></ul><h1 id="反射与动态代理实践">反射与动态代理实践</h1><h2 id="简介">简介</h2><p>目前需要使用 graphql 对外提供 open api，准备开发一个 sdk，使得尽可能的自动实现 graphql 的调用。也就是绝大部分代码使用代码生成。</p><p>代码生成主要针对 Java，其他 JVM 语言都可以使用，对于其他语言也可以参考类似的设计方法。 使用的库是 <a href="https://github.com/kobylynskyi/graphql-java-codegen">graphql-java-codegen</a>，该工具参考了 swagger-api 。</p><p>熟悉 graphql 的人应该知道，graphql 具有复杂的数据类型定义和更强的功能支持，如果要使用代码生成，但是编程语言与该类型不存在一一对应的关系，则可能会增加设计工具的复杂性。 好在 Java 支持绝大多数的 graphql 类型，我们使用的 graphql-java-codegen 也很好的支持了代码生成这一步。</p><p>总的来说，对 graphql-java-codegen 而言，会抽象出四个主要的模型：</p><ul><li>Request 用于抽象 graphql 的请求参数和请求类型，目前在 graphql 中没有 HTTP 的 GET/POST/DELETE/PUT，只有 query/mutation/subscription</li><li>Response 用于抽象 graphql 的返回数据结构，众所周知，graphql 是强类型的，类似 protobuffer。</li><li>Response Projection 有了返回的数据结构我们还需要选择返回哪些字段，这是 graphql 的特性之一，通常我们只返回我们需要的字段。</li><li>Resolver 用于抽象 graphql 的接口，每个 resolver 都是一个 graphql 中的一个方法，对应一个 HTTP 调用。需要注意的是，对一个资源的操作，CRUD 可以生成四个 resolver，每个仅有一个方法；也可以仅生成一个 resolver 接口包含有四个方法。这取决于代码生成策略。</li></ul><p>有了上面基础，我们在看如何使用生成的实现 graphql client。</p><p>我们的 schema 如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type Query {
    hero(episode: Episode) : Character
    human(id : String) : Human
    humans: [Human]
    droid(id: ID!) : Droid
}
interface Character {
    id: ID!
    name: String!
    friends: [Character]
    appearsIn: [Episode]!
    secretBackstory : String @deprecated(reason : "We have decided that this is not canon")
}

type Human implements Character {
    id: ID!
    name: String!
    friends: [Character]
    appearsIn: [Episode]!
    homePlanet: String
    secretBackstory : String @deprecated(reason : "We have decided that this is not canon")
    email: Email!
}

type Droid implements Character {
    id: ID!
    name: String!
    friends: [Character]
    appearsIn: [Episode]!
    primaryFunction: String
    secretBackstory : String @deprecated(reason : "We have decided that this is not canon")
}
</code></pre></div></div><h2 id="普通方式">普通方式</h2><p>我们使用测试代码生成了一个 resolver，它包含了四个方法</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@javax</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">Generated</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">"com.kobylynskyi.graphql.codegen.GraphQLCodegen"</span><span class="o">,</span>
    <span class="n">date</span> <span class="o">=</span> <span class="s">"2020-08-10T15:37:50+0800"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">QueryResolver</span> <span class="o">{</span>

    <span class="nd">@com</span><span class="o">.</span><span class="na">fasterxml</span><span class="o">.</span><span class="na">jackson</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">JsonTypeInfo</span><span class="o">(</span><span class="n">use</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">fasterxml</span><span class="o">.</span><span class="na">jackson</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">JsonTypeInfo</span><span class="o">.</span><span class="na">Id</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span> <span class="n">include</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">fasterxml</span><span class="o">.</span><span class="na">jackson</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">JsonTypeInfo</span><span class="o">.</span><span class="na">As</span><span class="o">.</span><span class="na">PROPERTY</span><span class="o">,</span><span class="n">property</span> <span class="o">=</span> <span class="s">"__typename"</span><span class="o">)</span>
    <span class="nd">@com</span><span class="o">.</span><span class="na">fasterxml</span><span class="o">.</span><span class="na">jackson</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">JsonSubTypes</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nd">@com</span><span class="o">.</span><span class="na">fasterxml</span><span class="o">.</span><span class="na">jackson</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">HumanDO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"Human"</span><span class="o">),</span>
        <span class="nd">@com</span><span class="o">.</span><span class="na">fasterxml</span><span class="o">.</span><span class="na">jackson</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">DroidDO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"Droid"</span><span class="o">)})</span>
    <span class="nc">CharacterDO</span> <span class="nf">hero</span><span class="o">(</span><span class="nc">EpisodeDO</span> <span class="n">episode</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>

    <span class="nc">HumanDO</span> <span class="nf">human</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>

    <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">List</span><span class="o">&lt;</span><span class="nc">HumanDO</span><span class="o">&gt;</span> <span class="nf">humans</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>

    <span class="nc">DroidDO</span> <span class="nf">droid</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div><p>正常情况下，我们应该实现这个接口，然后使用IOC注入这个接口或者 new 接口的实现类，调用 graphql 服务端。 下面是一个使用 Scala 实现的 QueryResolverImpl</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">QueryResolverImpl</span> <span class="k">extends</span> <span class="nc">QueryResolver</span> <span class="o">{</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">hero</span><span class="o">(</span><span class="n">episode</span><span class="k">:</span> <span class="kt">EpisodeDO</span><span class="o">)</span><span class="k">:</span> <span class="kt">CharacterDO</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">heroQueryRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HeroQueryRequest</span>
    <span class="nv">heroQueryRequest</span><span class="o">.</span><span class="py">setEpisode</span><span class="o">(</span><span class="n">episode</span><span class="o">)</span>
    <span class="c1">//must use typename, and add jackson annotation to support, since v2.4</span>
    <span class="k">val</span> <span class="nv">characterResponseProjection</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CharacterResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()</span>
      <span class="o">.</span><span class="py">friends</span><span class="o">(</span><span class="k">new</span> <span class="nc">CharacterResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()).</span><span class="py">appearsIn</span><span class="o">()</span>
    <span class="k">val</span> <span class="nv">graphQLRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GraphQLRequest</span><span class="o">(</span><span class="n">heroQueryRequest</span><span class="o">,</span> <span class="n">characterResponseProjection</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">retFuture</span> <span class="k">=</span> <span class="nv">OkHttp</span><span class="o">.</span><span class="py">executeRequest</span><span class="o">(</span><span class="n">graphQLRequest</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">[</span><span class="kt">CharacterDO</span><span class="o">]</span> <span class="o">{})</span>
    <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">Await</span><span class="o">.</span><span class="py">result</span><span class="o">(</span><span class="n">retFuture</span><span class="o">,</span> <span class="nv">Duration</span><span class="o">.</span><span class="py">Inf</span><span class="o">)</span>
    <span class="n">ret</span>
  <span class="o">}</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">human</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">HumanDO</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">humanQueryRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HumanQueryRequest</span>
    <span class="nv">humanQueryRequest</span><span class="o">.</span><span class="py">setId</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
    <span class="c1">//must use typename, and add jackson annotation to support, since v2.4</span>
    <span class="k">val</span> <span class="nv">humanResponseProjection</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HumanResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()</span>
    <span class="k">val</span> <span class="nv">graphQLRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GraphQLRequest</span><span class="o">(</span><span class="n">humanQueryRequest</span><span class="o">,</span> <span class="n">humanResponseProjection</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">retFuture</span> <span class="k">=</span> <span class="nv">OkHttp</span><span class="o">.</span><span class="py">executeRequest</span><span class="o">(</span><span class="n">graphQLRequest</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">[</span><span class="kt">HumanDO</span><span class="o">]</span> <span class="o">{})</span>
    <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">Await</span><span class="o">.</span><span class="py">result</span><span class="o">(</span><span class="n">retFuture</span><span class="o">,</span> <span class="nv">Duration</span><span class="o">.</span><span class="py">Inf</span><span class="o">)</span>
    <span class="n">ret</span>
  <span class="o">}</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">humans</span><span class="k">:</span> <span class="kt">util.List</span><span class="o">[</span><span class="kt">HumanDO</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">scala.collection.JavaConverters._</span>
    <span class="k">val</span> <span class="nv">humanQueryRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HumansQueryRequest</span>
    <span class="c1">//must use typename, and add jackson annotation to support, since v2.4</span>
    <span class="k">val</span> <span class="nv">humanResponseProjection</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HumanResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()</span>
    <span class="k">val</span> <span class="nv">graphQLRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GraphQLRequest</span><span class="o">(</span><span class="n">humanQueryRequest</span><span class="o">,</span> <span class="n">humanResponseProjection</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">retFuture</span> <span class="k">=</span> <span class="nv">OkHttp</span><span class="o">.</span><span class="py">executeRequest</span><span class="o">(</span><span class="n">graphQLRequest</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">HumanDO</span><span class="o">]]</span> <span class="o">{})</span>
    <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">Await</span><span class="o">.</span><span class="py">result</span><span class="o">(</span><span class="n">retFuture</span><span class="o">,</span> <span class="nv">Duration</span><span class="o">.</span><span class="py">Inf</span><span class="o">)</span>
    <span class="nv">ret</span><span class="o">.</span><span class="py">asJava</span>
  <span class="o">}</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">droid</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">DroidDO</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">productByIdQueryRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DroidQueryRequest</span>
    <span class="nv">productByIdQueryRequest</span><span class="o">.</span><span class="py">setId</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
    <span class="c1">//must use typename, and add jackson annotation to support, since v2.4</span>
    <span class="k">val</span> <span class="nv">droidResponseProjection</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DroidResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()</span>
    <span class="k">val</span> <span class="nv">graphQLRequest</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">GraphQLRequest</span><span class="o">(</span><span class="n">productByIdQueryRequest</span><span class="o">,</span> <span class="n">droidResponseProjection</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">retFuture</span> <span class="k">=</span> <span class="nv">OkHttp</span><span class="o">.</span><span class="py">executeRequest</span><span class="o">(</span><span class="n">graphQLRequest</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TypeReference</span><span class="o">[</span><span class="kt">DroidDO</span><span class="o">]</span> <span class="o">{})</span>
    <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">Await</span><span class="o">.</span><span class="py">result</span><span class="o">(</span><span class="n">retFuture</span><span class="o">,</span> <span class="nv">Duration</span><span class="o">.</span><span class="py">Inf</span><span class="o">)</span>
    <span class="n">ret</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>可以看到，不仅需要为每个 resolver 编写一个实现类，而且每个 request 都需要去 set 传进来的参数，并且需要实例化 projection 指定返回的字段（调用 projection 的方法，将其添加到 Map 中）；如果是嵌套的字段，还需要 typename。 很显然，所有 resolver 的实现，也都是这个流程，通过构造 request 和 projection 来实例化 GraphQLRequest，生成 graphql query，调用服务端接口。 所以我们可以使用动态代理来优化这个调用过程。</p><h2 id="动态代理--反射">动态代理 &amp; 反射</h2><p>首先，我们当然需要创建一个代理对象，我们定义一个 Java 类，叫做 ResolverImplClient</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.kobylynskyi.graphql.codegen.model.graphql.GraphQLOperationRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.kobylynskyi.graphql.codegen.model.graphql.GraphQLResponseProjection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>

<span class="cm">/**
 * invoker for proxy
 *
 * @author liguobin@growingio.com
 * @version 1.0, 2020/7/28
 */</span>
<span class="kd">final</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResolverImplClient</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolver</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">GraphQLResponseProjection</span> <span class="n">projection</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">GraphQLOperationRequest</span> <span class="n">request</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxDepth</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Object</span> <span class="nf">getResolver</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DynamicProxy</span> <span class="n">invocationHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DynamicProxy</span><span class="o">(</span><span class="n">projection</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">maxDepth</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">resolver</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]{</span><span class="n">resolver</span><span class="o">},</span> <span class="n">invocationHandler</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setResolver</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">resolver</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setRequest</span><span class="o">(</span><span class="nc">GraphQLOperationRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">request</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setMaxDepth</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxDepth</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxDepth</span> <span class="o">=</span> <span class="n">maxDepth</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setProjection</span><span class="o">(</span><span class="nc">GraphQLResponseProjection</span> <span class="n">projection</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ResolverImplClientBuilder</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">GraphQLResponseProjection</span> <span class="n">projection</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">GraphQLOperationRequest</span> <span class="n">request</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxDepth</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">ResolverImplClientBuilder</span><span class="o">()</span> <span class="o">{</span>

        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ResolverImplClientBuilder</span> <span class="nf">setRequest</span><span class="o">(</span><span class="nc">GraphQLOperationRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">request</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ResolverImplClientBuilder</span> <span class="nf">setMaxDepth</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxDepth</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxDepth</span> <span class="o">=</span> <span class="n">maxDepth</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">ResolverImplClientBuilder</span> <span class="nf">setProjection</span><span class="o">(</span><span class="nc">GraphQLResponseProjection</span> <span class="n">projection</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ResolverImplClientBuilder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ResolverImplClientBuilder</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Resolver is generic type, if we do not want to cast to real resolver on the user side, we need set resolver when invoker builder method,
         * although this is not in line with the conventional builder model
         *
         * @return R resolver which need for invoke graphql
         */</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"unchecked"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="no">R</span> <span class="nf">build</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="n">resolver</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ResolverImplClient</span> <span class="n">invoke</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResolverImplClient</span><span class="o">();</span>
            <span class="k">assert</span> <span class="o">(</span><span class="n">projection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">assert</span> <span class="o">(</span><span class="n">resolver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">assert</span> <span class="o">(</span><span class="n">request</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">invoke</span><span class="o">.</span><span class="na">setProjection</span><span class="o">(</span><span class="n">projection</span><span class="o">);</span>
            <span class="n">invoke</span><span class="o">.</span><span class="na">setResolver</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
            <span class="n">invoke</span><span class="o">.</span><span class="na">setMaxDepth</span><span class="o">(</span><span class="n">maxDepth</span><span class="o">);</span>
            <span class="n">invoke</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="k">return</span> <span class="o">(</span><span class="no">R</span><span class="o">)</span> <span class="n">invoke</span><span class="o">.</span><span class="na">getResolver</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div><p>这里我们将泛型放到了 build 方法上，是因为基于构建者模式，外部类的泛型在内部类 new 时会丢失则得到的代理对象需要强转，而强转增加了使用的复杂性，所以将泛型放到了最后的 build 方法。 当然，如果是 Scala，可以使用 runtimeclass，因为目的是想 JVM 语言都支持，所以这里都使用 Java 实现了。</p><p>知道如何构造代理对象，我们还需要定义处理函数，在 Java 中，我们只需要实现 InvocationHandler 接口（JDK动态代理）</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.kobylynskyi.graphql.codegen.model.graphql.GraphQLOperationRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.kobylynskyi.graphql.codegen.model.graphql.GraphQLResponseField</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.kobylynskyi.graphql.codegen.model.graphql.GraphQLResponseProjection</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Comparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>


<span class="cm">/**
 * dynamic proxy for create request
 * &lt;p&gt;
 * this is a experimental implement
 *
 * @author liguobin@growingio.com
 * @version 1.0, 2020/7/28
 */</span>
<span class="kd">final</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicProxy</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span><span class="o">,</span> <span class="nc">ExecutionGraphql</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">GraphQLResponseProjection</span> <span class="n">projection</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">GraphQLOperationRequest</span> <span class="n">request</span><span class="o">;</span>

    <span class="cm">/**
     * should limit max depth when invoke method on projection.
     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxDepth</span><span class="o">;</span>

    <span class="nc">DynamicProxy</span><span class="o">(</span><span class="nc">GraphQLResponseProjection</span> <span class="n">projection</span><span class="o">,</span> <span class="nc">GraphQLOperationRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxDepth</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">request</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">maxDepth</span> <span class="o">=</span> <span class="n">maxDepth</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"before Invoking"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"invoking by resolver implement"</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">t</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"invoking by dynamic proxy"</span><span class="o">);</span>
            <span class="k">return</span> <span class="nf">proxyInvoke</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     *  在处理投影（projection）时，我们使用反射直接调用所有方法（不处理alias），而在处理请求（需要参数）时，我们使用反射来获取 input 字段，这是基于 setXXX 方法的内部实现来实现的。
     *
     * @param parentProjection
     * @param parentMethod
     * @param currentDepth
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeOnProjection</span><span class="o">(</span><span class="nc">GraphQLResponseProjection</span> <span class="n">parentProjection</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">parentMethod</span><span class="o">,</span> <span class="kt">int</span> <span class="n">currentDepth</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//对于无参方法，我们使用了 `parentMethod.invoke(parentProjection, null);`，这里的 null 不能使用空数组替代。</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parentMethod</span><span class="o">.</span><span class="na">getParameterCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"method &lt;"</span> <span class="o">+</span> <span class="n">parentMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"&gt;"</span><span class="o">);</span>
                <span class="n">parentMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">parentProjection</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">//if this method have parameters, eg: name(String alias) or friends(CharacterResponseProjection subProjection), friends(CharacterResponseProjection subProjection, String alias),</span>
            <span class="c1">//we only handle do not have any alias, like: friends(CharacterResponseProjection subProjection)</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">parameterClazz</span> <span class="o">:</span> <span class="n">parentMethod</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">//处理只有一个参数的方法调用</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">parentMethod</span><span class="o">.</span><span class="na">getParameterCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="nc">GraphQLResponseProjection</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">parameterClazz</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">currentDepth</span><span class="o">++;</span>
                        <span class="nc">GraphQLResponseProjection</span> <span class="n">subProjection</span> <span class="o">=</span> <span class="o">(</span><span class="nc">GraphQLResponseProjection</span><span class="o">)</span> <span class="n">parameterClazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
                        <span class="c1">//at now,not support `..on`</span>
                        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Method</span><span class="o">&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">parameterClazz</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">()).</span><span class="na">filter</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"on"</span><span class="o">)).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
                        <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">subProjectionMethod</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
                            <span class="c1">//if this method have no parameter</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">subProjectionMethod</span><span class="o">.</span><span class="na">getParameterCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                                <span class="nc">String</span> <span class="n">t</span> <span class="o">=</span> <span class="s">"-&gt;"</span><span class="o">;</span>
                                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">currentDepth</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                                    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="s">"-&gt;"</span><span class="o">);</span>
                                <span class="o">}</span>
                                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t</span> <span class="o">+</span> <span class="s">" method &lt;"</span> <span class="o">+</span> <span class="n">subProjectionMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"&gt;"</span><span class="o">);</span>
                                <span class="n">subProjectionMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">subProjection</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">subProjectionMethod</span><span class="o">.</span><span class="na">getParameterCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nc">GraphQLResponseProjection</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">subProjectionMethod</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">()[</span><span class="mi">0</span><span class="o">]))</span> <span class="o">{</span>
                                <span class="c1">//if this method have one parameter and type is GraphQLResponseProjection sub class</span>
                                <span class="c1">//recursive continuation call</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">currentDepth</span> <span class="o">&lt;</span> <span class="n">maxDepth</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">invokeOnProjection</span><span class="o">(</span><span class="n">subProjection</span><span class="o">,</span> <span class="n">subProjectionMethod</span><span class="o">,</span> <span class="n">currentDepth</span><span class="o">);</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="c1">//TODO getParameterCount == 2, (GraphQLResponseProjection sub and String alias)</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="n">parentMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">parentProjection</span><span class="o">,</span> <span class="n">subProjection</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">//TODO getParameterCount == 2, (GraphQLResponseProjection sub and String alias)</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="o">|</span> <span class="nc">InvocationTargetException</span> <span class="o">|</span> <span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="nc">Object</span> <span class="nf">proxyInvoke</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GraphQLResponseField</span><span class="o">&gt;</span> <span class="n">fields</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">entityClazzName</span><span class="o">;</span>
        <span class="c1">//对于集合类型，目前只处理了 List，我们需要拿到它的泛型参数，才能正确反序列化。所以使用 `method.getGenericReturnType()` 获取 resolver 接口的方法的返回类型。</span>
        <span class="c1">//如果返回类型是一个 参数化类型，我们还需要继续获取其中的值。`Type[] parameterizedType = ((ParameterizedType) type).getActualTypeArguments();` 帮助我们获取该类型的参数化类型的列表，</span>
        <span class="c1">//由于我们只处理 List 类型，很显然，它只有一个参数化类型，所以我们使用 `entityClazzName = parameterizedType[0].getTypeName();`。</span>
        <span class="c1">//而当 resolver 接口的方法的返回类型是一个普通 entity 时，我们只需要直接获取它的类名即可。</span>
        <span class="c1">//使用 `type.getTypeName();`</span>
        <span class="nc">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getGenericReturnType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Type</span><span class="o">[]</span> <span class="n">parameterizedType</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">type</span><span class="o">).</span><span class="na">getActualTypeArguments</span><span class="o">();</span>
            <span class="n">entityClazzName</span> <span class="o">=</span> <span class="n">parameterizedType</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">getTypeName</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">entityClazzName</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getTypeName</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Parameter</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getParameters</span><span class="o">()).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

        <span class="c1">//if this method have no parameter, then do not need invoke on request instance</span>
        <span class="c1">//other wise, we need append parameters to request field which use hashmap store params</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">parameters</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Parameter</span> <span class="n">parameter</span> <span class="o">:</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Object</span> <span class="n">argsCopy</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
                    <span class="c1">//我们必须在反射时动态获取参数名称，所以我们应该使用java8的编译参数 -parameters，以便字节码中保留参数名称，否则参数名都是 var0 var1，没办法获取真实的参数名</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">getInput</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">argsCopy</span><span class="o">);</span>
                <span class="o">}</span>
         <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"fields"</span><span class="o">);</span>
            <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">GraphQLResponseField</span><span class="o">&gt;)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">projection</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchFieldException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">field</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">//if fields not null, use it directly, because user want to select fields</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">projection</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">fields</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">fields</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()))</span> <span class="o">{</span>
        <span class="c1">//获取自己定义的方法，因为很显然，projection 是提供本 response 的字段选择功能，而父类继承过来的方法，我们根本不需要。</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">m</span> <span class="o">:</span> <span class="n">projection</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethods</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">invokeOnProjection</span><span class="o">(</span><span class="n">projection</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nf">executeByHttp</span><span class="o">(</span><span class="n">entityClazzName</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">projection</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>这里有比较关键的几点，我们使用动态代理时，没有办法知道需要返回哪些字段，所以一律返回所有字段。我们不考虑使用传递参数的形式指定字段，这对于使用客户端的用户来说，不够友好，用户只需要得到数据。</p><p>且动态代理是自动构建 projection，所以也没有办法知道需要对嵌套查询如何终止，所以这里采用限制递归深度，每次仅查询最大深度为3的的子结构。</p><p>如果我们不递归调用子类型的 projection，无法返回嵌套结构。在 graphql 中，想要返回该数据中的字段的字段，则需要提供字段本身的详细结构。</p><p>如果我们不递归，friends 就不知道返回哪些数据，此时可以干脆去掉 friends()（此时返回结构中就没有 friends 的内容了），也可以向最上面普通方式一样：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">characterResponseProjection</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">CharacterResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()</span>
      <span class="o">.</span><span class="py">friends</span><span class="o">(</span><span class="k">new</span> <span class="nc">CharacterResponseProjection</span><span class="o">().</span><span class="py">id</span><span class="o">().</span><span class="py">name</span><span class="o">().</span><span class="py">typename</span><span class="o">()).</span><span class="py">appearsIn</span><span class="o">()</span> <span class="c1">//向 friends 传入 CharacterResponseProjection 查询 friends 的详细内容。</span>
</code></pre></div></div><p>现在我们可以使用动态代理来发起调用： 使用Java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.github.dreamylost.api.HumanQueryResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.dreamylost.api.HumansQueryResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.dreamylost.model.HumanDO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.dreamylost.model.HumanQueryRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.dreamylost.model.HumanResponseProjection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.github.dreamylost.model.HumansQueryRequest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author liguobin@growingio.com
 * @version 1.0, 2020/7/29
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HumanResolverJavaApp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">ResolverImplClient</span><span class="o">.</span><span class="na">ResolverImplClientBuilder</span> <span class="n">humanInvokerBuilder</span> <span class="o">=</span> <span class="nc">ResolverImplClient</span><span class="o">.</span><span class="na">ResolverImplClientBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span>
                <span class="n">setProjection</span><span class="o">(</span><span class="k">new</span> <span class="nc">HumanResponseProjection</span><span class="o">());</span>
        <span class="c1">//Set your own request and resolver for each request</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"======human========"</span><span class="o">);</span>
            <span class="c1">//默认返回所有projection的字段，如果需要自己选择怎么办？使用：new HumanQueryRequest().id().name()，就可以只返回id和name字段的数据了。</span>
            <span class="c1">//此时最大嵌套递归深度不生效</span>
            <span class="nc">HumanDO</span> <span class="n">humanDO</span> <span class="o">=</span> <span class="n">humanInvokerBuilder</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="k">new</span> <span class="nc">HumanQueryRequest</span><span class="o">()).</span><span class="na">build</span><span class="o">(</span><span class="nc">HumanQueryResolver</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">human</span><span class="o">(</span><span class="s">"1001"</span><span class="o">);</span>
            <span class="k">assert</span> <span class="n">humanDO</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()</span> <span class="o">==</span> <span class="s">"dreamylost@outlook.com"</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">humanDO</span><span class="o">);</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"======humans========"</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">HumanDO</span><span class="o">&gt;</span> <span class="n">humanDOs</span> <span class="o">=</span> <span class="n">humanInvokerBuilder</span><span class="o">.</span><span class="na">setRequest</span><span class="o">(</span><span class="k">new</span> <span class="nc">HumansQueryRequest</span><span class="o">()).</span><span class="na">build</span><span class="o">(</span><span class="nc">HumansQueryResolver</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">humans</span><span class="o">();</span>
            <span class="k">assert</span> <span class="n">humanDOs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">4</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">humanDOs</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//......</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>使用Scala</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">io.github.dreamylost.api.</span><span class="o">{</span> <span class="nc">HumanQueryResolver</span><span class="o">,</span> <span class="nc">HumansQueryResolver</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">io.github.dreamylost.model.</span><span class="o">{</span> <span class="nc">HumanQueryRequest</span><span class="o">,</span> <span class="nc">HumanResponseProjection</span><span class="o">,</span> <span class="nc">HumansQueryRequest</span> <span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.collection.JavaConverters._</span>

<span class="cm">/**
 * use invoke by proxy in scala
 *
 * @author liguobin@growingio.com
 * @version 1.0,2020/7/28
 */</span>
<span class="k">object</span> <span class="nc">HumanResolverScalaApp</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>

  <span class="c1">//For a model, the projection and maximum depth fields can be common</span>
  <span class="k">val</span> <span class="nv">humanInvokerBuilder</span> <span class="k">=</span> <span class="nv">ResolverImplClient</span><span class="o">.</span><span class="py">ResolverImplClientBuilder</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span>
    <span class="nf">setProjection</span><span class="o">(</span><span class="k">new</span> <span class="nc">HumanResponseProjection</span><span class="o">())</span>

  <span class="c1">//Set your own request and resolver for each request</span>
  <span class="nf">println</span><span class="o">(</span><span class="s">"======human========"</span><span class="o">)</span>
  <span class="c1">//默认返回所有projection的字段，如果需要自己选择怎么办？使用：new HumanQueryRequest().id().name()，就可以只返回id和name字段的数据了。</span>
  <span class="c1">//此时最大嵌套递归深度不生效</span>
  <span class="k">val</span> <span class="nv">human</span> <span class="k">=</span> <span class="nv">humanInvokerBuilder</span><span class="o">.</span><span class="py">setRequest</span><span class="o">(</span><span class="k">new</span> <span class="nc">HumanQueryRequest</span><span class="o">).</span><span class="py">build</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">HumanQueryResolver</span><span class="o">]).</span><span class="py">human</span><span class="o">(</span><span class="s">"1001"</span><span class="o">)</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">human</span><span class="o">)</span>

  <span class="nf">println</span><span class="o">(</span><span class="s">"======humans========"</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">humans</span> <span class="k">=</span> <span class="nv">humanInvokerBuilder</span><span class="o">.</span><span class="py">setRequest</span><span class="o">(</span><span class="k">new</span> <span class="nc">HumansQueryRequest</span><span class="o">).</span><span class="py">build</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">HumansQueryResolver</span><span class="o">]).</span><span class="py">humans</span><span class="o">().</span><span class="py">asScala</span>
  <span class="nf">for</span> <span class="o">(</span><span class="n">human</span> <span class="k">&lt;-</span> <span class="n">humans</span><span class="o">)</span> <span class="o">{</span>
    <span class="nf">println</span><span class="o">(</span><span class="s">"-&gt;"</span> <span class="o">+</span> <span class="n">human</span><span class="o">)</span>
  <span class="o">}</span>
    <span class="c1">//......</span>
<span class="o">}</span>
</code></pre></div></div><p>可以看到，我们实际上只需要一个链式调用即可，无需编写 resolver 的实现类。也就是，我们只需要使用代码生成工具，生成代码，就可以使用代码调用服务端了。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://dreamylost.cn" target="_blank">梦境迷离</a></li><li>本文链接：<a href="https://dreamylost.cn/graphqljava/GraphqlJava-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%B0%84%E5%9C%A8Graphql%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8.html" target="_blank">https://dreamylost.cn/graphqljava/GraphqlJava-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%B0%84%E5%9C%A8Graphql%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8.html</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/graphqljava/GraphqlJava-%E5%8A%A8%E6%80%81%E4%BB%', clientID: '061aadb5d449c0877d7d', clientSecret: '9aa7af7c248a7e36a07a86993e11a7acf7fbd353', repo: 'dreamylost-comments', owner: 'jxnu-liguobin', admin: ['jxnu-liguobin'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@built/assets/search_data.json?v=1617167038', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2019 <span title="梦境迷离">梦境迷离</span> <a href="http://www.beian.miit.gov.cn/publish/query/indexFirst.action" rel="nofollow" target="_blank">赣ICP备17017283号-1</a> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/jxnu-liguobin/jxnu-liguobin.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://dreamylost.cn/" title="首页" target="">首页</a></li><li> <a href="https://dreamylost.cn/categories/" title="分类" target="">分类</a></li><li> <a href="https://dreamylost.cn/wiki/" title="维基" target="">维基</a></li><li> <a href="https://dreamylost.cn/links/" title="链接" target="">链接</a></li><li> <a href="https://dreamylost.cn/about/" title="关于" target="">关于</a></li><li><a href="https://dreamylost.cn/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2019-09-20 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
