<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>ConcurrentHashMap &mdash; 梦境迷离</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://blog.dreamylost.cn/java%E6%BA%90%E7%A0%81/Java%E6%BA%90%E7%A0%81-ConcurrentHashMap.html"><link rel="alternate" type="application/atom+xml" title="梦境迷离" href="https://blog.dreamylost.cn/feed.xml"><link rel="shortcut icon" href="https://dreamylost.cn/favicon.ico"><meta property="og:title" content="ConcurrentHashMap"><meta name="keywords" content="梦境迷离, jxnu-liguobin"><meta name="og:keywords" content="梦境迷离, jxnu-liguobin"><meta name="description" content="```javapackage java.util.concurrent;"><meta name="og:description" content="```javapackage java.util.concurrent;"><meta property="og:url" content="https://blog.dreamylost.cn/java%E6%BA%90%E7%A0%81/Java%E6%BA%90%E7%A0%81-ConcurrentHashMap.html"><meta property="og:site_name" content="梦境迷离"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2018-08-12"> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-8236444920328818" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://blog.dreamylost.cn/" title="梦境迷离"><span class="octicon octicon-mark-github"></span> 梦境迷离</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://blog.dreamylost.cn/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://blog.dreamylost.cn/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://blog.dreamylost.cn/archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://blog.dreamylost.cn/open-source/" class=" site-header-nav-item" target="" title="开源">开源</a> <a href="https://blog.dreamylost.cn/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://blog.dreamylost.cn/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://blog.dreamylost.cn/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="ConcurrentHashM"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">ConcurrentHashMap</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2018/08/12 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://blog.dreamylost.cn/categories/#Java源码" title="Java源码">Java源码</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 144573 字，约 414 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/images/qrcode.jpg" alt="梦境迷离" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-8236444920328818" data-ad-slot="3977594606"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">java.util.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ObjectStreamField</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.ParameterizedType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Type</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicReference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">AbstractMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
        <span class="kd">implements</span> <span class="nc">ConcurrentMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7249069246763182397L</span><span class="o">;</span>


    <span class="cm">/* ---------------- Constants -------------- */</span>

    <span class="cm">/**
     * node数组最大容量
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="o">;</span>


    <span class="cm">/**
     * 默认初始值，必须是2的幂数
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_CAPACITY</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>

    <span class="cm">/**
     * 数组可能最大值，需要与toArray（）相关方法关联
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_ARRAY_SIZE</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="mi">8</span><span class="o">;</span>

    <span class="cm">/**
     * 并发级别，遗留下来的，为兼容以前的版本
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_CONCURRENCY_LEVEL</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>

    <span class="cm">/**
     * 负载因子
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="no">LOAD_FACTOR</span> <span class="o">=</span> <span class="mf">0.75f</span><span class="o">;</span>

    <span class="cm">/**
     * 链表转树的阀值，如果table[i]下面的链表长度大于8时就转化为树
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">TREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>

    <span class="cm">/**
     * 树转链表的阀值，小于等于6是转为链表，仅在扩容tranfer时才可能树转链表
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">UNTREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="mi">6</span><span class="o">;</span>

    <span class="cm">/**
     * 在转变成树之前，还会有一次判断，只有键值对数量大于 64 才会发生转换。
     * 这是为了避免在哈希表建立初期，多个键值对恰好被放入了同一个链表中而导致不必要的转化。
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MIN_TREEIFY_CAPACITY</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>

    <span class="cm">/**
     * Minimum number of rebinnings per transfer step. Ranges are
     * subdivided to allow multiple resizer threads.  This value
     * serves as a lower bound to avoid resizers encountering
     * excessive memory contention.  The value should be at least
     * DEFAULT_CAPACITY.
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MIN_TRANSFER_STRIDE</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>

    <span class="cm">/**
     * The number of bits used for generation stamp in sizeCtl.
     * Must be at least 6 for 32bit arrays.
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">RESIZE_STAMP_BITS</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>

    <span class="cm">/**
     * 2^15-1，help resize的最大线程数
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_RESIZERS</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="mi">32</span> <span class="o">-</span> <span class="no">RESIZE_STAMP_BITS</span><span class="o">))</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>

    <span class="cm">/**
     * 32-16=16，sizeCtl中记录size大小的偏移量
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">RESIZE_STAMP_SHIFT</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="no">RESIZE_STAMP_BITS</span><span class="o">;</span>

    <span class="cm">/*
     * Encodings for Node hash fields. See above for explanation.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MOVED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// hash for forwarding nodes （forwarding nodes的hash值）、标示位</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">TREEBIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">;</span> <span class="c1">// hash值是-2  表示这是一个TreeBin节点</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">RESERVED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">;</span> <span class="c1">// hash for transient reservations</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">HASH_BITS</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="o">;</span> <span class="c1">// usable bits of normal node hash （ReservationNode的hash值）</span>

    <span class="cm">/**
     * 可用处理器数量
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NCPU</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>

    <span class="cm">/**
     * For serialization compatibility.
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ObjectStreamField</span><span class="o">[]</span> <span class="n">serialPersistentFields</span> <span class="o">=</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">ObjectStreamField</span><span class="o">(</span><span class="s">"segments"</span><span class="o">,</span> <span class="nc">Segment</span><span class="o">[].</span><span class="na">class</span><span class="o">),</span>
            <span class="k">new</span> <span class="nf">ObjectStreamField</span><span class="o">(</span><span class="s">"segmentMask"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">),</span>
            <span class="k">new</span> <span class="nf">ObjectStreamField</span><span class="o">(</span><span class="s">"segmentShift"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
    <span class="o">};</span>

    <span class="cm">/* ---------------- Nodes -------------- */</span>

    <span class="cm">/**
     * Node是最核心的内部类，它包装了key-value键值对，所有插入ConcurrentHashMap的数据都包装在这里面。
     * 它与HashMap中的定义很相似，但是但是有一些差别，它对value和next属性设置了volatile同步锁，
     * 它不允许调用setValue方法直接改变Node的value域，它增加了find方法辅助map.get()方法。
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span>
        <span class="kd">final</span> <span class="no">K</span> <span class="n">key</span><span class="o">;</span>
        <span class="c1">//val和next都会在扩容时发生变化，所以加上volatile来保持可见性和禁止重排序</span>
        <span class="kd">volatile</span> <span class="no">V</span> <span class="n">val</span><span class="o">;</span>
        <span class="kd">volatile</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>

        <span class="nc">Node</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">val</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * HashMap中Node类的hashCode()方法中的代码为：Objects.hashCode(key) ^ Objects.hashCode(value)
         * 而Objects.hashCode(key)最终也是调用了 key.hashCode()，但是效果一样
         */</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">^</span> <span class="n">val</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">val</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">//不允许直接改变value的值</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">setValue</span><span class="o">(</span><span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/**
         * HashMap使用if (o == this)，且嵌套if；ConcurrentHashMap使用&amp;&amp;
         */</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">u</span><span class="o">;</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;)</span> <span class="n">o</span><span class="o">).</span><span class="na">getKey</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="o">(</span><span class="n">u</span> <span class="o">=</span> <span class="n">val</span><span class="o">)</span> <span class="o">||</span> <span class="n">v</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">u</span><span class="o">)));</span>
        <span class="o">}</span>

        <span class="cm">/**
         * 增加find方法辅助get方法 ，HashMap中的Node类中没有此方法
         */</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                            <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                        <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Static utilities -------------- */</span>

    <span class="cm">/**
     * 对hashCode进行再散列，算法为(h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">spread</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">h</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">))</span> <span class="o">&amp;</span> <span class="no">HASH_BITS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回大于等于count的最小的2的幂次方
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">tableSizeFor</span><span class="o">(</span><span class="kt">int</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="o">;</span>
        <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">;</span>
        <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
        <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns x's Class if it is of the form "class C implements
     * Comparable&lt;C&gt;", else null.
     */</span>
    <span class="kd">static</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="nc">Object</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="k">instanceof</span> <span class="nc">Comparable</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
            <span class="nc">Type</span><span class="o">[]</span> <span class="n">ts</span><span class="o">,</span> <span class="n">as</span><span class="o">;</span>
            <span class="nc">Type</span> <span class="n">t</span><span class="o">;</span>
            <span class="nc">ParameterizedType</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">==</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// bypass checks</span>
                <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">ts</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getGenericInterfaces</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ts</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(((</span><span class="n">t</span> <span class="o">=</span> <span class="n">ts</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ParameterizedType</span><span class="o">)</span> <span class="n">t</span><span class="o">).</span><span class="na">getRawType</span><span class="o">()</span> <span class="o">==</span>
                                    <span class="nc">Comparable</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">as</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">getActualTypeArguments</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                            <span class="n">as</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">as</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">c</span><span class="o">)</span> <span class="c1">// type arg is c</span>
                        <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns k.compareTo(x) if x matches kc (k's screened comparable
     * class), else 0.
     */</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"rawtypes"</span><span class="o">,</span> <span class="s">"unchecked"</span><span class="o">})</span> <span class="c1">// for cast to Comparable</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="nf">compareComparables</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">kc</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                <span class="o">((</span><span class="nc">Comparable</span><span class="o">)</span> <span class="n">k</span><span class="o">).</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Table element access -------------- */</span>

    <span class="cm">/*
     * Volatile access methods are used for table elements as well as
     * elements of in-progress next table while resizing.  All uses of
     * the tab arguments must be null checked by callers.  All callers
     * also paranoically precheck that tab's length is not zero (or an
     * equivalent check), thus ensuring that any index argument taking
     * the form of a hash value anded with (length - 1) is a valid
     * index.  Note that, to be correct wrt arbitrary concurrency
     * errors by users, these checks must operate on local variables,
     * which accounts for some odd-looking inline assignments below.
     * Note that calls to setTabAt always occur within locked regions,
     * and so in principle require only release ordering, not
     * full volatile semantics, but are currently coded as volatile
     * writes to be conservative.
     */</span>

    <span class="cm">/**
     * 获得在i位置上的Node节点
     */</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">tabAt</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="no">U</span><span class="o">.</span><span class="na">getObjectVolatile</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="no">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="no">ABASE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 利用CAS算法设置i位置上的Node节点（将c和table[i]比较，相同则插入v）。
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">casTabAt</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span>
                                         <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="no">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="no">ABASE</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 利用volatile方法设置第i个节点的值，这个操作一定是成功的。
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">setTabAt</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">U</span><span class="o">.</span><span class="na">putObjectVolatile</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="no">ASHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="no">ABASE</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Fields -------------- */</span>

    <span class="cm">/**
     * 存放node的数组,大小是2的幂次方
     */</span>
    <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span>

    <span class="cm">/**
     * 扩容时用于存放数据的变量，扩容完成后会置为null。
     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nextTable</span><span class="o">;</span>

    <span class="cm">/**
     * 记录容器的容量大小，通过CAS更新
     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">baseCount</span><span class="o">;</span>

    <span class="cm">/**
     * 负数代表正在进行初始化或扩容操作 ,其中-1代表正在初始化 ,-N 表示有N-1个线程正在进行扩容操作
     * 正数或0代表hash表还没有被初始化，这个数值表示初始化或下一次进行扩容的大小，类似于扩容阈值。
     * 它的值始终是当前ConcurrentHashMap容量的0.75倍，这与loadfactor是对应的。实际容量&gt;=sizeCtl，则扩容。
     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">sizeCtl</span><span class="o">;</span><span class="c1">//控制标识符</span>

    <span class="cm">/**
     * The next table index (plus one) to split while resizing.
     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">transferIndex</span><span class="o">;</span>

    <span class="cm">/**
     * 自旋锁 （锁定通过 CAS） 在调整大小和/或创建 CounterCells 时使用。
     * 在CounterCell类更新value中会使用，功能类似显示锁和内置锁，性能更好
     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">cellsBusy</span><span class="o">;</span>

    <span class="cm">/**
     * counter cell表，长度总为2的幂次
     */</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">counterCells</span><span class="o">;</span>

    <span class="c1">// views</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">keySet</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="nc">ValuesView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="nc">EntrySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">entrySet</span><span class="o">;</span>


    <span class="cm">/* ---------------- Public operations -------------- */</span>

    <span class="cm">/**
     * 默认的构造函数
     */</span>
    <span class="kd">public</span> <span class="nf">ConcurrentHashMap</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 指定容量的构造函数
     *
     * @param initialCapacity 初始化容量
     * @throws IllegalArgumentException if the initial capacity of
     *                                  elements is negative
     */</span>
    <span class="kd">public</span> <span class="nf">ConcurrentHashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="o">((</span><span class="n">initialCapacity</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="no">MAXIMUM_CAPACITY</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">))</span> <span class="o">?</span>
                <span class="no">MAXIMUM_CAPACITY</span> <span class="o">:</span>
                <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">initialCapacity</span> <span class="o">+</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sizeCtl</span> <span class="o">=</span> <span class="n">cap</span><span class="o">;</span><span class="c1">//初始化sizeCtl</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 创建与给定map具有相同映射的新map
     *
     * @param m the map
     */</span>
    <span class="kd">public</span> <span class="nf">ConcurrentHashMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sizeCtl</span> <span class="o">=</span> <span class="no">DEFAULT_CAPACITY</span><span class="o">;</span>
        <span class="n">putAll</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates a new, empty map with an initial table size based on
     * the given number of elements ({@code initialCapacity}) and
     * initial table density ({@code loadFactor}).
     *
     * @param initialCapacity 初始容量
     * @param loadFactor      负载因子,当容量达到initialCapacity*loadFactor时，执行扩容
     * @throws IllegalArgumentException if the initial capacity of
     *                                  elements is negative or the load factor is nonpositive
     * @since 1.6
     */</span>
    <span class="kd">public</span> <span class="nf">ConcurrentHashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="n">loadFactor</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates a new, empty map with an initial table size based on
     * the given number of elements ({@code initialCapacity}), table
     * density ({@code loadFactor}), and number of concurrently
     * updating threads ({@code concurrencyLevel}).
     *
     * @param initialCapacity  初始容量
     * @param loadFactor       负载因子,当容量达到initialCapacity*loadFactor时，执行扩容
     * @param concurrencyLevel 预估的并发更新线程数
     * @throws IllegalArgumentException if the initial capacity is
     *                                  negative or the load factor or concurrencyLevel are
     *                                  nonpositive
     */</span>
    <span class="kd">public</span> <span class="nf">ConcurrentHashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span>
                             <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">concurrencyLevel</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">loadFactor</span> <span class="o">&gt;</span> <span class="mf">0.0f</span><span class="o">)</span> <span class="o">||</span> <span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">concurrencyLevel</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="n">concurrencyLevel</span><span class="o">)</span>   <span class="c1">// Use at least as many bins</span>
            <span class="n">initialCapacity</span> <span class="o">=</span> <span class="n">concurrencyLevel</span><span class="o">;</span>   <span class="c1">// as estimated threads</span>
        <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">initialCapacity</span> <span class="o">/</span> <span class="n">loadFactor</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span>
                <span class="no">MAXIMUM_CAPACITY</span> <span class="o">:</span> <span class="n">tableSizeFor</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">size</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sizeCtl</span> <span class="o">=</span> <span class="n">cap</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Original (since JDK1.2) Map methods</span>

    <span class="cm">/**
     * {@inheritDoc}
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">:</span>
                        <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">n</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * {@inheritDoc}
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">sumCount</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="o">;</span> <span class="c1">// ignore transient negative values</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 根据key在Map中找出其对应的value，如果不存在key，则返回null，
     * 其中key不允许为null，否则抛异常
     * 对于节点可能在链表或树上的情况，需要分别去查找
     *
     * @throws NullPointerException if the specified key is null
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">eh</span><span class="o">;</span>
        <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span><span class="c1">//两次hash计算出hash值</span>
        <span class="c1">//根据hash值确定节点位置</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 搜索到的节点key与传入的key相同且不为null,直接返回这个节点</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">eh</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">eh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span><span class="c1">//如果eh&lt;0 说明这个节点在树上 直接寻找</span>
                <span class="k">return</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
            <span class="c1">//否则遍历链表 找到对应的值并返回</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 检查table中是否含有key
     *
     * @param key possible key
     * @return {@code true} if and only if the specified object
     * is a key in this table, as determined by the
     * {@code equals} method; {@code false} otherwise
     * @throws NullPointerException if the specified key is null
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsKey</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//直接调用get(int key)方法即可，如果有返回值，则说明是包含key的</span>
        <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 检查在所有映射(k,v)中只要出现一次及以上的v==value，返回true
     * 这个方法可能需要完全遍历Map，因此比containsKey要慢的多
     *
     * @param value value whose presence in this map is to be tested
     * @return {@code true} if this map maps one or more keys to the
     * specified value
     * @throws NullPointerException if the specified value is null
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsValue</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">)</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 直接调用putVal(key, value, false)方法
     *
     * @param key   key with which the specified value is to be associated
     * @param value value to be associated with the specified key
     * @return the previous value associated with {@code key}, or
     * {@code null} if there was no mapping for {@code key}
     * @throws NullPointerException if the specified key or value is null
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">put</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">putVal</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * putVal方法可以分为以下几步：
     * 1、检查key/value是否为空，如果为空，则抛异常，否则进行2
     * 2、进入for死循环，进行3
     * 3、检查table是否初始化了，如果没有，则调用initTable()进行初始化然后进行 2，否则进行4
     * 4、根据key的hash值计算出其应该在table中储存的位置i，取出table[i]的节点用f表示。
     * 根据f的不同有如下三种情况：
     * 1）如果table[i]==null(即该位置的节点为空，没有发生碰撞)，则利用CAS操作直接存储在该位置，如果CAS操作成功则退出死循环。
     * 2）如果table[i]!=null(即该位置已经有其它节点，发生碰撞)，碰撞处理也有两种情况
     * 2.1）检查table[i]的节点的hash是否等于MOVED，如果等于，则检测到正在扩容，则帮助其扩容
     * 2.2）说明table[i]的节点的hash值不等于MOVED，如果table[i]为链表节点，则将此节点插入链表中即可
     * 如果table[i]为树节点，则将此节点插入树中即可。插入成功后，进行 5
     * 5、如果table[i]的节点是链表节点，则检查table的第i个位置的链表是否需要转化为树，如果需要则调用treeifyBin函数进行转化
     */</span>
    <span class="kd">final</span> <span class="no">V</span> <span class="nf">putVal</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span><span class="c1">// key和value不允许null</span>
        <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span><span class="c1">//两次hash，减少hash冲突，可以均匀分布</span>
        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//i处结点标志，0: 未加入新结点, 2: TreeBin或链表结点数, 其它：链表结点数。主要用于每次加入结点后查看是否要由链表转为红黑树</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span><span class="c1">//CAS经典写法，不成功无限重试</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="c1">//检查是否初始化了，如果没有，则初始化</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">();</span>
            <span class="cm">/**
             * i=(n-1)&amp;hash 等价于i=hash%n(前提是n为2的幂次方).即取出table中位置的节点用f表示。 有如下两种情况：
             * 1、如果table[i]==null(即该位置的节点为空，没有发生碰撞)，则利用CAS操作直接存储在该位置， 如果CAS操作成功则退出死循环。
             * 2、如果table[i]!=null(即该位置已经有其它节点，发生碰撞)
             */</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
                        <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">)))</span>
                    <span class="k">break</span><span class="o">;</span>                   <span class="c1">// no lock when adding to empty bin</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span><span class="c1">//检查table[i]的节点的hash是否等于MOVED，如果等于，则检测到正在扩容，则帮助其扩容</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span><span class="c1">//table[i]的节点的hash值不等于MOVED。</span>
                <span class="no">V</span> <span class="n">oldVal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="c1">// 针对首个节点进行加锁操作，而不是segment，进一步减少线程冲突</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="c1">// 如果在链表中找到值为key的节点e，直接设置e.val = value即可</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                                <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="n">oldVal</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                    <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span><span class="o">)</span>
                                        <span class="n">e</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="c1">// 如果没有找到值为key的节点，直接新建Node并加入链表即可</span>
                                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//插入到链表末尾并跳出循环</span>
                                    <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span>
                                            <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span><span class="c1">// 如果首节点为TreeBin类型，说明为红黑树结构，执行putTreeVal操作</span>
                            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">).</span><span class="na">putTreeVal</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span>
                                    <span class="n">value</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">oldVal</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span><span class="o">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 如果节点数&gt;＝8，那么转换链表结构为红黑树结构</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span><span class="o">)</span>
                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span><span class="c1">//若length&lt;64,直接tryPresize,两倍table.length;不转红黑树</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">oldVal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span> <span class="n">oldVal</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 计数增加1，有可能触发transfer操作(扩容)</span>
        <span class="n">addCount</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">binCount</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Copies all of the mappings from the specified map to this one.
     * These mappings replace any mappings that this map had for any of the
     * keys currently in the specified map.
     *
     * @param m mappings to be stored in this map
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">putAll</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">tryPresize</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">m</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span>
            <span class="n">putVal</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Removes the key (and its corresponding value) from this map.
     * This method does nothing if the key is not in the map.
     *
     * @param key the key that needs to be removed
     * @return the previous value associated with {@code key}, or
     * {@code null} if there was no mapping for {@code key}
     * @throws NullPointerException if the specified key is null
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">replaceNode</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Implementation for the four public remove/replace methods:
     * Replaces node value with v, conditional upon match of cv if
     * non-null.  If resulting value is null, delete.
     */</span>
    <span class="kd">final</span> <span class="no">V</span> <span class="nf">replaceNode</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">cv</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
                    <span class="o">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="no">V</span> <span class="n">oldVal</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="kt">boolean</span> <span class="n">validated</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">validated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                                <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                                <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="no">V</span> <span class="n">ev</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">cv</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">cv</span> <span class="o">==</span> <span class="n">ev</span> <span class="o">||</span>
                                            <span class="o">(</span><span class="n">ev</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cv</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ev</span><span class="o">)))</span> <span class="o">{</span>
                                        <span class="n">oldVal</span> <span class="o">=</span> <span class="n">ev</span><span class="o">;</span>
                                        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                            <span class="n">e</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                                        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                                        <span class="k">else</span>
                                            <span class="nf">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="k">break</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">validated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">root</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                    <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="no">V</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">cv</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">cv</span> <span class="o">==</span> <span class="n">pv</span> <span class="o">||</span>
                                        <span class="o">(</span><span class="n">pv</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cv</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pv</span><span class="o">)))</span> <span class="o">{</span>
                                    <span class="n">oldVal</span> <span class="o">=</span> <span class="n">pv</span><span class="o">;</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                                        <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">));</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">validated</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">oldVal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">addCount</span><span class="o">(-</span><span class="mi">1L</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">oldVal</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Removes all of the mappings from this map.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span> <span class="c1">// negative number of deletions</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">tab</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">fh</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">++</span><span class="n">i</span><span class="o">;</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// restart</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">f</span> <span class="o">:</span>
                                <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">?</span>
                                        <span class="o">((</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">).</span><span class="na">first</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
                        <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="o">--</span><span class="n">delta</span><span class="o">;</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">++,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">0L</span><span class="o">)</span>
            <span class="n">addCount</span><span class="o">(</span><span class="n">delta</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a {@link Set} view of the keys contained in this map.
     * The set is backed by the map, so changes to the map are
     * reflected in the set, and vice-versa. The set supports element
     * removal, which removes the corresponding mapping from this map,
     * via the {@code Iterator.remove}, {@code Set.remove},
     * {@code removeAll}, {@code retainAll}, and {@code clear}
     * operations.  It does not support the {@code add} or
     * {@code addAll} operations.
     * &lt;p&gt;
     * &lt;p&gt;The view's iterators and spliterators are
     * &lt;a href="package-summary.html#Weakly"&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.
     * &lt;p&gt;
     * &lt;p&gt;The view's {@code spliterator} reports {@link Spliterator#CONCURRENT},
     * {@link Spliterator#DISTINCT}, and {@link Spliterator#NONNULL}.
     *
     * @return the set view
     */</span>
    <span class="kd">public</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">keySet</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">ks</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">ks</span> <span class="o">=</span> <span class="n">keySet</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">ks</span> <span class="o">:</span> <span class="o">(</span><span class="n">keySet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a {@link Collection} view of the values contained in this map.
     * The collection is backed by the map, so changes to the map are
     * reflected in the collection, and vice-versa.  The collection
     * supports element removal, which removes the corresponding
     * mapping from this map, via the {@code Iterator.remove},
     * {@code Collection.remove}, {@code removeAll},
     * {@code retainAll}, and {@code clear} operations.  It does not
     * support the {@code add} or {@code addAll} operations.
     * &lt;p&gt;
     * &lt;p&gt;The view's iterators and spliterators are
     * &lt;a href="package-summary.html#Weakly"&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.
     * &lt;p&gt;
     * &lt;p&gt;The view's {@code spliterator} reports {@link Spliterator#CONCURRENT}
     * and {@link Spliterator#NONNULL}.
     *
     * @return the collection view
     */</span>
    <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">values</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ValuesView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">vs</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">vs</span> <span class="o">=</span> <span class="n">values</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">vs</span> <span class="o">:</span> <span class="o">(</span><span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValuesView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a {@link Set} view of the mappings contained in this map.
     * The set is backed by the map, so changes to the map are
     * reflected in the set, and vice-versa.  The set supports element
     * removal, which removes the corresponding mapping from the map,
     * via the {@code Iterator.remove}, {@code Set.remove},
     * {@code removeAll}, {@code retainAll}, and {@code clear}
     * operations.
     * &lt;p&gt;
     * &lt;p&gt;The view's iterators and spliterators are
     * &lt;a href="package-summary.html#Weakly"&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.
     * &lt;p&gt;
     * &lt;p&gt;The view's {@code spliterator} reports {@link Spliterator#CONCURRENT},
     * {@link Spliterator#DISTINCT}, and {@link Spliterator#NONNULL}.
     *
     * @return the set view
     */</span>
    <span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">entrySet</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">EntrySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">es</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">es</span> <span class="o">=</span> <span class="n">entrySet</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">es</span> <span class="o">:</span> <span class="o">(</span><span class="n">entrySet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EntrySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the hash code value for this {@link Map}, i.e.,
     * the sum of, for each key-value pair in the map,
     * {@code key.hashCode() ^ value.hashCode()}.
     *
     * @return the hash code value for this map
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                <span class="n">h</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">^</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a string representation of this map.  The string
     * representation consists of a list of key-value mappings (in no
     * particular order) enclosed in braces ("{@code {}}").  Adjacent
     * mappings are separated by the characters {@code ", "} (comma
     * and space).  Each key-value mapping is rendered as the key
     * followed by an equals sign ("{@code =}") followed by the
     * associated value.
     *
     * @return a string representation of this map
     */</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
        <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'{'</span><span class="o">);</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="no">K</span> <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                <span class="no">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="k">this</span> <span class="o">?</span> <span class="s">"(this Map)"</span> <span class="o">:</span> <span class="n">k</span><span class="o">);</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'='</span><span class="o">);</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="k">this</span> <span class="o">?</span> <span class="s">"(this Map)"</span> <span class="o">:</span> <span class="n">v</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">','</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'}'</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Compares the specified object with this map for equality.
     * Returns {@code true} if the given object is a map with the same
     * mappings as this map.  This operation may return misleading
     * results if either map is concurrently modified during execution
     * of this method.
     *
     * @param o object to be compared for equality with this map
     * @return {@code true} if the specified object is equal to this map
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="nc">Map</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?,</span> <span class="o">?&gt;)</span> <span class="n">o</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="no">V</span> <span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                <span class="nc">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">v</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">val</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">m</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">mk</span><span class="o">,</span> <span class="n">mv</span><span class="o">,</span> <span class="n">v</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">mk</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">mv</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">mk</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">mv</span> <span class="o">!=</span> <span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mv</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Stripped-down version of helper class used in previous version,
     * declared for the sake of serialization compatibility
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Segment</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">ReentrantLock</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">2249069246763182397L</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">;</span>

        <span class="nc">Segment</span><span class="o">(</span><span class="kt">float</span> <span class="n">lf</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="n">lf</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Saves the state of the {@code ConcurrentHashMap} instance to a
     * stream (i.e., serializes it).
     *
     * @param s the stream
     * @throws java.io.IOException if an I/O error occurs
     * @serialData the key (Object) and value (Object)
     * for each key-value mapping, followed by a null pair.
     * The key-value mappings are emitted in no particular order.
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectOutputStream</span> <span class="n">s</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="c1">// For serialization compatibility</span>
        <span class="c1">// Emulate segment calculation from previous version of this class</span>
        <span class="kt">int</span> <span class="n">sshift</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">ssize</span> <span class="o">&lt;</span> <span class="no">DEFAULT_CONCURRENCY_LEVEL</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">++</span><span class="n">sshift</span><span class="o">;</span>
            <span class="n">ssize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">segmentShift</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">sshift</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">segmentMask</span> <span class="o">=</span> <span class="n">ssize</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
        <span class="nc">Segment</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">segments</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Segment</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[])</span>
                <span class="k">new</span> <span class="nc">Segment</span><span class="o">&lt;?,</span> <span class="o">?&gt;[</span><span class="no">DEFAULT_CONCURRENCY_LEVEL</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segments</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
            <span class="n">segments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Segment</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="no">LOAD_FACTOR</span><span class="o">);</span>
        <span class="n">s</span><span class="o">.</span><span class="na">putFields</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"segments"</span><span class="o">,</span> <span class="n">segments</span><span class="o">);</span>
        <span class="n">s</span><span class="o">.</span><span class="na">putFields</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"segmentShift"</span><span class="o">,</span> <span class="n">segmentShift</span><span class="o">);</span>
        <span class="n">s</span><span class="o">.</span><span class="na">putFields</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"segmentMask"</span><span class="o">,</span> <span class="n">segmentMask</span><span class="o">);</span>
        <span class="n">s</span><span class="o">.</span><span class="na">writeFields</span><span class="o">();</span>

        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
                <span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// throw away</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Reconstitutes the instance from a stream (that is, deserializes it).
     *
     * @param s the stream
     * @throws ClassNotFoundException if the class of a serialized object
     *                                could not be found
     * @throws java.io.IOException    if an I/O error occurs
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="cm">/*
         * To improve performance in typical cases, we create nodes
         * while reading, then place in table once size is known.
         * However, we must also validate uniqueness and deal with
         * overpopulated bins while doing so, which requires
         * specialized versions of putVal mechanics.
         */</span>
        <span class="n">sizeCtl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// force exclusion for table construction</span>
        <span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="no">K</span> <span class="n">k</span> <span class="o">=</span> <span class="o">(</span><span class="no">K</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="no">V</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="no">V</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">spread</span><span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()),</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
                <span class="o">++</span><span class="n">size</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span>
            <span class="n">sizeCtl</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="no">MAXIMUM_CAPACITY</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">))</span>
                <span class="n">n</span> <span class="o">=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">;</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">size</span><span class="o">;</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">sz</span> <span class="o">+</span> <span class="o">(</span><span class="n">sz</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[])</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;?,</span> <span class="o">?&gt;[</span><span class="n">n</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">added</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">insertAtFront</span><span class="o">;</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">,</span> <span class="n">first</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">first</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">j</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">insertAtFront</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="no">K</span> <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">first</span><span class="o">.</span><span class="na">hash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">first</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">putTreeVal</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="o">++</span><span class="n">added</span><span class="o">;</span>
                        <span class="n">insertAtFront</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                        <span class="n">insertAtFront</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">;</span>
                        <span class="no">K</span> <span class="n">qk</span><span class="o">;</span>
                        <span class="k">for</span> <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                                    <span class="o">((</span><span class="n">qk</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span>
                                            <span class="o">(</span><span class="n">qk</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">qk</span><span class="o">))))</span> <span class="o">{</span>
                                <span class="n">insertAtFront</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="o">++</span><span class="n">binCount</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">insertAtFront</span> <span class="o">&amp;&amp;</span> <span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">insertAtFront</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">++</span><span class="n">added</span><span class="o">;</span>
                            <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">hd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                                        <span class="o">(</span><span class="n">q</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">t</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">tl</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">hd</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
                                <span class="k">else</span>
                                    <span class="n">tl</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
                                <span class="n">tl</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">hd</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">insertAtFront</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">++</span><span class="n">added</span><span class="o">;</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
                    <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">tab</span><span class="o">;</span>
            <span class="n">sizeCtl</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="o">);</span>
            <span class="n">baseCount</span> <span class="o">=</span> <span class="n">added</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// ConcurrentMap methods</span>

    <span class="cm">/**
     * {@inheritDoc}
     *
     * @return the previous value associated with the specified key,
     * or {@code null} if there was no mapping for the key
     * @throws NullPointerException if the specified key or value is null
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">putIfAbsent</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">putVal</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * {@inheritDoc}
     *
     * @throws NullPointerException if the specified key is null
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">replaceNode</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * {@inheritDoc}
     *
     * @throws NullPointerException if any of the arguments are null
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">replace</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">oldValue</span><span class="o">,</span> <span class="no">V</span> <span class="n">newValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">newValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">replaceNode</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">newValue</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * {@inheritDoc}
     *
     * @return the previous value associated with the specified key,
     * or {@code null} if there was no mapping for the key
     * @throws NullPointerException if the specified key or value is null
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">replace</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">replaceNode</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Overrides of JDK8+ Map extension method defaults</span>

    <span class="cm">/**
     * Returns the value to which the specified key is mapped, or the
     * given default value if this map contains no mapping for the
     * key.
     *
     * @param key          the key whose associated value is to be returned
     * @param defaultValue the value to return if this map contains
     *                     no mapping for the given key
     * @return the mapping for the key, if present; else the default value
     * @throws NullPointerException if the specified key is null
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">getOrDefault</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">defaultValue</span> <span class="o">:</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">BiConsumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">replaceAll</span><span class="o">(</span><span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">function</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">function</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="no">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="no">K</span> <span class="n">key</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">V</span> <span class="n">newValue</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">newValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">replaceNode</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">newValue</span><span class="o">,</span> <span class="n">oldValue</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
                            <span class="o">(</span><span class="n">oldValue</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * If the specified key is not already associated with a value,
     * attempts to compute its value using the given mapping function
     * and enters it into this map unless {@code null}.  The entire
     * method invocation is performed atomically, so the function is
     * applied at most once per key.  Some attempted update operations
     * on this map by other threads may be blocked while computation
     * is in progress, so the computation should be short and simple,
     * and must not attempt to update any other mappings of this map.
     *
     * @param key             key with which the specified value is to be associated
     * @param mappingFunction the function to compute a value
     * @return the current (existing or computed) value associated with
     * the specified key, or null if the computed value is null
     * @throws NullPointerException  if the specified key or mappingFunction
     *                               is null
     * @throws IllegalStateException if the computation detectably
     *                               attempts a recursive update to this map that would
     *                               otherwise never complete
     * @throws RuntimeException      or Error if the mappingFunction does so,
     *                               in which case the mapping is left unestablished
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">computeIfAbsent</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">mappingFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mappingFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="no">V</span> <span class="n">val</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">();</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReservationNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;();</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">r</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">mappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">added</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="no">V</span> <span class="n">ev</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                                <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="k">if</span> <span class="o">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">mappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                        <span class="n">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                        <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                            <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">root</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                    <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">mappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">t</span><span class="o">.</span><span class="na">putTreeVal</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span><span class="o">)</span>
                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">added</span><span class="o">)</span>
                        <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">addCount</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="n">binCount</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * If the value for the specified key is present, attempts to
     * compute a new mapping given the key and its current mapped
     * value.  The entire method invocation is performed atomically.
     * Some attempted update operations on this map by other threads
     * may be blocked while computation is in progress, so the
     * computation should be short and simple, and must not attempt to
     * update any other mappings of this map.
     *
     * @param key               key with which a value may be associated
     * @param remappingFunction the function to compute a value
     * @return the new value associated with the specified key, or null if none
     * @throws NullPointerException  if the specified key or remappingFunction
     *                               is null
     * @throws IllegalStateException if the computation detectably
     *                               attempts a recursive update to this map that would
     *                               otherwise never complete
     * @throws RuntimeException      or Error if the remappingFunction does so,
     *                               in which case the mapping is unchanged
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">computeIfPresent</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">remappingFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">remappingFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="no">V</span> <span class="n">val</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">();</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                                <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">e</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
                                    <span class="k">else</span> <span class="o">{</span>
                                        <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">en</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                                        <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">en</span><span class="o">;</span>
                                        <span class="k">else</span>
                                            <span class="nf">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">en</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="k">break</span><span class="o">;</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                            <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">root</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                    <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
                                <span class="k">else</span> <span class="o">{</span>
                                    <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                                        <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">));</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">addCount</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="n">delta</span><span class="o">,</span> <span class="n">binCount</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Attempts to compute a mapping for the specified key and its
     * current mapped value (or {@code null} if there is no current
     * mapping). The entire method invocation is performed atomically.
     * Some attempted update operations on this map by other threads
     * may be blocked while computation is in progress, so the
     * computation should be short and simple, and must not attempt to
     * update any other mappings of this Map.
     *
     * @param key               key with which the specified value is to be associated
     * @param remappingFunction the function to compute a value
     * @return the new value associated with the specified key, or null if none
     * @throws NullPointerException  if the specified key or remappingFunction
     *                               is null
     * @throws IllegalStateException if the computation detectably
     *                               attempts a recursive update to this map that would
     *                               otherwise never complete
     * @throws RuntimeException      or Error if the remappingFunction does so,
     *                               in which case the mapping is unchanged
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">compute</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span>
                     <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">remappingFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">remappingFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="no">V</span> <span class="n">val</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">();</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReservationNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;();</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">r</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                                <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                                <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">e</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
                                    <span class="k">else</span> <span class="o">{</span>
                                        <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">en</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                                        <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">en</span><span class="o">;</span>
                                        <span class="k">else</span>
                                            <span class="nf">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">en</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                        <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                                        <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span>
                                                <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">root</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                            <span class="k">else</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="no">V</span> <span class="n">pv</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">pv</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
                                <span class="k">else</span> <span class="o">{</span>
                                    <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                                    <span class="n">t</span><span class="o">.</span><span class="na">putTreeVal</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                                    <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">));</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span><span class="o">)</span>
                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">addCount</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="n">delta</span><span class="o">,</span> <span class="n">binCount</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * If the specified key is not already associated with a
     * (non-null) value, associates it with the given value.
     * Otherwise, replaces the value with the results of the given
     * remapping function, or removes if {@code null}. The entire
     * method invocation is performed atomically.  Some attempted
     * update operations on this map by other threads may be blocked
     * while computation is in progress, so the computation should be
     * short and simple, and must not attempt to update any other
     * mappings of this Map.
     *
     * @param key               key with which the specified value is to be associated
     * @param value             the value to use if absent
     * @param remappingFunction the function to recompute a value if present
     * @return the new value associated with the specified key, or null if none
     * @throws NullPointerException if the specified key or the
     *                              remappingFunction is null
     * @throws RuntimeException     or Error if the remappingFunction does so,
     *                              in which case the mapping is unchanged
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">merge</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">remappingFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">remappingFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">spread</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="no">V</span> <span class="n">val</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">initTable</span><span class="o">();</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">helpTransfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="o">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
                                <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                                                <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span> <span class="o">{</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
                                    <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">e</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
                                    <span class="k">else</span> <span class="o">{</span>
                                        <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">en</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                                        <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">en</span><span class="o">;</span>
                                        <span class="k">else</span>
                                            <span class="nf">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">en</span><span class="o">);</span>
                                    <span class="o">}</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                                <span class="n">pred</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                                    <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
                                    <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span>
                                            <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">binCount</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                            <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">root</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                                    <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">value</span> <span class="o">:</span>
                                    <span class="n">remappingFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">p</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
                                <span class="k">else</span> <span class="o">{</span>
                                    <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                                    <span class="n">t</span><span class="o">.</span><span class="na">putTreeVal</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="n">p</span><span class="o">))</span>
                                    <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">));</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span><span class="o">)</span>
                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">addCount</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="n">delta</span><span class="o">,</span> <span class="n">binCount</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Hashtable legacy methods</span>

    <span class="cm">/**
     * Legacy method testing if some key maps into the specified value
     * in this table.  This method is identical in functionality to
     * {@link #containsValue(Object)}, and exists solely to ensure
     * full compatibility with class {@link java.util.Hashtable},
     * which supported this method prior to introduction of the
     * Java Collections framework.
     *
     * @param value a value to search for
     * @return {@code true} if and only if some key maps to the
     * {@code value} argument in this table as
     * determined by the {@code equals} method;
     * {@code false} otherwise
     * @throws NullPointerException if the specified value is null
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">containsValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns an enumeration of the keys in this table.
     *
     * @return an enumeration of the keys in this table
     * @see #keySet()
     */</span>
    <span class="kd">public</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="nf">keys</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">KeyIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns an enumeration of the values in this table.
     *
     * @return an enumeration of the values in this table
     * @see #values()
     */</span>
    <span class="kd">public</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">elements</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">ValueIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// ConcurrentHashMap-only methods</span>

    <span class="cm">/**
     * Returns the number of mappings. This method should be used
     * instead of {@link #size} because a ConcurrentHashMap may
     * contain more mappings than can be represented as an int. The
     * value returned is an estimate; the actual count may differ if
     * there are concurrent insertions or removals.
     *
     * @return the number of mappings
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">mappingCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0L</span> <span class="o">:</span> <span class="n">n</span><span class="o">;</span> <span class="c1">// ignore transient negative values</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates a new {@link Set} backed by a ConcurrentHashMap
     * from the given type to {@code Boolean.TRUE}.
     *
     * @param &lt;K&gt; the element type of the returned set
     * @return the new set
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="nf">newKeySet</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;(),</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates a new {@link Set} backed by a ConcurrentHashMap
     * from the given type to {@code Boolean.TRUE}.
     *
     * @param initialCapacity The implementation performs internal
     *                        sizing to accommodate this many elements.
     * @param &lt;K&gt;             the element type of the returned set
     * @return the new set
     * @throws IllegalArgumentException if the initial capacity of
     *                                  elements is negative
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="nf">newKeySet</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;(</span><span class="n">initialCapacity</span><span class="o">),</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a {@link Set} view of the keys in this map, using the
     * given common mapped value for any additions (i.e., {@link
     * Collection#add} and {@link Collection#addAll(Collection)}).
     * This is of course only appropriate if it is acceptable to use
     * the same value for all additions from this view.
     *
     * @param mappedValue the mapped value to use for any additions
     * @return the set view
     * @throws NullPointerException if the mappedValue is null
     */</span>
    <span class="kd">public</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">keySet</span><span class="o">(</span><span class="no">V</span> <span class="n">mappedValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mappedValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">mappedValue</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Special Nodes -------------- */</span>

    <span class="cm">/**
     * A node inserted at head of bins during transfer operations.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nextTable</span><span class="o">;</span>

        <span class="nc">ForwardingNode</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="no">MOVED</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextTable</span> <span class="o">=</span> <span class="n">tab</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// loop to avoid arbitrarily deep recursion on forwarding nodes</span>
            <span class="nl">outer:</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">nextTable</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">eh</span><span class="o">;</span>
                    <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">eh</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                            <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                        <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">eh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">ForwardingNode</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">tab</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">).</span><span class="na">nextTable</span><span class="o">;</span>
                            <span class="k">continue</span> <span class="n">outer</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span>
                            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * A place-holder node used in computeIfAbsent and compute
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReservationNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">ReservationNode</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="no">RESERVED</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Table Initialization and Resizing -------------- */</span>

    <span class="cm">/**
     * Returns the stamp bits for resizing a table of size n.
     * Must be negative when shifted left by RESIZE_STAMP_SHIFT.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">resizeStamp</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">numberOfLeadingZeros</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="no">RESIZE_STAMP_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Initializes table, using the size recorded in sizeCtl.
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="nf">initTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span> <span class="c1">// lost initialization race; just spin</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">sc</span> <span class="o">:</span> <span class="no">DEFAULT_CAPACITY</span><span class="o">;</span>
                        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nt</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[])</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;?,</span> <span class="o">?&gt;[</span><span class="n">n</span><span class="o">];</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">nt</span><span class="o">;</span>
                        <span class="n">sc</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">sizeCtl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">tab</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Adds to count, and if table is too small and not already
     * resizing, initiates transfer. If already resizing, helps
     * perform transfer if work is available.  Rechecks occupancy
     * after a transfer to see if another resize is already needed
     * because resizings are lagging additions.
     *
     * @param x     the count to add
     * @param check if &lt;0, don't check resize, if &lt;= 1 only check if uncontended
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">addCount</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">check</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">b</span><span class="o">,</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">counterCells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
                <span class="o">!</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">BASECOUNT</span><span class="o">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">baseCount</span><span class="o">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">CounterCell</span> <span class="n">a</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">v</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">m</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">uncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">as</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
                    <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                    <span class="o">!(</span><span class="n">uncontended</span> <span class="o">=</span>
                            <span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="no">CELLVALUE</span><span class="o">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span><span class="o">)))</span> <span class="o">{</span>
                <span class="n">fullAddCount</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">uncontended</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">check</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">check</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="n">nt</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">sc</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&lt;</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">&gt;&gt;&gt;</span> <span class="no">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span> <span class="o">||</span> <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">||</span>
                            <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="no">MAX_RESIZERS</span> <span class="o">||</span> <span class="o">(</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nextTable</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                            <span class="n">transferIndex</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
                        <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">nt</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span>
                        <span class="o">(</span><span class="n">rs</span> <span class="o">&lt;&lt;</span> <span class="no">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">))</span>
                    <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Helps transfer if a resize is in progress.
     */</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="nf">helpTransfer</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nextTab</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">ForwardingNode</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">(</span><span class="n">nextTab</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">).</span><span class="na">nextTable</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">nextTab</span> <span class="o">==</span> <span class="n">nextTable</span> <span class="o">&amp;&amp;</span> <span class="n">table</span> <span class="o">==</span> <span class="n">tab</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">&gt;&gt;&gt;</span> <span class="no">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span> <span class="o">||</span> <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">||</span>
                        <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="no">MAX_RESIZERS</span> <span class="o">||</span> <span class="n">transferIndex</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">nextTab</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">nextTab</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">table</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Tries to presize table to accommodate the given number of elements.
     *
     * @param size number of elements (doesn't need to be perfectly accurate)
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">tryPresize</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="o">(</span><span class="no">MAXIMUM_CAPACITY</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">))</span> <span class="o">?</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">:</span>
                <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">?</span> <span class="n">sc</span> <span class="o">:</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">table</span> <span class="o">==</span> <span class="n">tab</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nt</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[])</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;?,</span> <span class="o">?&gt;[</span><span class="n">n</span><span class="o">];</span>
                            <span class="n">table</span> <span class="o">=</span> <span class="n">nt</span><span class="o">;</span>
                            <span class="n">sc</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">sizeCtl</span> <span class="o">=</span> <span class="n">sc</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="n">sc</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="n">table</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nt</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">&gt;&gt;&gt;</span> <span class="no">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">rs</span> <span class="o">||</span> <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">||</span>
                            <span class="n">sc</span> <span class="o">==</span> <span class="n">rs</span> <span class="o">+</span> <span class="no">MAX_RESIZERS</span> <span class="o">||</span> <span class="o">(</span><span class="n">nt</span> <span class="o">=</span> <span class="n">nextTable</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                            <span class="n">transferIndex</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span> <span class="n">sc</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
                        <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">nt</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span><span class="o">,</span>
                        <span class="o">(</span><span class="n">rs</span> <span class="o">&lt;&lt;</span> <span class="no">RESIZE_STAMP_SHIFT</span><span class="o">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">))</span>
                    <span class="n">transfer</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Moves and/or copies the nodes in each bin to new table. See
     * above for explanation.
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nextTab</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">stride</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">stride</span> <span class="o">=</span> <span class="o">(</span><span class="no">NCPU</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">3</span><span class="o">)</span> <span class="o">/</span> <span class="no">NCPU</span> <span class="o">:</span> <span class="n">n</span><span class="o">)</span> <span class="o">&lt;</span> <span class="no">MIN_TRANSFER_STRIDE</span><span class="o">)</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="no">MIN_TRANSFER_STRIDE</span><span class="o">;</span> <span class="c1">// subdivide range</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nextTab</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>            <span class="c1">// initiating</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">nt</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[])</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;?,</span> <span class="o">?&gt;[</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">];</span>
                <span class="n">nextTab</span> <span class="o">=</span> <span class="n">nt</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>      <span class="c1">// try to cope with OOME</span>
                <span class="n">sizeCtl</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">nextTable</span> <span class="o">=</span> <span class="n">nextTab</span><span class="o">;</span>
            <span class="n">transferIndex</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">nextn</span> <span class="o">=</span> <span class="n">nextTab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">fwd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">nextTab</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kt">boolean</span> <span class="n">finishing</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// to ensure sweep before committing nextTab</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bound</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">fh</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">advance</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">nextIndex</span><span class="o">,</span> <span class="n">nextBound</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">bound</span> <span class="o">||</span> <span class="n">finishing</span><span class="o">)</span>
                    <span class="n">advance</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">nextIndex</span> <span class="o">=</span> <span class="n">transferIndex</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                    <span class="n">advance</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span>
                        <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">TRANSFERINDEX</span><span class="o">,</span> <span class="n">nextIndex</span><span class="o">,</span>
                                <span class="n">nextBound</span> <span class="o">=</span> <span class="o">(</span><span class="n">nextIndex</span> <span class="o">&gt;</span> <span class="n">stride</span> <span class="o">?</span>
                                        <span class="n">nextIndex</span> <span class="o">-</span> <span class="n">stride</span> <span class="o">:</span> <span class="mi">0</span><span class="o">)))</span> <span class="o">{</span>
                    <span class="n">bound</span> <span class="o">=</span> <span class="n">nextBound</span><span class="o">;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">nextIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">advance</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="o">||</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">nextn</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">sc</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">finishing</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">nextTable</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">nextTab</span><span class="o">;</span>
                    <span class="n">sizeCtl</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SIZECTL</span><span class="o">,</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">sizeCtl</span><span class="o">,</span> <span class="n">sc</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">sc</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">!=</span> <span class="n">resizeStamp</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">&lt;&lt;</span> <span class="no">RESIZE_STAMP_SHIFT</span><span class="o">)</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="n">finishing</span> <span class="o">=</span> <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span> <span class="c1">// recheck before commit</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">advance</span> <span class="o">=</span> <span class="n">casTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">fwd</span><span class="o">);</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">==</span> <span class="no">MOVED</span><span class="o">)</span>
                <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// already processed</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">ln</span><span class="o">,</span> <span class="n">hn</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">fh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">int</span> <span class="n">runBit</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">;</span>
                            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">lastRun</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">next</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">runBit</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">runBit</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
                                    <span class="n">lastRun</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">runBit</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">ln</span> <span class="o">=</span> <span class="n">lastRun</span><span class="o">;</span>
                                <span class="n">hn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">hn</span> <span class="o">=</span> <span class="n">lastRun</span><span class="o">;</span>
                                <span class="n">ln</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">lastRun</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span>
                                <span class="no">K</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                                <span class="no">V</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                                    <span class="n">ln</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">ph</span><span class="o">,</span> <span class="n">pk</span><span class="o">,</span> <span class="n">pv</span><span class="o">,</span> <span class="n">ln</span><span class="o">);</span>
                                <span class="k">else</span>
                                    <span class="n">hn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">ph</span><span class="o">,</span> <span class="n">pk</span><span class="o">,</span> <span class="n">pv</span><span class="o">,</span> <span class="n">hn</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">ln</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="o">,</span> <span class="n">hn</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fwd</span><span class="o">);</span>
                            <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">f</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">lo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">hi</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hiTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="kt">int</span> <span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">hc</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">first</span><span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                                <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span>
                                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                                        <span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">&amp;</span> <span class="n">n</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">loTail</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">lo</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="k">else</span>
                                        <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="n">loTail</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="o">++</span><span class="n">lc</span><span class="o">;</span>
                                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">hiTail</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                        <span class="n">hi</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="k">else</span>
                                        <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="n">hiTail</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                                    <span class="o">++</span><span class="n">hc</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                            <span class="n">ln</span> <span class="o">=</span> <span class="o">(</span><span class="n">lc</span> <span class="o">&lt;=</span> <span class="no">UNTREEIFY_THRESHOLD</span><span class="o">)</span> <span class="o">?</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">lo</span><span class="o">)</span> <span class="o">:</span>
                                    <span class="o">(</span><span class="n">hc</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">lo</span><span class="o">)</span> <span class="o">:</span> <span class="n">t</span><span class="o">;</span>
                            <span class="n">hn</span> <span class="o">=</span> <span class="o">(</span><span class="n">hc</span> <span class="o">&lt;=</span> <span class="no">UNTREEIFY_THRESHOLD</span><span class="o">)</span> <span class="o">?</span> <span class="n">untreeify</span><span class="o">(</span><span class="n">hi</span><span class="o">)</span> <span class="o">:</span>
                                    <span class="o">(</span><span class="n">lc</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">hi</span><span class="o">)</span> <span class="o">:</span> <span class="n">t</span><span class="o">;</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">ln</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">nextTab</span><span class="o">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="o">,</span> <span class="n">hn</span><span class="o">);</span>
                            <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">fwd</span><span class="o">);</span>
                            <span class="n">advance</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Counter support -------------- */</span>

    <span class="cm">/**
     * A padded cell for distributing counts.  Adapted from LongAdder
     * and Striped64.  See their internal docs for explanation.
     */</span>
    <span class="nd">@sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Contended</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CounterCell</span> <span class="o">{</span>
        <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">value</span><span class="o">;</span>

        <span class="nc">CounterCell</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">long</span> <span class="nf">sumCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">as</span> <span class="o">=</span> <span class="n">counterCells</span><span class="o">;</span>
        <span class="nc">CounterCell</span> <span class="n">a</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">baseCount</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">as</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// See LongAdder version for explanation</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">fullAddCount</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">wasUncontended</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">())</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">localInit</span><span class="o">();</span>      <span class="c1">// force initialization</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">getProbe</span><span class="o">();</span>
            <span class="n">wasUncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                <span class="c1">// True if last slot nonempty</span>
        <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span>
            <span class="nc">CounterCell</span> <span class="n">a</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">v</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">counterCells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>            <span class="c1">// Try to attach new Cell</span>
                        <span class="nc">CounterCell</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CounterCell</span><span class="o">(</span><span class="n">x</span><span class="o">);</span> <span class="c1">// Optimistic create</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                                <span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">CELLSBUSY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                            <span class="kt">boolean</span> <span class="n">created</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="k">try</span> <span class="o">{</span>               <span class="c1">// Recheck under lock</span>
                                <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">rs</span><span class="o">;</span>
                                <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">j</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">counterCells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                                        <span class="n">rs</span><span class="o">[</span><span class="n">j</span> <span class="o">=</span> <span class="o">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">rs</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                                    <span class="n">created</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                                <span class="n">cellsBusy</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">created</span><span class="o">)</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">continue</span><span class="o">;</span>           <span class="c1">// Slot is now non-empty</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">wasUncontended</span><span class="o">)</span>       <span class="c1">// CAS already known to fail</span>
                    <span class="n">wasUncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>      <span class="c1">// Continue after rehash</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="no">CELLVALUE</span><span class="o">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span><span class="o">))</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">counterCells</span> <span class="o">!=</span> <span class="n">as</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="no">NCPU</span><span class="o">)</span>
                    <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>            <span class="c1">// At max size or stale</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">collide</span><span class="o">)</span>
                    <span class="n">collide</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">CELLSBUSY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">counterCells</span> <span class="o">==</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span><span class="c1">// Expand table unless stale</span>
                            <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">rs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CounterCell</span><span class="o">[</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">];</span>
                            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
                                <span class="n">rs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                            <span class="n">counterCells</span> <span class="o">=</span> <span class="n">rs</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">cellsBusy</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">continue</span><span class="o">;</span>                   <span class="c1">// Retry with expanded table</span>
                <span class="o">}</span>
                <span class="n">h</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">advanceProbe</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">counterCells</span> <span class="o">==</span> <span class="n">as</span> <span class="o">&amp;&amp;</span>
                    <span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">CELLSBUSY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>                           <span class="c1">// Initialize table</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">counterCells</span> <span class="o">==</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">CounterCell</span><span class="o">[]</span> <span class="n">rs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CounterCell</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
                        <span class="n">rs</span><span class="o">[</span><span class="n">h</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CounterCell</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                        <span class="n">counterCells</span> <span class="o">=</span> <span class="n">rs</span><span class="o">;</span>
                        <span class="n">init</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">cellsBusy</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">init</span><span class="o">)</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">BASECOUNT</span><span class="o">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">baseCount</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span><span class="o">))</span>
                <span class="k">break</span><span class="o">;</span>                          <span class="c1">// Fall back on using base</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- Conversion from/to TreeBins -------------- */</span>

    <span class="cm">/**
     * Replaces all linked nodes in bin at given index unless table is
     * too small, in which case resizes instead.
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">treeifyBin</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">sc</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&lt;</span> <span class="no">MIN_TREEIFY_CAPACITY</span><span class="o">)</span>
                <span class="n">tryPresize</span><span class="o">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">);</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">b</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">b</span><span class="o">.</span><span class="na">hash</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">tabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">)</span> <span class="o">==</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">hd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span>
                                    <span class="k">new</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">val</span><span class="o">,</span>
                                            <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">tl</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">hd</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">tl</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                            <span class="n">tl</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="n">setTabAt</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">hd</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a list on non-TreeNodes replacing those in given list.
     */</span>
    <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">untreeify</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">hd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">q</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">hd</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">tl</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">tl</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">hd</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- TreeNodes -------------- */</span>

    <span class="cm">/**
     * Nodes for use in TreeBins
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>  <span class="c1">// red-black tree links</span>
        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">;</span>
        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">;</span>
        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>    <span class="c1">// needed to unlink next upon deletion</span>
        <span class="kt">boolean</span> <span class="n">red</span><span class="o">;</span>

        <span class="nc">TreeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">val</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">,</span>
                 <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Returns the TreeNode (or null if not found) for the given key
         * starting at given root.
         */</span>
        <span class="kd">final</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">findTreeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">ph</span><span class="o">,</span> <span class="n">dir</span><span class="o">;</span>
                    <span class="no">K</span> <span class="n">pk</span><span class="o">;</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">;</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">)</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">ph</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">)</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">pr</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">pk</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pk</span><span class="o">)))</span>
                        <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">pr</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">kc</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
                            <span class="o">(</span><span class="n">kc</span> <span class="o">=</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">dir</span> <span class="o">=</span> <span class="n">compareComparables</span><span class="o">(</span><span class="n">kc</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">pl</span> <span class="o">:</span> <span class="n">pr</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">q</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">kc</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span> <span class="n">q</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* ---------------- TreeBins -------------- */</span>

    <span class="cm">/**
     * TreeNodes used at the heads of bins. TreeBins do not hold user
     * keys or values, but instead point to list of TreeNodes and
     * their root. They also maintain a parasitic read-write lock
     * forcing writers (who hold bin lock) to wait for readers (who do
     * not) to complete before tree restructuring operations.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">;</span>
        <span class="kd">volatile</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">;</span>
        <span class="kd">volatile</span> <span class="nc">Thread</span> <span class="n">waiter</span><span class="o">;</span>
        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">lockState</span><span class="o">;</span>
        <span class="c1">// values for lockState</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">WRITER</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// set while holding write lock</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">WAITER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// set when waiting for write lock</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">READER</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span> <span class="c1">// increment value for setting read lock</span>

        <span class="cm">/**
         * Tie-breaking utility for ordering insertions when equal
         * hashCodes and non-comparable. We don't require a total
         * order, just a consistent insertion rule to maintain
         * equivalence across rebalancings. Tie-breaking further than
         * necessary simplifies testing a bit.
         */</span>
        <span class="kd">static</span> <span class="kt">int</span> <span class="nf">tieBreakOrder</span><span class="o">(</span><span class="nc">Object</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">d</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                    <span class="o">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span>
                            <span class="n">compareTo</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="nc">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">?</span>
                        <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Creates bin with initial set of nodes headed by b.
         */</span>
        <span class="nc">TreeBin</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="no">TREEBIN</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="no">K</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                    <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">hash</span><span class="o">;</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">dir</span><span class="o">,</span> <span class="n">ph</span><span class="o">;</span>
                        <span class="no">K</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">)</span>
                            <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">ph</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">)</span>
                            <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                        <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">kc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                <span class="o">(</span><span class="n">kc</span> <span class="o">=</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span>
                                <span class="o">(</span><span class="n">dir</span> <span class="o">=</span> <span class="n">compareComparables</span><span class="o">(</span><span class="n">kc</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">))</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                            <span class="n">dir</span> <span class="o">=</span> <span class="n">tieBreakOrder</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">);</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">xp</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">:</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">x</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">balanceInsertion</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">root</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
            <span class="k">assert</span> <span class="nf">checkInvariants</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Acquires write lock for tree restructuring.
         */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">lockRoot</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">LOCKSTATE</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="no">WRITER</span><span class="o">))</span>
                <span class="n">contendedLock</span><span class="o">();</span> <span class="c1">// offload to separate method</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Releases write lock for tree restructuring.
         */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">unlockRoot</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">lockState</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Possibly blocks awaiting root lock.
         */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">contendedLock</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">waiting</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">lockState</span><span class="o">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="no">WAITER</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">LOCKSTATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="no">WRITER</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">waiting</span><span class="o">)</span>
                            <span class="n">waiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="no">WAITER</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">LOCKSTATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">s</span> <span class="o">|</span> <span class="no">WAITER</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">waiting</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">waiter</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">waiting</span><span class="o">)</span>
                    <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Returns matching node or null if none. Tries to search
         * using tree comparisons from root, but continues linear
         * search when lock not available.
         */</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
                    <span class="no">K</span> <span class="n">ek</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">lockState</span><span class="o">)</span> <span class="o">&amp;</span> <span class="o">(</span><span class="no">WAITER</span> <span class="o">|</span> <span class="no">WRITER</span><span class="o">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">h</span> <span class="o">&amp;&amp;</span>
                                <span class="o">((</span><span class="n">ek</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">ek</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">ek</span><span class="o">))))</span>
                            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">LOCKSTATE</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">+</span> <span class="no">READER</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">root</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                                    <span class="n">r</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="nc">Thread</span> <span class="n">w</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="no">U</span><span class="o">.</span><span class="na">getAndAddInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">LOCKSTATE</span><span class="o">,</span> <span class="o">-</span><span class="no">READER</span><span class="o">)</span> <span class="o">==</span>
                                    <span class="o">(</span><span class="no">READER</span> <span class="o">|</span> <span class="no">WAITER</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">waiter</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Finds or adds a node.
         *
         * @return null if added
         */</span>
        <span class="kd">final</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">putTreeVal</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">,</span> <span class="no">K</span> <span class="n">k</span><span class="o">,</span> <span class="no">V</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">kc</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">searched</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">dir</span><span class="o">,</span> <span class="n">ph</span><span class="o">;</span>
                <span class="no">K</span> <span class="n">pk</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">ph</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">)</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">ph</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">)</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">pk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="o">(</span><span class="n">pk</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pk</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">kc</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">kc</span> <span class="o">=</span> <span class="n">comparableClassFor</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">dir</span> <span class="o">=</span> <span class="n">compareComparables</span><span class="o">(</span><span class="n">kc</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">))</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">searched</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">q</span><span class="o">,</span> <span class="n">ch</span><span class="o">;</span>
                        <span class="n">searched</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">kc</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span>
                                <span class="o">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                        <span class="o">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">findTreeNode</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">kc</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span>
                            <span class="k">return</span> <span class="n">q</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">dir</span> <span class="o">=</span> <span class="n">tieBreakOrder</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">pk</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">xp</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">:</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">h</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">dir</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">xp</span><span class="o">.</span><span class="na">red</span><span class="o">)</span>
                        <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">lockRoot</span><span class="o">();</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">root</span> <span class="o">=</span> <span class="n">balanceInsertion</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">unlockRoot</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">assert</span> <span class="nf">checkInvariants</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Removes the given node, that must be present before this
         * call.  This is messier than typical red-black deletion code
         * because we cannot swap the contents of an interior node
         * with a leaf successor that is pinned by "next" pointers
         * that are accessible independently of lock. So instead we
         * swap the tree linkages.
         *
         * @return true if now too small, so should be untreeified
         */</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">removeTreeNode</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>  <span class="c1">// unlink traversal pointers</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">rl</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">root</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">root</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">r</span><span class="o">.</span><span class="na">right</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="c1">// too small</span>
                    <span class="o">(</span><span class="n">rl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rl</span><span class="o">.</span><span class="na">left</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">lockRoot</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">replacement</span><span class="o">;</span>
                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">pr</span><span class="o">,</span> <span class="n">sl</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">((</span><span class="n">sl</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// find successor</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">sl</span><span class="o">;</span>
                    <span class="kt">boolean</span> <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">red</span><span class="o">;</span>
                    <span class="n">s</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">red</span><span class="o">;</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// swap colors</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">pr</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// p was s's direct parent</span>
                        <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                        <span class="n">s</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">sp</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">sp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                                <span class="n">sp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">sp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">s</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">pr</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">pr</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">sr</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">sr</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">s</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">pl</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">pl</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">s</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">pp</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                        <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">sr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">replacement</span> <span class="o">=</span> <span class="n">sr</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">replacement</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">pl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="n">pl</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="n">pr</span><span class="o">;</span>
                <span class="k">else</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">replacement</span> <span class="o">!=</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">;</span>
                    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                        <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">;</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="n">root</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">balanceDeletion</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">replacement</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">replacement</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// detach pointers</span>
                    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">pp</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span>
                            <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span>
                            <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">unlockRoot</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">assert</span> <span class="nf">checkInvariants</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/* ------------------------------------------------------------ */</span>
        <span class="c1">// Red-black tree methods, all adapted from CLR</span>

        <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">rotateLeft</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                                <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">,</span> <span class="n">pp</span><span class="o">,</span> <span class="n">rl</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">rl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">rl</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">(</span><span class="n">root</span> <span class="o">=</span> <span class="n">r</span><span class="o">).</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                    <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="k">else</span>
                    <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="n">r</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">rotateRight</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                                 <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">l</span><span class="o">,</span> <span class="n">pp</span><span class="o">,</span> <span class="n">lr</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">lr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">lr</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">pp</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="o">(</span><span class="n">root</span> <span class="o">=</span> <span class="n">l</span><span class="o">).</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                    <span class="n">pp</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
                <span class="k">else</span>
                    <span class="n">pp</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
                <span class="n">l</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="n">p</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">balanceInsertion</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                                      <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">xp</span><span class="o">,</span> <span class="n">xpp</span><span class="o">,</span> <span class="n">xppl</span><span class="o">,</span> <span class="n">xppr</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">||</span> <span class="o">(</span><span class="n">xpp</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">==</span> <span class="o">(</span><span class="n">xppl</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">left</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">xppr</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xppr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">xppr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">);</span>
                            <span class="n">xpp</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xpp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpp</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">xppl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xppl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">xppl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">xpp</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">);</span>
                            <span class="n">xpp</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">parent</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xpp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xpp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpp</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">balanceDeletion</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">root</span><span class="o">,</span>
                                                     <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">xp</span><span class="o">,</span> <span class="n">xpl</span><span class="o">,</span> <span class="n">xpr</span><span class="o">;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">x</span> <span class="o">==</span> <span class="n">root</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">x</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">return</span> <span class="n">root</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">xpl</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">==</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">xpr</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xpr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>
                        <span class="n">xpr</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">xpr</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">xpr</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">xpr</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                                <span class="o">(</span><span class="n">sl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="o">.</span><span class="na">red</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">sr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">sl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">sl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpr</span><span class="o">);</span>
                                <span class="n">xpr</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
                                        <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xpr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xpr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">red</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">xpr</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">sr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// symmetric</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">xpl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">xpl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>
                        <span class="n">xpl</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">xpl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">xpl</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">sr</span> <span class="o">=</span> <span class="n">xpl</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                                <span class="o">(</span><span class="n">sr</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sr</span><span class="o">.</span><span class="na">red</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">xp</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">sl</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="o">.</span><span class="na">red</span><span class="o">)</span> <span class="o">{</span>
                                <span class="k">if</span> <span class="o">(</span><span class="n">sr</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">sr</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xpl</span><span class="o">);</span>
                                <span class="n">xpl</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
                                        <span class="kc">null</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xpl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xpl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="o">(</span><span class="n">xp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="n">xp</span><span class="o">.</span><span class="na">red</span><span class="o">;</span>
                                <span class="k">if</span> <span class="o">((</span><span class="n">sl</span> <span class="o">=</span> <span class="n">xpl</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                                    <span class="n">sl</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">xp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">xp</span><span class="o">.</span><span class="na">red</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                                <span class="n">root</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">xp</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Recursive invariant check
         */</span>
        <span class="kd">static</span> <span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">checkInvariants</span><span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">parent</span><span class="o">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">right</span><span class="o">,</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">prev</span><span class="o">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">t</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tb</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">tb</span><span class="o">.</span><span class="na">next</span> <span class="o">!=</span> <span class="n">t</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tn</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">tn</span><span class="o">.</span><span class="na">prev</span> <span class="o">!=</span> <span class="n">t</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">.</span><span class="na">left</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">.</span><span class="na">right</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">tl</span><span class="o">.</span><span class="na">parent</span> <span class="o">!=</span> <span class="n">t</span> <span class="o">||</span> <span class="n">tl</span><span class="o">.</span><span class="na">hash</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">hash</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">tr</span><span class="o">.</span><span class="na">parent</span> <span class="o">!=</span> <span class="n">t</span> <span class="o">||</span> <span class="n">tr</span><span class="o">.</span><span class="na">hash</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="na">hash</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">red</span> <span class="o">&amp;&amp;</span> <span class="n">tl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">tl</span><span class="o">.</span><span class="na">red</span> <span class="o">&amp;&amp;</span> <span class="n">tr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">tr</span><span class="o">.</span><span class="na">red</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tl</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">checkInvariants</span><span class="o">(</span><span class="n">tl</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">checkInvariants</span><span class="o">(</span><span class="n">tr</span><span class="o">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span> <span class="no">U</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">LOCKSTATE</span><span class="o">;</span>

        <span class="kd">static</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="no">U</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
                <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">k</span> <span class="o">=</span> <span class="nc">TreeBin</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
                <span class="no">LOCKSTATE</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                        <span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"lockState"</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* ----------------Table Traversal -------------- */</span>

    <span class="cm">/**
     * Records the table, its length, and current traversal index for a
     * traverser that must process a region of a forwarded table before
     * proceeding with current table.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">length</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>
        <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Encapsulates traversal for methods such as containsValue; also
     * serves as a base class for other iterators and spliterators.
     * &lt;p&gt;
     * Method advance visits once each still-valid node that was
     * reachable upon iterator construction. It might miss some that
     * were added to a bin after the bin was visited, which is OK wrt
     * consistency guarantees. Maintaining this property in the face
     * of possible ongoing resizes requires a fair amount of
     * bookkeeping state that is difficult to optimize away amidst
     * volatile accesses.  Even so, traversal maintains reasonable
     * throughput.
     * &lt;p&gt;
     * Normally, iteration proceeds bin-by-bin traversing lists.
     * However, if the table has been resized, then all future steps
     * must traverse both the bin at the current index as well as at
     * (index + baseSize); and so on for further resizings. To
     * paranoically cope with potential sharing by users of iterators
     * across threads, iteration terminates if a bounds checks fails
     * for a table read.
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>        <span class="c1">// current table; updated if resized</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>         <span class="c1">// the next entry to use</span>
        <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">stack</span><span class="o">,</span> <span class="n">spare</span><span class="o">;</span> <span class="c1">// to save/restore on ForwardingNodes</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>              <span class="c1">// index of bin to use next</span>
        <span class="kt">int</span> <span class="n">baseIndex</span><span class="o">;</span>          <span class="c1">// current index of initial table</span>
        <span class="kt">int</span> <span class="n">baseLimit</span><span class="o">;</span>          <span class="c1">// index bound for initial table</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">baseSize</span><span class="o">;</span>     <span class="c1">// initial table size</span>

        <span class="nc">Traverser</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">baseSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">baseIndex</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">baseLimit</span> <span class="o">=</span> <span class="n">limit</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Advances if possible, returning next valid node, or null if none.
         */</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">advance</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">;</span>  <span class="c1">// must use locals in checks</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">baseIndex</span> <span class="o">&gt;=</span> <span class="n">baseLimit</span> <span class="o">||</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">tab</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">)</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">i</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">ForwardingNode</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">tab</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">).</span><span class="na">nextTable</span><span class="o">;</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">pushState</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">).</span><span class="na">first</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">stack</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">recoverState</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">baseSize</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">baseIndex</span><span class="o">;</span> <span class="c1">// visit upper slots if present</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Saves traversal state upon encountering a forwarding node.
         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">pushState</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">spare</span><span class="o">;</span>  <span class="c1">// reuse if possible</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">spare</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;();</span>
            <span class="n">s</span><span class="o">.</span><span class="na">tab</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
            <span class="n">s</span><span class="o">.</span><span class="na">length</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
            <span class="n">s</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">s</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">stack</span><span class="o">;</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Possibly pops traversal state.
         *
         * @param n length of current table
         */</span>
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">recoverState</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">stack</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">+=</span> <span class="o">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">len</span><span class="o">;</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">index</span><span class="o">;</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">tab</span><span class="o">;</span>
                <span class="n">s</span><span class="o">.</span><span class="na">tab</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">s</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">spare</span><span class="o">;</span> <span class="c1">// save for reuse</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                <span class="n">spare</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">+=</span> <span class="n">baseSize</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">baseIndex</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Base of key, value, and entry Iterators. Adds fields to
     * Traverser to support iterator.remove.
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BaseIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">lastReturned</span><span class="o">;</span>

        <span class="nc">BaseIterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                     <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">map</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="n">advance</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasMoreElements</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">lastReturned</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">map</span><span class="o">.</span><span class="na">replaceNode</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">KeyIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">BaseIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;,</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">KeyIterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                    <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
            <span class="no">K</span> <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">advance</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">nextElement</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ValueIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">BaseIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">ValueIterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                      <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
            <span class="no">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">advance</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">nextElement</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntryIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">BaseIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
        <span class="nc">EntryIterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                      <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">limit</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
            <span class="no">K</span> <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
            <span class="no">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
            <span class="n">advance</span><span class="o">();</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">MapEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Exported Entry for EntryIterator
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="no">K</span> <span class="n">key</span><span class="o">;</span> <span class="c1">// non-null</span>
        <span class="no">V</span> <span class="n">val</span><span class="o">;</span>       <span class="c1">// non-null</span>
        <span class="kd">final</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">;</span>

        <span class="nc">MapEntry</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">val</span><span class="o">,</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">map</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="no">K</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="no">V</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">^</span> <span class="n">val</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">val</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">;</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;)</span> <span class="n">o</span><span class="o">).</span><span class="na">getKey</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="n">k</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">val</span> <span class="o">||</span> <span class="n">v</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">val</span><span class="o">)));</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Sets our entry's value and writes through to the map. The
         * value to return is somewhat arbitrary here. Since we do not
         * necessarily track asynchronous changes, the most recent
         * "previous" value could be different from what we return (or
         * could even have been removed, in which case the put will
         * re-establish). We do not and cannot guarantee more.
         */</span>
        <span class="kd">public</span> <span class="no">V</span> <span class="nf">setValue</span><span class="o">(</span><span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="no">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">KeySpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">est</span><span class="o">;</span>               <span class="c1">// size estimate</span>

        <span class="nc">KeySpliterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                       <span class="kt">long</span> <span class="n">est</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">est</span> <span class="o">=</span> <span class="n">est</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">))</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                    <span class="k">new</span> <span class="nc">KeySpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">tab</span><span class="o">,</span> <span class="n">baseSize</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span>
                            <span class="n">f</span><span class="o">,</span> <span class="n">est</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">est</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">DISTINCT</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">CONCURRENT</span> <span class="o">|</span>
                    <span class="nc">Spliterator</span><span class="o">.</span><span class="na">NONNULL</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ValueSpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">est</span><span class="o">;</span>               <span class="c1">// size estimate</span>

        <span class="nc">ValueSpliterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                         <span class="kt">long</span> <span class="n">est</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">est</span> <span class="o">=</span> <span class="n">est</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">))</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                    <span class="k">new</span> <span class="nc">ValueSpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">tab</span><span class="o">,</span> <span class="n">baseSize</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span>
                            <span class="n">f</span><span class="o">,</span> <span class="n">est</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">est</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">CONCURRENT</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">NONNULL</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntrySpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">;</span> <span class="c1">// To export MapEntry</span>
        <span class="kt">long</span> <span class="n">est</span><span class="o">;</span>               <span class="c1">// size estimate</span>

        <span class="nc">EntrySpliterator</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">,</span>
                         <span class="kt">long</span> <span class="n">est</span><span class="o">,</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">map</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">est</span> <span class="o">=</span> <span class="n">est</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">))</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span>
                    <span class="k">new</span> <span class="nc">EntrySpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">tab</span><span class="o">,</span> <span class="n">baseSize</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span>
                            <span class="n">f</span><span class="o">,</span> <span class="n">est</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="nc">MapEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="n">map</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="nc">MapEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="n">map</span><span class="o">));</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">est</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">DISTINCT</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">CONCURRENT</span> <span class="o">|</span>
                    <span class="nc">Spliterator</span><span class="o">.</span><span class="na">NONNULL</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Parallel bulk operations</span>

    <span class="cm">/**
     * Computes initial batch value for bulk tasks. The returned value
     * is approximately exp2 of the number of times (minus one) to
     * split task by two before executing leaf action. This value is
     * faster to compute and more convenient to use as a guide to
     * splitting than is the depth, since it is used while dividing by
     * two anyway.
     */</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="nf">batchFor</span><span class="o">(</span><span class="kt">long</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">n</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="nc">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">sumCount</span><span class="o">())</span> <span class="o">&lt;=</span> <span class="mi">1L</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sp</span> <span class="o">=</span> <span class="nc">ForkJoinPool</span><span class="o">.</span><span class="na">getCommonPoolParallelism</span><span class="o">()</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="o">;</span> <span class="c1">// slack of 4</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0L</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">/=</span> <span class="n">b</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">sp</span><span class="o">)</span> <span class="o">?</span> <span class="n">sp</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">n</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each (key, value).
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param action               the action
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                        <span class="nc">BiConsumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachMappingTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each non-null transformation
     * of each (key, value).
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case the action is not applied)
     * @param action               the action
     * @param &lt;U&gt;                  the return type of the transformer
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                            <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                            <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachTransformedMappingTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a non-null result from applying the given search
     * function on each (key, value), or null if none.  Upon
     * success, further element processing is suppressed and the
     * results of any other parallel invocations of the search
     * function are ignored.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param searchFunction       a function returning a non-null
     *                             result on success, else null
     * @param &lt;U&gt;                  the return type of the search function
     * @return a non-null result from applying the given search
     * function on each (key, value), or null if none
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">search</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                        <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">searchFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">SearchMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">searchFunction</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;()).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all (key, value) pairs using the given reducer to
     * combine values, or null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case it is not combined)
     * @param reducer              a commutative associative combining function
     * @param &lt;U&gt;                  the return type of the transformer
     * @return the result of accumulating the given transformation
     * of all (key, value) pairs
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">reduce</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                        <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                        <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all (key, value) pairs using the given reducer to
     * combine values, and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all (key, value) pairs
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">reduceToDouble</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                 <span class="nc">ToDoubleBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                 <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                                 <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all (key, value) pairs using the given reducer to
     * combine values, and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all (key, value) pairs
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">reduceToLong</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                             <span class="nc">ToLongBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                             <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                             <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all (key, value) pairs using the given reducer to
     * combine values, and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all (key, value) pairs
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceToInt</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                           <span class="nc">ToIntBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                           <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                           <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each key.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param action               the action
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                           <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachKeyTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each non-null transformation
     * of each key.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case the action is not applied)
     * @param action               the action
     * @param &lt;U&gt;                  the return type of the transformer
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">forEachKey</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                               <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                               <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachTransformedKeyTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a non-null result from applying the given search
     * function on each key, or null if none. Upon success,
     * further element processing is suppressed and the results of
     * any other parallel invocations of the search function are
     * ignored.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param searchFunction       a function returning a non-null
     *                             result on success, else null
     * @param &lt;U&gt;                  the return type of the search function
     * @return a non-null result from applying the given search
     * function on each key, or null if none
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">searchKeys</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                            <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">searchFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">SearchKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">searchFunction</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;()).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating all keys using the given
     * reducer to combine values, or null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating all keys using the given
     * reducer to combine values, or null if none
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="no">K</span> <span class="nf">reduceKeys</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                        <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all keys using the given reducer to combine values, or
     * null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case it is not combined)
     * @param reducer              a commutative associative combining function
     * @param &lt;U&gt;                  the return type of the transformer
     * @return the result of accumulating the given transformation
     * of all keys
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">reduceKeys</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                            <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                            <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all keys using the given reducer to combine values, and
     * the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all keys
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">reduceKeysToDouble</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                     <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                     <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                                     <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all keys using the given reducer to combine values, and
     * the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all keys
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">reduceKeysToLong</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                 <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                 <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                                 <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all keys using the given reducer to combine values, and
     * the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all keys
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceKeysToInt</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                               <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                               <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                               <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param action               the action
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachValue</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                             <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachValueTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each non-null transformation
     * of each value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case the action is not applied)
     * @param action               the action
     * @param &lt;U&gt;                  the return type of the transformer
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">forEachValue</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                 <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachTransformedValueTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a non-null result from applying the given search
     * function on each value, or null if none.  Upon success,
     * further element processing is suppressed and the results of
     * any other parallel invocations of the search function are
     * ignored.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param searchFunction       a function returning a non-null
     *                             result on success, else null
     * @param &lt;U&gt;                  the return type of the search function
     * @return a non-null result from applying the given search
     * function on each value, or null if none
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">searchValues</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                              <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">searchFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">SearchValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">searchFunction</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;()).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating all values using the
     * given reducer to combine values, or null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating all values
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">reduceValues</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                          <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all values using the given reducer to combine values, or
     * null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case it is not combined)
     * @param reducer              a commutative associative combining function
     * @param &lt;U&gt;                  the return type of the transformer
     * @return the result of accumulating the given transformation
     * of all values
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">reduceValues</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                              <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                              <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all values using the given reducer to combine values,
     * and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all values
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">reduceValuesToDouble</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                       <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                       <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                                       <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all values using the given reducer to combine values,
     * and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all values
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">reduceValuesToLong</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                   <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                   <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                                   <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all values using the given reducer to combine values,
     * and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all values
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceValuesToInt</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                 <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                 <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                                 <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each entry.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param action               the action
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachEntry</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                             <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachEntryTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Performs the given action for each non-null transformation
     * of each entry.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case the action is not applied)
     * @param action               the action
     * @param &lt;U&gt;                  the return type of the transformer
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">forEachEntry</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                 <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                 <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">new</span> <span class="nc">ForEachTransformedEntryTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns a non-null result from applying the given search
     * function on each entry, or null if none.  Upon success,
     * further element processing is suppressed and the results of
     * any other parallel invocations of the search function are
     * ignored.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param searchFunction       a function returning a non-null
     *                             result on success, else null
     * @param &lt;U&gt;                  the return type of the search function
     * @return a non-null result from applying the given search
     * function on each entry, or null if none
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">searchEntries</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                               <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">searchFunction</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">SearchEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="n">searchFunction</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;()).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating all entries using the
     * given reducer to combine values, or null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating all entries
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">reduceEntries</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                         <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all entries using the given reducer to combine values,
     * or null if none.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element, or null if there is no transformation (in
     *                             which case it is not combined)
     * @param reducer              a commutative associative combining function
     * @param &lt;U&gt;                  the return type of the transformer
     * @return the result of accumulating the given transformation
     * of all entries
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="no">U</span> <span class="nf">reduceEntries</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                               <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                               <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all entries using the given reducer to combine values,
     * and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all entries
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">reduceEntriesToDouble</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                        <span class="nc">ToDoubleFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                        <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                                        <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all entries using the given reducer to combine values,
     * and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all entries
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">reduceEntriesToLong</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                    <span class="nc">ToLongFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                    <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                                    <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the result of accumulating the given transformation
     * of all entries using the given reducer to combine values,
     * and the given basis as an identity value.
     *
     * @param parallelismThreshold the (estimated) number of elements
     *                             needed for this operation to be executed in parallel
     * @param transformer          a function returning the transformation
     *                             for an element
     * @param basis                the identity (initial default value) for the reduction
     * @param reducer              a commutative associative combining function
     * @return the result of accumulating the given transformation
     * of all entries
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceEntriesToInt</span><span class="o">(</span><span class="kt">long</span> <span class="n">parallelismThreshold</span><span class="o">,</span>
                                  <span class="nc">ToIntFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                                  <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                                  <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transformer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">reducer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                <span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">batchFor</span><span class="o">(</span><span class="n">parallelismThreshold</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">table</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">basis</span><span class="o">,</span> <span class="n">reducer</span><span class="o">).</span><span class="na">invoke</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="cm">/* ----------------Views -------------- */</span>

    <span class="cm">/**
     * Base class for views.
     */</span>
    <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CollectionView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">E</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7249069246763182397L</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">;</span>

        <span class="nc">CollectionView</span><span class="o">(</span><span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">map</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Returns the map backing this view.
         *
         * @return the map backing this view
         */</span>
        <span class="kd">public</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">getMap</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Removes all of the elements from this view, by removing all
         * the mappings from the map backing this view.
         */</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">map</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// implementations below rely on concrete classes supplying these</span>
        <span class="c1">// abstract methods</span>

        <span class="cm">/**
         * Returns an iterator over the elements in this collection.
         * &lt;p&gt;
         * &lt;p&gt;The returned iterator is
         * &lt;a href="package-summary.html#Weakly"&gt;&lt;i&gt;weakly consistent&lt;/i&gt;&lt;/a&gt;.
         *
         * @return an iterator over the elements in this collection
         */</span>
        <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>

        <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">oomeMsg</span> <span class="o">=</span> <span class="s">"Required array size too large"</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">mappingCount</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">(</span><span class="n">oomeMsg</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">sz</span><span class="o">;</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="no">E</span> <span class="n">e</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">(</span><span class="n">oomeMsg</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAX_ARRAY_SIZE</span> <span class="o">-</span> <span class="o">(</span><span class="no">MAX_ARRAY_SIZE</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">r</span><span class="o">[</span><span class="n">i</span><span class="o">++]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">)</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">mappingCount</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">(</span><span class="n">oomeMsg</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">sz</span><span class="o">;</span>
            <span class="no">T</span><span class="o">[]</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="o">)</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span>
                    <span class="o">(</span><span class="no">T</span><span class="o">[])</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Array</span>
                            <span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getComponentType</span><span class="o">(),</span> <span class="n">m</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="no">E</span> <span class="n">e</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">(</span><span class="n">oomeMsg</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAX_ARRAY_SIZE</span> <span class="o">-</span> <span class="o">(</span><span class="no">MAX_ARRAY_SIZE</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">r</span><span class="o">[</span><span class="n">i</span><span class="o">++]</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">r</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// null-terminate</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="o">)</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Returns a string representation of this collection.
         * The string representation consists of the string representations
         * of the collection's elements in the order they are returned by
         * its iterator, enclosed in square brackets ({@code "[]"}).
         * Adjacent elements are separated by the characters {@code ", "}
         * (comma and space).  Elements are converted to strings as by
         * {@link String#valueOf(Object)}.
         *
         * @return a string representation of this collection
         */</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">'['</span><span class="o">);</span>
            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Object</span> <span class="n">e</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="k">this</span> <span class="o">?</span> <span class="s">"(this Collection)"</span> <span class="o">:</span> <span class="n">e</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">','</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">']'</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">containsAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">e</span> <span class="o">:</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">contains</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="kt">boolean</span> <span class="n">modified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="n">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">modified</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="kt">boolean</span> <span class="n">modified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="n">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">modified</span><span class="o">;</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="cm">/**
     * A view of a ConcurrentHashMap as a {@link Set} of keys, in
     * which additions may optionally be enabled by mapping to a
     * common value.  This class cannot be directly instantiated.
     * See {@link #keySet() keySet()},
     * {@link #keySet(Object) keySet(V)},
     * {@link #newKeySet() newKeySet()},
     * {@link #newKeySet(int) newKeySet(int)}.
     *
     * @since 1.8
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">KeySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">CollectionView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">K</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7249069246763182397L</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="no">V</span> <span class="n">value</span><span class="o">;</span>

        <span class="nc">KeySetView</span><span class="o">(</span><span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// non-public</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Returns the default mapped value for additions,
         * or {@code null} if additions are not supported.
         *
         * @return the default mapped value for additions, or {@code null}
         * if not supported
         */</span>
        <span class="kd">public</span> <span class="no">V</span> <span class="nf">getMappedValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * {@inheritDoc}
         *
         * @throws NullPointerException if the specified key is null
         */</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Removes the key from this map view, by removing the key (and its
         * corresponding value) from the backing map.  This method does
         * nothing if the key is not in the map.
         *
         * @param o the key to be removed from the backing map
         * @return {@code true} if the backing map contained the specified key
         * @throws NullPointerException if the specified key is null
         */</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * @return an iterator over the keys of the backing map
         */</span>
        <span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">KeyIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Adds the specified key to this set view by mapping the key to
         * the default mapped value in the backing map, if defined.
         *
         * @param e key to be added
         * @return {@code true} if this set changed as a result of the call
         * @throws NullPointerException          if the specified key is null
         * @throws UnsupportedOperationException if no default mapped value
         *                                       for additions was provided
         */</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">K</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">value</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">putVal</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Adds all of the elements in the specified collection to this set,
         * as if by calling {@link #add} on each one.
         *
         * @param c the elements to be inserted into this set
         * @return {@code true} if this set changed as a result of the call
         * @throws NullPointerException          if the collection or any of its
         *                                       elements are {@code null}
         * @throws UnsupportedOperationException if no default mapped value
         *                                       for additions was provided
         */</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">added</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">value</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="no">K</span> <span class="n">e</span> <span class="o">:</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">putVal</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">added</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="no">K</span> <span class="n">e</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span>
                <span class="n">h</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">h</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Set</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Set</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Set</span><span class="o">&lt;?&gt;)</span> <span class="n">o</span><span class="o">)</span> <span class="o">==</span> <span class="k">this</span> <span class="o">||</span>
                            <span class="o">(</span><span class="n">containsAll</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">.</span><span class="na">containsAll</span><span class="o">(</span><span class="k">this</span><span class="o">))));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">sumCount</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">KeySpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0L</span> <span class="o">?</span> <span class="mi">0L</span> <span class="o">:</span> <span class="n">n</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * A view of a ConcurrentHashMap as a {@link Collection} of
     * values, in which additions are disabled. This class cannot be
     * directly instantiated. See {@link #values()}.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ValuesView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">CollectionView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">implements</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">2249069246763182397L</span><span class="o">;</span>

        <span class="nc">ValuesView</span><span class="o">(</span><span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">containsValue</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">();</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ValueIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">V</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">sumCount</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ValueSpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0L</span> <span class="o">?</span> <span class="mi">0L</span> <span class="o">:</span> <span class="n">n</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * A view of a ConcurrentHashMap as a {@link Set} of (key, value)
     * entries.  This class cannot be directly instantiated. See
     * {@link #entrySet()}.
     */</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntrySetView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">CollectionView</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span>
            <span class="kd">implements</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">2249069246763182397L</span><span class="o">;</span>

        <span class="nc">EntrySetView</span><span class="o">(</span><span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">r</span><span class="o">;</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;)</span> <span class="n">o</span><span class="o">).</span><span class="na">getKey</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">r</span> <span class="o">||</span> <span class="n">v</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">r</span><span class="o">)));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">;</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;)</span> <span class="n">o</span><span class="o">).</span><span class="na">getKey</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="cm">/**
         * @return an iterator over the entries of the backing map
         */</span>
        <span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">EntryIterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">putVal</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="kc">false</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">added</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">add</span><span class="o">(</span><span class="n">e</span><span class="o">))</span>
                    <span class="n">added</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">added</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">h</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">h</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Set</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Set</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                    <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Set</span><span class="o">&lt;?&gt;)</span> <span class="n">o</span><span class="o">)</span> <span class="o">==</span> <span class="k">this</span> <span class="o">||</span>
                            <span class="o">(</span><span class="n">containsAll</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">.</span><span class="na">containsAll</span><span class="o">(</span><span class="k">this</span><span class="o">))));</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
            <span class="kt">long</span> <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">sumCount</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">EntrySpliterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0L</span> <span class="o">?</span> <span class="mi">0L</span> <span class="o">:</span> <span class="n">n</span><span class="o">,</span> <span class="n">m</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Traverser</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">t</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="nc">MapEntry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">,</span> <span class="n">map</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="c1">// -------------------------------------------------------</span>

    <span class="cm">/**
     * Base class for bulk tasks. Repeats some fields and code from
     * class Traverser, because we need to subclass CountedCompleter.
     */</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">R</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">CountedCompleter</span><span class="o">&lt;</span><span class="no">R</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>        <span class="c1">// same as Traverser</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
        <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">stack</span><span class="o">,</span> <span class="n">spare</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">baseIndex</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">baseLimit</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">baseSize</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">batch</span><span class="o">;</span>              <span class="c1">// split control</span>

        <span class="nc">BulkTask</span><span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">par</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">par</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">batch</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">baseIndex</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="k">this</span><span class="o">.</span><span class="na">tab</span> <span class="o">=</span> <span class="n">t</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">this</span><span class="o">.</span><span class="na">baseSize</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">baseLimit</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">par</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">this</span><span class="o">.</span><span class="na">baseSize</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">baseLimit</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">baseLimit</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">baseSize</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="na">baseSize</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="cm">/**
         * Same as Traverser version
         */</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">advance</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">baseIndex</span> <span class="o">&gt;=</span> <span class="n">baseLimit</span> <span class="o">||</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">tab</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">)</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">tabAt</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">i</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">ForwardingNode</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">tab</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ForwardingNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">).</span><span class="na">nextTable</span><span class="o">;</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">pushState</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">TreeBin</span><span class="o">)</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeBin</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">).</span><span class="na">first</span><span class="o">;</span>
                    <span class="k">else</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">stack</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">recoverState</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">baseSize</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">baseIndex</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">pushState</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">spare</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">spare</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;();</span>
            <span class="n">s</span><span class="o">.</span><span class="na">tab</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
            <span class="n">s</span><span class="o">.</span><span class="na">length</span> <span class="o">=</span> <span class="n">n</span><span class="o">;</span>
            <span class="n">s</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">s</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">stack</span><span class="o">;</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">recoverState</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">stack</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">+=</span> <span class="o">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">len</span><span class="o">;</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">index</span><span class="o">;</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">tab</span><span class="o">;</span>
                <span class="n">s</span><span class="o">.</span><span class="na">tab</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="nc">TableStack</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">s</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">spare</span><span class="o">;</span> <span class="c1">// save for reuse</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                <span class="n">spare</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">+=</span> <span class="n">baseSize</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="o">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">baseIndex</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Task classes. Coded in a regular but ugly format/style to
     * simplify checks that each variant differs in the right way from
     * others. The null screenings exist because compilers cannot tell
     * that we've already null-checked task arguments, so we force
     * simplest hoisted bypass to help avoid convoluted traps.
     */</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachKeyTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachKeyTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachKeyTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachValueTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachValueTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachValueTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachEntryTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachEntryTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachEntryTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachMappingTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiConsumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachMappingTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">BiConsumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiConsumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachMappingTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachTransformedKeyTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachTransformedKeyTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachTransformedKeyTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachTransformedValueTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachTransformedValueTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachTransformedValueTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachTransformedEntryTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachTransformedEntryTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachTransformedEntryTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ForEachTransformedMappingTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>

        <span class="nc">ForEachTransformedMappingTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">action</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">action</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">ForEachTransformedMappingTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">transformer</span><span class="o">,</span> <span class="n">action</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">propagateCompletion</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SearchKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>

        <span class="nc">SearchKeysTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">,</span>
                 <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">searchFunction</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">SearchKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">searchFunction</span><span class="o">,</span> <span class="n">result</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">propagateCompletion</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">u</span><span class="o">))</span>
                            <span class="n">quietlyCompleteRoot</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SearchValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>

        <span class="nc">SearchValuesTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">,</span>
                 <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">searchFunction</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">SearchValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">searchFunction</span><span class="o">,</span> <span class="n">result</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">propagateCompletion</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">u</span><span class="o">))</span>
                            <span class="n">quietlyCompleteRoot</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SearchEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>

        <span class="nc">SearchEntriesTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">,</span>
                 <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">searchFunction</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">SearchEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">searchFunction</span><span class="o">,</span> <span class="n">result</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">propagateCompletion</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">u</span><span class="o">))</span>
                            <span class="n">quietlyCompleteRoot</span><span class="o">();</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SearchMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>

        <span class="nc">SearchMappingsTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">,</span>
                 <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">searchFunction</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="no">U</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">searchFunction</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">searchFunction</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="k">new</span> <span class="nc">SearchMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">searchFunction</span><span class="o">,</span> <span class="n">result</span><span class="o">).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">propagateCompletion</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">searchFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">u</span><span class="o">))</span>
                            <span class="n">quietlyCompleteRoot</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">K</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="no">K</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">ReduceKeysTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="no">K</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">K</span> <span class="n">u</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">u</span> <span class="o">:</span> <span class="n">u</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="no">K</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="no">V</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">ReduceValuesTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="no">V</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">;</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">v</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="no">V</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">ReduceEntriesTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">p</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="no">U</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceKeysTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="no">U</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">u</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceKeysTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="no">U</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="no">U</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceValuesTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="no">U</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">u</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceValuesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="no">U</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="no">U</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceEntriesTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="no">U</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">u</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceEntriesTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="no">U</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="no">U</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceMappingsTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="no">U</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">BiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">U</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">U</span><span class="o">&gt;</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="no">U</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="no">U</span> <span class="n">u</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">u</span> <span class="o">:</span> <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">u</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceMappingsTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="no">U</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="no">U</span> <span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                            <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="o">(((</span><span class="n">tr</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">sr</span> <span class="o">:</span>
                                    <span class="n">reducer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">sr</span><span class="o">));</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Double</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceKeysToDoubleTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Double</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceKeysToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Double</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceValuesToDoubleTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Double</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceValuesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Double</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceEntriesToDoubleTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToDoubleFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Double</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToDoubleFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">p</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceEntriesToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Double</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToDoubleBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">double</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">double</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceMappingsToDoubleTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToDoubleBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">double</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Double</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToDoubleBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">DoubleBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceMappingsToDoubleTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsDouble</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceKeysToLongTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceKeysToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceValuesToLongTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToLongFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceValuesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToLongFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceEntriesToLongTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToLongFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToLongFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">p</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceEntriesToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToLongBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceMappingsToLongTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToLongBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">long</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToLongBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">LongBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceMappingsToLongTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceKeysToIntTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceKeysToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceValuesToIntTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToIntFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceValuesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToIntFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceEntriesToIntTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToIntFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToIntFunction</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">p</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceEntriesToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
            <span class="kd">extends</span> <span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">ToIntBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">basis</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
        <span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">rights</span><span class="o">,</span> <span class="n">nextRight</span><span class="o">;</span>

        <span class="nc">MapReduceMappingsToIntTask</span>
                <span class="o">(</span><span class="nc">BulkTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">p</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">f</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">,</span>
                 <span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">nextRight</span><span class="o">,</span>
                 <span class="nc">ToIntBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">,</span>
                 <span class="kt">int</span> <span class="n">basis</span><span class="o">,</span>
                 <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextRight</span> <span class="o">=</span> <span class="n">nextRight</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">transformer</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">basis</span> <span class="o">=</span> <span class="n">basis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reducer</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="nf">getRawResult</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">ToIntBiFunction</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">transformer</span><span class="o">;</span>
            <span class="kd">final</span> <span class="nc">IntBinaryOperator</span> <span class="n">reducer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">transformer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transformer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">reducer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">reducer</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">basis</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">baseIndex</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">h</span><span class="o">;</span> <span class="n">batch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="o">((</span><span class="n">f</span> <span class="o">=</span> <span class="n">baseLimit</span><span class="o">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                    <span class="n">addToPendingCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">(</span><span class="n">rights</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">batch</span> <span class="o">&gt;&gt;&gt;=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">baseLimit</span> <span class="o">=</span> <span class="n">h</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span>
                                    <span class="n">rights</span><span class="o">,</span> <span class="n">transformer</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">reducer</span><span class="o">)).</span><span class="na">fork</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">advance</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">transformer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">val</span><span class="o">));</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
                <span class="nc">CountedCompleter</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">firstComplete</span><span class="o">();</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">nextComplete</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
                    <span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapReduceMappingsToIntTask</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;)</span> <span class="n">c</span><span class="o">,</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">rights</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">nextRight</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Unsafe mechanics</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span> <span class="no">U</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">SIZECTL</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">TRANSFERINDEX</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">BASECOUNT</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">CELLSBUSY</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">CELLVALUE</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">ABASE</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ASHIFT</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="no">U</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">k</span> <span class="o">=</span> <span class="nc">ConcurrentHashMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
            <span class="no">SIZECTL</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                    <span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"sizeCtl"</span><span class="o">));</span>
            <span class="no">TRANSFERINDEX</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                    <span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"transferIndex"</span><span class="o">));</span>
            <span class="no">BASECOUNT</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                    <span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"baseCount"</span><span class="o">));</span>
            <span class="no">CELLSBUSY</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                    <span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"cellsBusy"</span><span class="o">));</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ck</span> <span class="o">=</span> <span class="nc">CounterCell</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
            <span class="no">CELLVALUE</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">objectFieldOffset</span>
                    <span class="o">(</span><span class="n">ck</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ak</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">[].</span><span class="na">class</span><span class="o">;</span>
            <span class="no">ABASE</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">arrayBaseOffset</span><span class="o">(</span><span class="n">ak</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">scale</span> <span class="o">=</span> <span class="no">U</span><span class="o">.</span><span class="na">arrayIndexScale</span><span class="o">(</span><span class="n">ak</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">scale</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Error</span><span class="o">(</span><span class="s">"data type scale not a power of two"</span><span class="o">);</span>
            <span class="no">ASHIFT</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">numberOfLeadingZeros</span><span class="o">(</span><span class="n">scale</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://blog.dreamylost.cn" target="_blank">梦境迷离</a></li><li>本文链接：<a href="https://blog.dreamylost.cn/java%E6%BA%90%E7%A0%81/Java%E6%BA%90%E7%A0%81-ConcurrentHashMap.html" target="_blank">https://blog.dreamylost.cn/java%E6%BA%90%E7%A0%81/Java%E6%BA%90%E7%A0%81-ConcurrentHashMap.html</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/java%E6%BA%90%E7%A0%81/Java%E6%BA%90%E7%A0%81-Con', clientID: '061aadb5d449c0877d7d', clientSecret: '9aa7af7c248a7e36a07a86993e11a7acf7fbd353', repo: 'dreamylost-comments', owner: 'jxnu-liguobin', admin: ['jxnu-liguobin'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@built/assets/search_data.json?v=1697167139', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8236444920328818" data-ad-slot="6220614560" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2019 <span title="梦境迷离">梦境迷离</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/jxnu-liguobin/jxnu-liguobin.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://blog.dreamylost.cn/" title="首页" target="">首页</a></li><li> <a href="https://blog.dreamylost.cn/categories/" title="分类" target="">分类</a></li><li> <a href="https://blog.dreamylost.cn/archives/" title="归档" target="">归档</a></li><li> <a href="https://blog.dreamylost.cn/open-source/" title="开源" target="">开源</a></li><li> <a href="https://blog.dreamylost.cn/wiki/" title="维基" target="">维基</a></li><li> <a href="https://blog.dreamylost.cn/links/" title="链接" target="">链接</a></li><li> <a href="https://blog.dreamylost.cn/about/" title="关于" target="">关于</a></li><li><a href="https://blog.dreamylost.cn/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2019-09-20 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-147390701-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
