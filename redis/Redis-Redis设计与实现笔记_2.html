<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Redis设计与实现笔记_2 &mdash; 梦境迷离</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://dreamylost.cn/redis/Redis-Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0_2.html"><link rel="alternate" type="application/atom+xml" title="梦境迷离" href="https://dreamylost.cn/feed.xml"><link rel="shortcut icon" href="https://dreamylost.cn/favicon.ico"><meta property="og:title" content="Redis设计与实现笔记_2"><meta name="keywords" content="梦境迷离, jxnu-liguobin"><meta name="og:keywords" content="梦境迷离, jxnu-liguobin"><meta name="description" content=" 数据库数据库"><meta name="og:description" content=" 数据库数据库"><meta property="og:url" content="https://dreamylost.cn/redis/Redis-Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0_2.html"><meta property="og:site_name" content="梦境迷离"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-02-06"> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-8236444920328818" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://dreamylost.cn/" title="梦境迷离"><span class="octicon octicon-mark-github"></span> 梦境迷离</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://dreamylost.cn/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://dreamylost.cn/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://dreamylost.cn/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://dreamylost.cn/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://dreamylost.cn/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Redis设计与实现笔记_2"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Redis设计与实现笔记_2</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/02/06 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://dreamylost.cn/categories/#Redis" title="Redis">Redis</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2972 字，约 9 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/images/qrcode.jpg" alt="梦境迷离" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-8236444920328818" data-ad-slot="3977594606"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><ul id="markdown-toc"><li><a href="#数据库" id="markdown-toc-数据库">数据库</a></li><li><a href="#持久化" id="markdown-toc-持久化">持久化</a><ul><li><a href="#rdb" id="markdown-toc-rdb">RDB</a></li><li><a href="#aof" id="markdown-toc-aof">AOF</a></li></ul></li><li><a href="#事件" id="markdown-toc-事件">事件</a></li><li><a href="#客户端" id="markdown-toc-客户端">客户端</a></li><li><a href="#服务器" id="markdown-toc-服务器">服务器</a></li></ul><h2 id="数据库">数据库</h2><ul><li>Redis服务器的所有数据都保存在<code class="language-plaintext highlighter-rouge">redisServer.db</code>数组中，而数据库的数量则由<code class="language-plaintext highlighter-rouge">redisServer.dbnum</code>属性保存</li><li>客户端通过修改目标数据库指针，让它指向<code class="language-plaintext highlighter-rouge">redisServer.db</code>数组中的不同元素来切换不同的数据库</li><li>数据库主要由<code class="language-plaintext highlighter-rouge">dict</code>和<code class="language-plaintext highlighter-rouge">expires</code>两个字典构成，其中<code class="language-plaintext highlighter-rouge">dict</code>字典负责保存键值对，而<code class="language-plaintext highlighter-rouge">expires</code>字典则负责保存键的过期时间</li><li>对数据库的操作都是建立在字典操作之上的</li><li>数据库的键总是一个字符串对象，而值则可以是任意一种Redis对象类型，包括字符串对象、哈希表对象、集合对象、列表对象和有序集合对象，分别对应字符串键、哈希表键、集合键、列表键和有序集合键</li><li><code class="language-plaintext highlighter-rouge">expires</code>字典的键指向数据库中的某个键，而值则记录了数据库键的过期时间，过期时间是一个以毫秒为单位的UNIX时间戳</li><li>Redis使用惰性删除和定期删除两种策略来删除过期的键：惰性删除策略只在碰到过期键时才进行删除操作，定期删除策略则每隔一段时间主动查找并删除过期键</li><li>执行<code class="language-plaintext highlighter-rouge">SAVE</code>命令或<code class="language-plaintext highlighter-rouge">BGSAVE</code>命令所产生的新RDB文件不会包含已经过期的键</li><li>执行<code class="language-plaintext highlighter-rouge">BGREWRITEAOF</code>命令所产生的重写AOF文件不会包含已经过期的键</li><li>当一个过期键被删除后，服务器会追加一条<code class="language-plaintext highlighter-rouge">DEL</code>命令到现有AOF文件的末尾，显示地删除过期键</li><li>当主服务器删除一个过期键之后，它会向所有从服务器发送一条<code class="language-plaintext highlighter-rouge">DEL</code>命令，显示地删除过期键</li><li>从服务器即使发现过期键也不会自作主张地删除它，而是等待主节点发来<code class="language-plaintext highlighter-rouge">DEL</code>命令，这种统一、中心化的过期键删除策略可以保证主从服务器数据的一致性</li><li>当Redis命令对数据库进行修改之后，服务器会根据配置向客户端发送数据库通知</li></ul><h2 id="持久化">持久化</h2><h3 id="rdb">RDB</h3><ul><li>RDB文件用于保存和还原Redis服务器所有数据库中的所有键值对数据</li><li><code class="language-plaintext highlighter-rouge">SAVE</code>命令由服务器直接执行保存操作，所以该命令会阻塞服务器</li><li><code class="language-plaintext highlighter-rouge">BGSAVE</code>命令由子进程执行保存操作，所以该命令不会阻塞服务器</li><li>服务器状态中会保存所有用<code class="language-plaintext highlighter-rouge">SAVE</code>选项设置的保存条件，当任意一个保存条件被满足时，服务器会自动执行<code class="language-plaintext highlighter-rouge">BGSAVE</code>命令</li><li>RDB文件是一个经过压缩的二进制文件，由多个部分组成</li><li>对不同类型的键值对，RDB文件会使用不同的方式来保存它们</li><li>服务器载入RDB文件期间，会一直处于阻塞状态，直到载入工作完成为止</li><li><code class="language-plaintext highlighter-rouge">BGSAVE</code>命令执行期间，服务器会拒绝客户端发送的<code class="language-plaintext highlighter-rouge">BGSAVE</code>命令（竞争条件），而客服端发送的<code class="language-plaintext highlighter-rouge">BGREWRITEAOF</code>命令会被延迟到<code class="language-plaintext highlighter-rouge">BGSAVE</code>命令执行完毕之后执行（性能考虑）</li><li><code class="language-plaintext highlighter-rouge">BGREWRITEAOF</code>执行期间，客户端发送的<code class="language-plaintext highlighter-rouge">BGSAVE</code>会被服务器拒绝（性能考虑）</li></ul><h3 id="aof">AOF</h3><ul><li>AOF文件通过保存所有修改数据库的写命令请求来记录服务器的数据库状态</li><li>AOF文件中的所有目录都以Redis命令请求协议的格式保存</li><li>命令请求会先保存到AOF缓冲区里面，之后再定期写入并同步到AOF文件</li><li><code class="language-plaintext highlighter-rouge">APPENDFSYNC</code>选项的不同值对AOF持久化功能的安全性以及Redis服务器的性能有很大的影响</li><li>服务器只要载入并重新执行保存在AOF文件中的命令，就可以还原数据库本来的状态</li><li>AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原有的AOF文件所保存的数据库状态一样，但体积更小</li><li>AOF重写是一个有歧义的名字，该功能是通过读取数据库的键值对来实现的，程序无须对现有AOF文件进行任何读入、分析或写入操作</li><li>在执行<code class="language-plaintext highlighter-rouge">BGREWRITEAOF</code>命令时，Redis服务器会维护一个AOF重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令。当子进程完成创建新AOF文件的工作之后，服务器会将缓冲区的所有内容追加到新的AOF文件的末尾，使得新旧两个AOF文件所保存的数据库状态一致。最后服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作</li><li>在整个AOF后台重写过程中，信号处理函数执行时会对服务器（父）进程造成阻塞，在其他时候，AOF后台重写都不会阻塞服务器（父）进程 ，信号处理函数有两个工作<ul><li>将AOF重写缓冲区的所有内容写入到新AOF文件中</li><li>对新的AOF文件进行改名，并原子地覆盖现有的AOF文件，完成新旧两个AOF文件的替换</li></ul></li><li>子进程在执行AOF重写期间，服务器进程需要执行三个工作<ul><li>执行客户端发送来的命令</li><li>将执行后的写命令追加到AOF缓冲区（保证现有AOF文件的处理工作会如常进行）</li><li>将执行后的写命令追加到AOF重写缓冲区（保证从创建子进程开始，服务器执行的所有写命令都会被记录到AOF重写缓冲区里面）</li></ul></li></ul><h2 id="事件">事件</h2><ul><li>Redis服务器是一个事件驱动程序，服务器处理的事件分为时间事件和文件事件</li><li>文件事件处理器是基于Reactor模式实现的网络通信程序</li><li>文件事件是对套接字操作的抽象：每次套接字变为acceptable、writeable、readable时，相应的文件事件就会产生</li><li>文件事件分为AE_READABLE事件和AE_WRITEABLE事件两类</li><li>时间事件分为定时事件和周期性事件：定时事件只在指定的时间达到一次，而周期性事件则每隔一段时间达到一次</li><li>服务器在一般情况下只执行<code class="language-plaintext highlighter-rouge">serverCron</code>函数一个时间事件，并且这个事件是周期性事件</li><li>文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程也不会进行抢占</li><li>时间事件的实际处理时间通常会比设定的到达时间晚一些</li></ul><h2 id="客户端">客户端</h2><ul><li>服务器状态结构使用clients链表连接起多个客户端状态，新添加的客户端状态会被放到链表的末尾</li><li>客户端状态的flags属性使用不同标志来表示客户端的角色，以及客户端当前所处的状态</li><li>输入缓冲区记录了客户端发送的命令请求，这个缓冲区的大小不能超过1GB</li><li>命令的参数和个数会被记录在客户端的<code class="language-plaintext highlighter-rouge">argv</code>和<code class="language-plaintext highlighter-rouge">argc</code>属性里面，而<code class="language-plaintext highlighter-rouge">cmd</code>属性则记录了客户端要执行命令的实现函数</li><li>客户端有固定大小缓冲区和可变大小缓冲区两种缓冲区可用，其中固定大小缓冲区的最大大小为16KB，而可变大小缓冲区的最大大小不能超过服务器设置的硬性限制值</li><li>输出缓冲区限制值有两种，如果输出缓冲区的大小超过了服务器设置的硬性限制，那么客户端会被立即关闭；除此之外，如果客户端在一定时间内，一直超过服务器设置的软性限制，那么客户端也会被关闭</li><li>当一个客户端通过网络连接连上服务器时，服务器会为这个客服端创建相应的客户端状态。网络连接关闭、发送了不符合协议格式的命令请求、成为<code class="language-plaintext highlighter-rouge">CLIENT KILL</code>命令的目标、空转时间超时、输出缓冲区的大小超出限制，以上原因都会造成客户端被关闭</li><li>处理Lua脚本的伪客户端在服务器初始化时创建，这个客户端会一直存在，直到服务器关闭</li><li>载入AOF文件时使用的伪客户端在载入工作开始时动态创建，载入工作完毕之后关闭</li></ul><h2 id="服务器">服务器</h2><ul><li>一个命令请求从发送到完成主要包括以下步骤<ol><li>客户端将命令请求发送给服务器</li><li>服务器读取命令请求，并分析出命令参数</li><li>命令执行器根据参数查找命令的实现函数，然后执行实现函数并得出命令回复</li><li>服务器将命令回复返回给客户端</li></ol></li><li><code class="language-plaintext highlighter-rouge">serverCron</code>函数默认每隔100毫秒执行一次，它的工作主要包括更新服务器状态信息，处理服务器接收的SIGTERM信号，管理客户端资源和数据库状态，检查并执行持久化操作等等</li><li>服务器从启动到能够处理客户端的命令请求需要执行以下步骤<ol><li>初始化服务器状态</li><li>载入服务器配置</li><li>初始化服务器数据结构</li><li>还原数据库状态</li><li>执行事件循环</li></ol></li></ul><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://dreamylost.cn" target="_blank">梦境迷离</a></li><li>本文链接：<a href="https://dreamylost.cn/redis/Redis-Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0_2.html" target="_blank">https://dreamylost.cn/redis/Redis-Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0_2.html</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/redis/Redis-Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%A', clientID: '061aadb5d449c0877d7d', clientSecret: '9aa7af7c248a7e36a07a86993e11a7acf7fbd353', repo: 'dreamylost-comments', owner: 'jxnu-liguobin', admin: ['jxnu-liguobin'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@built/assets/search_data.json?v=1619605122', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8236444920328818" data-ad-slot="6220614560" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2019 <span title="梦境迷离">梦境迷离</span> <a href="http://www.beian.miit.gov.cn/publish/query/indexFirst.action" rel="nofollow" target="_blank">赣ICP备17017283号-1</a> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/jxnu-liguobin/jxnu-liguobin.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://dreamylost.cn/" title="首页" target="">首页</a></li><li> <a href="https://dreamylost.cn/categories/" title="分类" target="">分类</a></li><li> <a href="https://dreamylost.cn/wiki/" title="维基" target="">维基</a></li><li> <a href="https://dreamylost.cn/links/" title="链接" target="">链接</a></li><li> <a href="https://dreamylost.cn/about/" title="关于" target="">关于</a></li><li><a href="https://dreamylost.cn/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2019-09-20 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-147390701-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
