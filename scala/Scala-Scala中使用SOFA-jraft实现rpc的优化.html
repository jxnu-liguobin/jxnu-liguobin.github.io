<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Scala中使用SOFA jraft实现rpc的优化 &mdash; 梦境迷离</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://blog.dreamylost.cn/scala/Scala-Scala%E4%B8%AD%E4%BD%BF%E7%94%A8SOFA-jraft%E5%AE%9E%E7%8E%B0rpc%E7%9A%84%E4%BC%98%E5%8C%96.html"><link rel="alternate" type="application/atom+xml" title="梦境迷离" href="https://blog.dreamylost.cn/feed.xml"><link rel="shortcut icon" href="https://dreamylost.cn/favicon.ico"><meta property="og:title" content="Scala中使用SOFA jraft实现rpc的优化"><meta name="keywords" content="梦境迷离, jxnu-liguobin"><meta name="og:keywords" content="梦境迷离, jxnu-liguobin"><meta name="description" content=""><meta name="og:description" content=""><meta property="og:url" content="https://blog.dreamylost.cn/scala/Scala-Scala%E4%B8%AD%E4%BD%BF%E7%94%A8SOFA-jraft%E5%AE%9E%E7%8E%B0rpc%E7%9A%84%E4%BC%98%E5%8C%96.html"><meta property="og:site_name" content="梦境迷离"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-12-05"> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-8236444920328818" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://blog.dreamylost.cn/" title="梦境迷离"><span class="octicon octicon-mark-github"></span> 梦境迷离</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://blog.dreamylost.cn/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://blog.dreamylost.cn/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://blog.dreamylost.cn/archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://blog.dreamylost.cn/open-source/" class=" site-header-nav-item" target="" title="开源">开源</a> <a href="https://blog.dreamylost.cn/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://blog.dreamylost.cn/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://blog.dreamylost.cn/about/" class=" site-header-nav-item" target="" title="关于">关于</a> <a href="https://blog.dreamylost.cn/donate/" class=" site-header-nav-item" target="" title="捐赠">捐赠</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Scala中使用SOFA jr"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Scala中使用SOFA jraft实现rpc的优化</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/12/05 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://blog.dreamylost.cn/categories/#Scala" title="Scala">Scala</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 7261 字，约 21 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/images/qrcode.jpg" alt="梦境迷离" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" > <ins class="adsbygoogle content-header-ad" data-ad-client="ca-pub-8236444920328818" data-ad-slot="3977594606"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <br /><article class="article-content markdown-body"><ul id="markdown-toc"><li><a href="#背景" id="markdown-toc-背景">背景</a></li><li><a href="#使用宏方法进行优化" id="markdown-toc-使用宏方法进行优化">使用宏方法进行优化</a><ul><li><a href="#processable宏的初步设计" id="markdown-toc-processable宏的初步设计">Processable宏的初步设计</a></li><li><a href="#processable宏的改进-一" id="markdown-toc-processable宏的改进-一">Processable宏的改进 一</a></li><li><a href="#processable宏的改进-二" id="markdown-toc-processable宏的改进-二">Processable宏的改进 二</a></li></ul></li></ul><h2 id="背景">背景</h2><p>项目基于sofa jraft构建，顺便使用了其自带的rpc服务，协议使用<code class="language-plaintext highlighter-rouge">protobuf</code>，使用jraft创建一个rpc服务<code class="language-plaintext highlighter-rouge">RaftRpcServerFactory.createRaftRpcServer(serverId.getEndpoint)</code>，并 新增的rpc接口，这通常需要定义自己的Processor并继承<code class="language-plaintext highlighter-rouge">com.alipay.sofa.jraft.rpc.RpcRequestProcessor</code>，然后创建一个实例，使用<code class="language-plaintext highlighter-rouge">rpcServer.registerProcessor</code>将实例暴露的rpc注册到<code class="language-plaintext highlighter-rouge">RpcServer</code>中。这里的待改善问题是当我们的接口变多时，Processor并不容易管理，同时个人认为，定义Processor的过程是繁琐和枯燥的，几乎都是一个模板。而我很懒哈哈，不想一个个写，除了业务，不想来回写。下面看看怎么简化这个流程吧。</p><p>下面使用<a href="https://github.com/bitlap/bitlap">bitlap</a>的一个创建会话的Processor来说明</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// networkService是业务逻辑所在类</span>
<span class="k">class</span> <span class="nc">OpenSessionProcessor</span><span class="o">(</span><span class="k">private</span> <span class="k">val</span> <span class="nv">networkService</span><span class="k">:</span> <span class="kt">NetworkService</span><span class="o">,</span> <span class="n">executor</span><span class="k">:</span> <span class="kt">Executor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">BitlapRpcProcessor</span><span class="o">[</span><span class="kt">BOpenSessionReq</span><span class="o">](</span><span class="n">executor</span><span class="o">,</span> <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">getDefaultInstance</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// BitlapRpcProcessor将RpcRequestProcessor的handleRequest方法处理分为正常处理processRequest和processError异常处理</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">BOpenSessionReq</span><span class="o">,</span> <span class="n">done</span><span class="k">:</span> <span class="kt">RpcRequestClosure</span><span class="o">)</span><span class="k">:</span> <span class="kt">Message</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">scala.jdk.CollectionConverters.MapHasAsScala</span>
    <span class="k">val</span> <span class="nv">username</span> <span class="k">=</span> <span class="nv">request</span><span class="o">.</span><span class="py">getUsername</span>
    <span class="k">val</span> <span class="nv">password</span> <span class="k">=</span> <span class="nv">request</span><span class="o">.</span><span class="py">getPassword</span>
    <span class="k">val</span> <span class="nv">configurationMap</span> <span class="k">=</span> <span class="nv">request</span><span class="o">.</span><span class="py">getConfigurationMap</span>
    <span class="k">val</span> <span class="nv">sessionHandle</span> <span class="k">=</span> <span class="nv">networkService</span><span class="o">.</span><span class="py">openSession</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span>
      <span class="nv">configurationMap</span><span class="o">.</span><span class="py">asScala</span><span class="o">.</span><span class="py">toMap</span><span class="o">)</span>
    <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">()</span>
      <span class="o">.</span><span class="py">setSessionHandle</span><span class="o">(</span><span class="nv">sessionHandle</span><span class="o">.</span><span class="py">toBSessionHandle</span><span class="o">())</span>
      <span class="o">.</span><span class="py">setStatus</span><span class="o">(</span><span class="nf">success</span><span class="o">()).</span><span class="py">build</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">processError</span><span class="o">(</span><span class="n">rpcCtx</span><span class="k">:</span> <span class="kt">RpcContext</span><span class="o">,</span> <span class="n">exception</span><span class="k">:</span> <span class="kt">Exception</span><span class="o">)</span><span class="k">:</span> <span class="kt">Message</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setStatus</span><span class="o">(</span><span class="nf">error</span><span class="o">(</span><span class="n">exception</span><span class="o">)).</span><span class="py">build</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">interest</span><span class="o">()</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">BOpenSessionReq</span><span class="o">].</span><span class="py">getName</span>
<span class="o">}</span>
</code></pre></div></div><p>这里面其实没什么代码，主要是代码在<code class="language-plaintext highlighter-rouge">networkService</code>中，但是这里需要创建<code class="language-plaintext highlighter-rouge">OpenSessionProcessor</code>这个类，算是个模板类，这里虽然使用<code class="language-plaintext highlighter-rouge">BitlapRpcProcessor</code>做了一次优化，但是效果一般。（毕竟我是个懒人，能少写一行代码都是好的，哈哈）</p><p><code class="language-plaintext highlighter-rouge">BitlapRpcProcessor</code>的定义如下：</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">class</span> <span class="nc">BitlapRpcProcessor</span><span class="o">[</span><span class="kt">T</span> <span class="k">&lt;:</span> <span class="kt">Message</span><span class="o">](</span><span class="n">executor</span><span class="k">:</span> <span class="kt">Executor</span><span class="o">,</span> <span class="k">override</span> <span class="k">val</span> <span class="nv">defaultResp</span><span class="k">:</span> <span class="kt">Message</span><span class="o">)</span>
  <span class="k">extends</span> <span class="nc">RpcRequestProcessor</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">executor</span><span class="o">,</span> <span class="n">defaultResp</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">ProcessorHelper</span> <span class="k">with</span> <span class="nc">LazyLogging</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">rpcCtx</span><span class="k">:</span> <span class="kt">RpcContext</span><span class="o">,</span> <span class="n">request</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">msg</span> <span class="k">=</span> <span class="nf">processRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RpcRequestClosure</span><span class="o">(</span><span class="n">rpcCtx</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="py">defaultResp</span><span class="o">))</span>
      <span class="nf">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">rpcCtx</span><span class="o">.</span><span class="py">sendResponse</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span>
        <span class="nv">logger</span><span class="o">.</span><span class="py">error</span><span class="o">(</span><span class="n">s</span><span class="s">"handleRequest $request failed"</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
        <span class="nv">rpcCtx</span><span class="o">.</span><span class="py">sendResponse</span><span class="o">(</span><span class="nf">processError</span><span class="o">(</span><span class="n">rpcCtx</span><span class="o">,</span> <span class="n">e</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">processError</span><span class="o">(</span><span class="n">rpcCtx</span><span class="k">:</span> <span class="kt">RpcContext</span><span class="o">,</span> <span class="n">exception</span><span class="k">:</span> <span class="kt">Exception</span><span class="o">)</span><span class="k">:</span> <span class="kt">Message</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="使用宏方法进行优化">使用宏方法进行优化</h2><p>根据如上所示，我们的目的是通过一种方法宏的处理，在不创建新的类文件的情况下创建<code class="language-plaintext highlighter-rouge">com.alipay.sofa.jraft.rpc.RpcRequestProcessor</code>的实例。这个宏定义为<code class="language-plaintext highlighter-rouge">Processable</code></p><p>考虑：</p><ol><li>泛型、类型安全</li><li>业务处理</li><li>自定义拓展</li></ol><p>一般Processor是使用<code class="language-plaintext highlighter-rouge">RpcRequestProcessor</code>的构造函数派生子类。这里的2个构造函数分别是执行请求的和protobuf <code class="language-plaintext highlighter-rouge">Message</code>类型的响应消息的默认实例</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="nf">RpcRequestProcessor</span><span class="o">(</span><span class="nc">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="nc">Message</span> <span class="n">defaultResp</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">defaultResp</span> <span class="o">=</span> <span class="n">defaultResp</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div><h3 id="processable宏的初步设计">Processable宏的初步设计</h3><p>下面使用<strong>黑盒宏</strong>来实现。</p><p><strong>宏的定义</strong></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">Req</span> <span class="k">&lt;:</span> <span class="kt">Message</span>, <span class="kt">Service</span>, <span class="kt">Executor</span> <span class="k">&lt;:</span> <span class="kt">java.util.concurrent.Executor</span><span class="o">]</span>
      <span class="o">(</span><span class="n">service</span><span class="k">:</span> <span class="kt">Service</span><span class="o">,</span> <span class="n">defaultResp</span><span class="k">:</span> <span class="kt">Message</span><span class="o">,</span> <span class="n">executor</span><span class="k">:</span> <span class="kt">Executor</span><span class="o">)</span>
      <span class="o">(</span>
      <span class="n">processRequest</span><span class="k">:</span>   <span class="o">(</span><span class="kt">Service</span><span class="o">,</span> <span class="kt">RpcRequestClosure</span><span class="o">,</span> <span class="nc">Req</span><span class="o">)</span> <span class="k">⇒</span> <span class="nc">Message</span><span class="o">,</span>
      <span class="n">processException</span><span class="k">:</span> <span class="o">(</span><span class="kt">Service</span><span class="o">,</span> <span class="kt">RpcContext</span><span class="o">,</span> <span class="nc">Exception</span><span class="o">)</span> <span class="k">⇒</span> <span class="nc">Message</span><span class="o">)</span><span class="k">:</span> <span class="kt">CustomRpcProcessor</span><span class="o">[</span><span class="kt">Req</span><span class="o">]</span> 
      <span class="k">=</span> <span class="n">macro</span> <span class="nv">ProcessableMacro</span><span class="o">.</span><span class="py">processorImpl</span><span class="o">[</span><span class="kt">Req</span>, <span class="kt">Service</span>, <span class="kt">Executor</span><span class="o">]</span>
</code></pre></div></div><p>泛型说明：</p><ul><li><code class="language-plaintext highlighter-rouge">Req</code> protobuf定义的类型，用于request的消息类型，必须是<code class="language-plaintext highlighter-rouge">com.google.protobuf.Message</code>的子类。</li><li><code class="language-plaintext highlighter-rouge">Service</code> 用户自定义的服务接口，用于处理业务逻辑，可以为任意类型。</li><li><code class="language-plaintext highlighter-rouge">Executor</code> 用于传递给<code class="language-plaintext highlighter-rouge">RpcRequestProcessor</code>的构造函数，必须是<code class="language-plaintext highlighter-rouge">java.util.concurrent.Executor</code>的子类。</li></ul><p>参数说明：</p><ul><li><code class="language-plaintext highlighter-rouge">processRequest: (Service, RpcRequestClosure, Req) ⇒ Message</code> 一个处理请求的函数，可以实现任意业务逻辑，最重要的参数。</li><li><code class="language-plaintext highlighter-rouge">processException: (Service, RpcContext, Exception) ⇒ Message</code> 一个处理异常的函数。</li><li><code class="language-plaintext highlighter-rouge">service: Service</code> 操作业务所需要的实例对象。</li><li><code class="language-plaintext highlighter-rouge">defaultResp: Message</code> protobuf定义的类型的默认实例，用于传递给<code class="language-plaintext highlighter-rouge">RpcRequestProcessor</code>的构造函数。</li><li><code class="language-plaintext highlighter-rouge">executor: Executor</code> 用于传递给<code class="language-plaintext highlighter-rouge">RpcRequestProcessor</code>的构造函数，必须是<code class="language-plaintext highlighter-rouge">java.util.concurrent.Executor</code>的子类。</li></ul><blockquote><p>返回的<code class="language-plaintext highlighter-rouge">Message</code>通常是自己定义的用于响应的protobuf对象的子类</p></blockquote><p>初步的设计照搬了<code class="language-plaintext highlighter-rouge">OpenSessionProcessor</code>的实现，只是使用宏创建类的实例对象，所以乍一看参数很多，不便使用。 考虑到大多数情况下并不需要这么灵活的定义，还是可以再简化一下宏定义的。先看protobuf例子。</p><p><strong>示例</strong></p><p>对于现有protobuf文件：</p><div class="language-protobuf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">BOpenSession</span> <span class="p">{</span>
    <span class="kd">message</span> <span class="nc">BOpenSessionReq</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="na">username</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">string</span> <span class="na">password</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="err">&gt;</span> <span class="na">configuration</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">message</span> <span class="nc">BOpenSessionResp</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="na">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="err">&gt;</span>  <span class="na">configuration</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">string</span> <span class="na">session_handle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>使用<code class="language-plaintext highlighter-rouge">Processable</code>宏:</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">val</span> <span class="nv">openSession</span> <span class="k">=</span> <span class="nc">Processable</span><span class="o">[</span><span class="kt">BOpenSessionReq</span>, <span class="kt">NetService</span>, <span class="kt">Executor</span><span class="o">](</span>
    <span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">rpcRequestClosure</span><span class="o">,</span> <span class="n">req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">import</span> <span class="nn">scala.jdk.CollectionConverters.MapHasAsScala</span>
      <span class="k">val</span> <span class="nv">username</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getUsername</span>
      <span class="k">val</span> <span class="nv">password</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getPassword</span>
      <span class="k">val</span> <span class="nv">configurationMap</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getConfigurationMap</span>
      <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">service</span><span class="o">.</span><span class="py">openSession</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="nv">configurationMap</span><span class="o">.</span><span class="py">asScala</span><span class="o">.</span><span class="py">toMap</span><span class="o">)</span>
      <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setSessionHandle</span><span class="o">(</span><span class="n">ret</span><span class="o">).</span><span class="py">build</span><span class="o">()</span>
    <span class="o">},</span>
    <span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">rpcContext</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setStatus</span><span class="o">(</span><span class="nv">exception</span><span class="o">.</span><span class="py">getLocalizedMessage</span><span class="o">).</span><span class="py">build</span><span class="o">()</span>
    <span class="o">},</span>
    <span class="k">new</span> <span class="nc">NetService</span><span class="o">,</span> <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">getDefaultInstance</span><span class="o">,</span> <span class="kc">null</span>
  <span class="o">)</span>
</code></pre></div></div><h3 id="processable宏的改进-一">Processable宏的改进 一</h3><p>本次改进不是为了拓展，而是为了在一般情况下，宏方法容易使用，目标当然是减少参数传递，但是哪些参数可以减少呢？ 下面列了2个参数一般都是默认值，所以就可以简化它。需要注意，这里简化并不是就不支持传递这些参数了，因为Scala object的<code class="language-plaintext highlighter-rouge">apply</code>方法是能重载的，所以是共存的。 为什么我们要使用<code class="language-plaintext highlighter-rouge">apply</code>方法？object的<code class="language-plaintext highlighter-rouge">apply</code>能使得我们使用<code class="language-plaintext highlighter-rouge">Processable[T](xx)</code>的形式来调用，而不需要<code class="language-plaintext highlighter-rouge">Processable[T].toProcessor(xx)</code>，是不是更清爽了，哈哈。</p><p><strong>宏的定义</strong></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">apply</span><span class="o">[</span><span class="kt">Service</span>, <span class="kt">Req</span> <span class="k">&lt;:</span> <span class="kt">Message</span>, <span class="kt">Resp</span> <span class="k">&lt;:</span> <span class="kt">Message</span><span class="o">](</span><span class="n">service</span><span class="k">:</span> <span class="kt">Service</span><span class="o">)</span>
      <span class="o">(</span>
      <span class="n">processRequest</span><span class="k">:</span>   <span class="o">(</span><span class="kt">Service</span><span class="o">,</span> <span class="kt">RpcRequestClosure</span><span class="o">,</span> <span class="nc">Req</span><span class="o">)</span> <span class="k">⇒</span> <span class="nc">Message</span><span class="o">,</span>
      <span class="n">processException</span><span class="k">:</span> <span class="o">(</span><span class="kt">Service</span><span class="o">,</span> <span class="kt">RpcContext</span><span class="o">,</span> <span class="nc">Exception</span><span class="o">)</span> <span class="k">⇒</span> <span class="nc">Message</span><span class="o">)</span><span class="k">:</span> <span class="kt">CustomRpcProcessor</span><span class="o">[</span><span class="kt">Req</span><span class="o">]</span> <span class="k">=</span> 
      <span class="n">macro</span> <span class="nv">ProcessableMacro</span><span class="o">.</span><span class="py">processorWithDefaultRespImpl</span><span class="o">[</span><span class="kt">Service</span>, <span class="kt">Req</span>, <span class="kt">Resp</span><span class="o">]</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">executor</code> 直接使用<code class="language-plaintext highlighter-rouge">null</code>，不支持传入自定义参数。</li><li><code class="language-plaintext highlighter-rouge">defaultResp</code> 直接使用<code class="language-plaintext highlighter-rouge">Resp.getDefaultInstance</code>创建默认对象 ，不支持传入自定义参数。</li></ul><p>与第一次定义很类似，仅是省略了<code class="language-plaintext highlighter-rouge">executor</code>和<code class="language-plaintext highlighter-rouge">defaultResp</code>参数，但是泛型参数都保留了，这是为了类型安全。这次由于没有传<code class="language-plaintext highlighter-rouge">defaultResp</code>，所以需要使用泛型<code class="language-plaintext highlighter-rouge">Resp</code>指定默认值的类型，其实内部仍是是使用了<code class="language-plaintext highlighter-rouge">getDefaultInstance</code>。这里也能观察到，灵活性和便捷性是不可都得的。</p><p><strong>示例</strong></p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">val</span> <span class="nv">openSession</span> <span class="k">=</span> <span class="nc">Processable</span><span class="o">[</span><span class="kt">NetService</span>, <span class="kt">BOpenSessionReq</span>, <span class="kt">BOpenSessionResp</span><span class="o">](</span><span class="k">new</span> <span class="nc">NetService</span><span class="o">)(</span>
    <span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">import</span> <span class="nn">scala.jdk.CollectionConverters.MapHasAsScala</span>
      <span class="k">val</span> <span class="nv">username</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getUsername</span>
      <span class="k">val</span> <span class="nv">password</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getPassword</span>
      <span class="k">val</span> <span class="nv">configurationMap</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getConfigurationMap</span>
      <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">service</span><span class="o">.</span><span class="py">openSession</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="nv">configurationMap</span><span class="o">.</span><span class="py">asScala</span><span class="o">.</span><span class="py">toMap</span><span class="o">)</span>
      <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setSessionHandle</span><span class="o">(</span><span class="n">ret</span><span class="o">).</span><span class="py">build</span><span class="o">()</span>
    <span class="o">},</span>
    <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setStatus</span><span class="o">(</span><span class="nv">exception</span><span class="o">.</span><span class="py">getLocalizedMessage</span><span class="o">).</span><span class="py">build</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">)</span>
</code></pre></div></div><h3 id="processable宏的改进-二">Processable宏的改进 二</h3><p>到上面为止，其实差不多可以了，再次简化就只能是连<code class="language-plaintext highlighter-rouge">service</code>都不传了。可以做到吗？答案是肯定的，我们可以用运行时反射来创建对象。 虽然之前都做的是编译期反射，这次结合编译期和运行期来看看具体应用。</p><ul><li>为<code class="language-plaintext highlighter-rouge">Service</code>泛型反射出对象，不再需要传 <code class="language-plaintext highlighter-rouge">service</code> 参数</li><li>仅支持非抽象类且必须含有默认无参构造函数</li></ul><p>Scala如何反射一个类来创建类的对象呢？</p><p>我们定义一个<code class="language-plaintext highlighter-rouge">Creator</code>，通过参数<code class="language-plaintext highlighter-rouge">T:WeakTypeTag</code>反射。<code class="language-plaintext highlighter-rouge">WeakTypeTag</code>由编译器创建，使用<code class="language-plaintext highlighter-rouge">T</code>的<code class="language-plaintext highlighter-rouge">tpe</code>属性可以反射<code class="language-plaintext highlighter-rouge">T</code>。 <code class="language-plaintext highlighter-rouge">WeakTypeTag</code>力求尽可能是具体的类型，即如果<code class="language-plaintext highlighter-rouge">TypeTag</code>可用于引用的类型参数或抽象类型，则它们用于将具体类型嵌入<code class="language-plaintext highlighter-rouge">WeakTypeTag</code>。 否则<code class="language-plaintext highlighter-rouge">WeakTypeTag</code>将包含对抽象类型的引用。当人们期望<code class="language-plaintext highlighter-rouge">T</code>可能是部分抽象的，但需要特别小心来处理这种情况时，这种行为是有用的。 但是，如果<code class="language-plaintext highlighter-rouge">T</code>应该是完全已知的，则应该使用<code class="language-plaintext highlighter-rouge">TypeTag</code>，它静态地保证了这个属性。<code class="language-plaintext highlighter-rouge">TypeTag</code>它不包含任何对未解析类型参数或抽象类型的引用。</p><p>Scala的抽象语法树除了三个字段外，是不可变的。这三个就是<code class="language-plaintext highlighter-rouge">symbol</code>，<code class="language-plaintext highlighter-rouge">pos</code>，<code class="language-plaintext highlighter-rouge">tpe</code>。对于编译器而言，类型检查不是一步到位的，所以<code class="language-plaintext highlighter-rouge">pos</code>，<code class="language-plaintext highlighter-rouge">tpe</code>，<code class="language-plaintext highlighter-rouge">symbol</code>这种属性，可能在某阶段是没有值的。 而在typechecked后就能获取到实际值。这在编译期反射中很有用。</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Creator</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">WeakTypeTag</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">createInstance</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">AnyRef*</span><span class="o">)(</span><span class="n">ctor</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">tt</span> <span class="k">=</span> <span class="n">weakTypeTag</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
    <span class="nv">currentMirror</span><span class="o">.</span><span class="py">reflectClass</span><span class="o">(</span><span class="nv">tt</span><span class="o">.</span><span class="py">tpe</span><span class="o">.</span><span class="py">typeSymbol</span><span class="o">.</span><span class="py">asClass</span><span class="o">).</span><span class="py">reflectConstructor</span><span class="o">(</span>
      <span class="nv">tt</span><span class="o">.</span><span class="py">tpe</span><span class="o">.</span><span class="py">members</span><span class="o">.</span><span class="py">filter</span><span class="o">(</span><span class="n">m</span> <span class="k">=&gt;</span>
        <span class="nv">m</span><span class="o">.</span><span class="py">isMethod</span> <span class="o">&amp;&amp;</span> <span class="nv">m</span><span class="o">.</span><span class="py">asMethod</span><span class="o">.</span><span class="py">isConstructor</span>
      <span class="o">).</span><span class="py">iterator</span><span class="o">.</span><span class="py">toSeq</span><span class="o">(</span><span class="n">ctor</span><span class="o">).</span><span class="py">asMethod</span>
    <span class="o">)(</span><span class="n">args</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">).</span><span class="py">asInstanceOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>有了反射功能，我们只需要将<code class="language-plaintext highlighter-rouge">NetService</code>传入作为<code class="language-plaintext highlighter-rouge">Service</code>的类型，在宏中使用运行时反射构造对象即可。</p><div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// 这里即使与上面相比少了个service参数，但是因为编译器识别时有点问题，会和上面那个重载的apply定义冲突，所以把泛型的位置改了下，把Service泛型放到最后。</span>
  <span class="k">val</span> <span class="nv">openSession</span> <span class="k">=</span> <span class="nc">Processable</span><span class="o">[</span><span class="kt">BOpenSessionReq</span>, <span class="kt">BOpenSessionResp</span>, <span class="kt">NetService</span><span class="o">](</span>
    <span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">rpc</span><span class="o">,</span> <span class="n">req</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">import</span> <span class="nn">scala.jdk.CollectionConverters.MapHasAsScala</span>
      <span class="k">val</span> <span class="nv">username</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getUsername</span>
      <span class="k">val</span> <span class="nv">password</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getPassword</span>
      <span class="k">val</span> <span class="nv">configurationMap</span> <span class="k">=</span> <span class="nv">req</span><span class="o">.</span><span class="py">getConfigurationMap</span>
      <span class="k">val</span> <span class="nv">ret</span> <span class="k">=</span> <span class="nv">service</span><span class="o">.</span><span class="py">openSession</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="nv">configurationMap</span><span class="o">.</span><span class="py">asScala</span><span class="o">.</span><span class="py">toMap</span><span class="o">)</span>
      <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setSessionHandle</span><span class="o">(</span><span class="n">ret</span><span class="o">).</span><span class="py">build</span><span class="o">()</span>
    <span class="o">},</span>
    <span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">rpc</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="nv">BOpenSessionResp</span><span class="o">.</span><span class="py">newBuilder</span><span class="o">().</span><span class="py">setStatus</span><span class="o">(</span><span class="nv">exception</span><span class="o">.</span><span class="py">getLocalizedMessage</span><span class="o">).</span><span class="py">build</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">)</span>
</code></pre></div></div><p>到目前为止，再一般情况下，我们甚至只需要提供2个函数就能实现任意Processor的定义了，再也不用创建类了，哈哈。</p><p>宏的实现是比较难懂的，这里没有贴代码，感兴趣的可以看看源码。https://github.com/jxnu-liguobin/scala-macro-tools/tree/master/src/main/scala/io/github/dreamylost/sofa。</p><blockquote><p>如果对你有帮助可以点个star。</p></blockquote><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://blog.dreamylost.cn" target="_blank">梦境迷离</a></li><li>本文链接：<a href="https://blog.dreamylost.cn/scala/Scala-Scala%E4%B8%AD%E4%BD%BF%E7%94%A8SOFA-jraft%E5%AE%9E%E7%8E%B0rpc%E7%9A%84%E4%BC%98%E5%8C%96.html" target="_blank">https://blog.dreamylost.cn/scala/Scala-Scala%E4%B8%AD%E4%BD%BF%E7%94%A8SOFA-jraft%E5%AE%9E%E7%8E%B0rpc%E7%9A%84%E4%BC%98%E5%8C%96.html</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/scala/Scala-Scala%E4%B8%AD%E4%BD%BF%E7%94%A8SOFA-', clientID: '061aadb5d449c0877d7d', clientSecret: '9aa7af7c248a7e36a07a86993e11a7acf7fbd353', repo: 'dreamylost-comments', owner: 'jxnu-liguobin', admin: ['jxnu-liguobin'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@built/assets/search_data.json?v=1698023425', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8236444920328818" data-ad-slot="6220614560" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2019 <span title="梦境迷离">梦境迷离</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/jxnu-liguobin/jxnu-liguobin.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://blog.dreamylost.cn/" title="首页" target="">首页</a></li><li> <a href="https://blog.dreamylost.cn/categories/" title="分类" target="">分类</a></li><li> <a href="https://blog.dreamylost.cn/archives/" title="归档" target="">归档</a></li><li> <a href="https://blog.dreamylost.cn/open-source/" title="开源" target="">开源</a></li><li> <a href="https://blog.dreamylost.cn/wiki/" title="维基" target="">维基</a></li><li> <a href="https://blog.dreamylost.cn/links/" title="链接" target="">链接</a></li><li> <a href="https://blog.dreamylost.cn/about/" title="关于" target="">关于</a></li><li> <a href="https://blog.dreamylost.cn/donate/" title="捐赠" target="">捐赠</a></li><li><a href="https://blog.dreamylost.cn/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2019-09-20 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/jxnu-liguobin/jxnu-liguobin.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-147390701-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
