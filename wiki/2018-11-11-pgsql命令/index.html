<p>系统默认是（CentOS或Mac）</p>

<p>//后面是追加注释</p>

<ul>
  <li>安装</li>
</ul>

<blockquote>
  <p>yum install postgresql*  //版本</p>
</blockquote>

<ul>
  <li>初始化数据库</li>
</ul>

<blockquote>
  <p>initdb /usr/local/var/postgres //Mac上使用brew安装，/usr/local/var/postgres是安装目录，下同</p>
</blockquote>

<ul>
  <li>启动数据库</li>
</ul>

<blockquote>
  <p>pg_ctl -D /usr/local/var/postgres -l logfile start</p>
</blockquote>

<ul>
  <li>查看数据库状态</li>
</ul>

<blockquote>
  <p>pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log status</p>
</blockquote>

<ul>
  <li>停止数据库</li>
</ul>

<blockquote>
  <p>pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log stop -s -m fast</p>
</blockquote>

<blockquote>
  <p>ps -ef | grep postgres 或 ps auxwww | grep postgres $$//查看进程</p>
</blockquote>

<ul>
  <li>设置为开机自启动</li>
</ul>

<blockquote>
  <p>systemctl enable postgresql  //需要权限</p>
</blockquote>

<ul>
  <li>启动PostgreSQL</li>
</ul>

<blockquote>
  <p>systemctl start postgresql</p>
</blockquote>

<ul>
  <li>进入数据库</li>
</ul>

<blockquote>
  <p>su - postgres</p>
</blockquote>

<ul>
  <li>创建角色</li>
</ul>

<blockquote>
  <p>createuser admin（用户名）</p>
</blockquote>

<ul>
  <li>创建数据库实例</li>
</ul>

<blockquote>
  <p>createdb -e -O admin（用户名） testdb（实例名）</p>
</blockquote>

<ul>
  <li>进入查询分析器</li>
</ul>

<blockquote>
  <p>psql</p>
</blockquote>

<ul>
  <li>设置密码</li>
</ul>

<blockquote>
  <p>\password admin;（用户名，用分号结束）</p>
</blockquote>

<ul>
  <li>退出查询分析器</li>
</ul>

<blockquote>
  <p>\q（不需要分号结束）</p>
</blockquote>

<ul>
  <li>退出数据库</li>
</ul>

<blockquote>
  <p>exit</p>
</blockquote>

<ul>
  <li>修改监听</li>
</ul>

<blockquote>
  <p>vim /var/lib/pgsql/data/postgresql.conf   //将这句注释打开</p>
</blockquote>

<blockquote>
  <p>listen_addresses = ‘*’  //并修改</p>
</blockquote>

<ul>
  <li>修改验证方式</li>
</ul>

<blockquote>
  <p>vim /var/lib/pgsql/data/pg_hba.conf   //host  all  all  127.0.0.1/32（允许哪个IP访问，如果允许全部，则写成0.0.0.0/0）  md5（md5为密码验证）</p>
</blockquote>

<ul>
  <li>重启数据库</li>
</ul>

<blockquote>
  <p>systemctl restart postgresql</p>
</blockquote>

<ul>
  <li>使用密码登录数据库</li>
</ul>

<blockquote>
  <p>psql -U admin（用户名） -d testdb（数据库） -h 127.0.0.1（登录哪个IP）</p>
</blockquote>

<ul>
  <li>创建数据库并指定所有者</li>
</ul>

<blockquote>
  <p>createdb growing_test -O admin（用户名） -E UTF8 -e</p>
</blockquote>

<ul>
  <li>查看apps的所有表名</li>
</ul>

<blockquote>
  <p>select * from pg_tables where tableowner=’apps’   //apps是用户</p>
</blockquote>

<ul>
  <li>查询是否锁表</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">oid</span> <span class="k">from</span> <span class="n">pg_class</span> <span class="k">where</span> <span class="n">relname</span><span class="o">=</span><span class="s1">'可能锁表了的表'</span>
<span class="k">select</span> <span class="n">pid</span> <span class="k">from</span> <span class="n">pg_locks</span> <span class="k">where</span> <span class="n">relation</span><span class="o">=</span><span class="s1">'上面查出的oid'</span>
</code></pre></div></div>

<ul>
  <li>释放锁定表</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">pg_cancel_backend</span><span class="p">(</span><span class="n">pg_locks</span><span class="p">.</span><span class="n">pid</span><span class="p">)</span> 
</code></pre></div></div>

<ul>
  <li>迁移数据库</li>
</ul>

<p>dump数据库</p>

<blockquote>
  <p>pg_dump –file “/Users/userName/dump_backoup” –host “域名” –port “7531” –username “apps” testdb</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--file: dump文件生成到本地到文件地址
--host: 要dump文件到服务器地址
--port: 远程数据库的端口
--username 数据库用户
</code></pre></div></div>

<p>使用dump文件</p>

<blockquote>
  <ol>
    <li>\i /Users/userName/dump_backoup   //需要先创建对应的数据库并登陆到pgsql</li>
    <li>pg_restore -h localhost -p 5432 -U userName -W -d testdb -v “dump_backoup”</li>
  </ol>
</blockquote>

<ul>
  <li>查询表上的索引</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">pg_statio_all_indexes</span> <span class="k">where</span> <span class="n">relname</span><span class="o">=</span><span class="s1">'table_name'</span> 
</code></pre></div></div>

<p>多列索引</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>官方
https://www.postgresql.org/docs/9.6/indexes-multicolumn.html
https://wiki.postgresql.org/wiki/9.1%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0#.E5.A4.9A.E5.88.97.E7.B4.A2.E5.BC.95.28Multicolumn_Indexes.29

pgsql 多列索引
https://github.com/digoal/blog/blob/master/201702/20170205_01.md

csdn
https://blog.csdn.net/jubaoquan/article/details/78850899

开源中国
https://www.oschina.net/question/126398_22063
</code></pre></div></div>

<ul>
  <li>Json操作符</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">-- 1. -&gt; 表示获取一个JSON数组元素，支持下标值(下标从0开始)、Key获取   </span>
    <span class="c1">-- 得到 JSON对象:{"b":2}</span>
    <span class="k">SELECT</span> <span class="s1">'[{"a":1},{"b":2},{"c":3}]'</span><span class="p">::</span><span class="n">JSON</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">-- 继续使用，获取value:2</span>
    <span class="k">SELECT</span> <span class="s1">'[{"a":1},{"b":2},{"c":3}]'</span><span class="p">::</span><span class="n">JSON</span> <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="s1">'b'</span><span class="p">;</span>

    <span class="c1">-- 2. -&gt;&gt; 表示获取一个JSON对象字符串</span>
    <span class="c1">-- 得到JSON字符串:{"b":2}，此时已是字符串类型无法直接继续使用 -&gt;、-&gt;&gt;</span>
    <span class="k">SELECT</span> <span class="s1">'[{"a":1},{"b":2},{"c":3}]'</span><span class="p">::</span><span class="n">JSON</span> <span class="o">-&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">-- 3. #&gt; 表示获取指定路径的一个JSON对象</span>
    <span class="c1">-- 得到JSON对象:{"ba":"b1","bb":"b2"}</span>
    <span class="k">SELECT</span> <span class="s1">'{"a":1,"b":{"ba":"b1","bb":"b2"},"c":3}'</span><span class="p">::</span><span class="n">JSON</span> <span class="o">#&gt;</span> <span class="s1">'{b}’
    -- 继续获取，获取value:"b1"
    SELECT '</span><span class="err">{</span><span class="nv">"a"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nv">"b"</span><span class="p">:</span><span class="err">{</span><span class="nv">"ba"</span><span class="p">:</span><span class="nv">"b1"</span><span class="p">,</span><span class="nv">"bb"</span><span class="p">:</span><span class="nv">"b2"</span><span class="err">}</span><span class="p">,</span><span class="nv">"c"</span><span class="p">:</span><span class="mi">3</span><span class="err">}</span><span class="s1">'::JSON #&gt; '</span><span class="err">{</span><span class="n">b</span><span class="err">}</span><span class="s1">' -&gt; '</span><span class="n">ba</span><span class="s1">';

    -- 4. #&gt;&gt;表示获取指定路径的一个JSON对象的字符串
    -- 得到JSON字符串:{"ba":"b1","bb":"b2”}，无法继续使用 -&gt;、-&gt;&gt;
    SELECT '</span><span class="err">{</span><span class="nv">"a"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nv">"b"</span><span class="p">:</span><span class="err">{</span><span class="nv">"ba"</span><span class="p">:</span><span class="nv">"b1"</span><span class="p">,</span><span class="nv">"bb"</span><span class="p">:</span><span class="nv">"b2"</span><span class="err">}</span><span class="p">,</span><span class="nv">"c"</span><span class="p">:</span><span class="mi">3</span><span class="err">}</span><span class="s1">'::JSON #&gt;&gt; '</span><span class="err">{</span><span class="n">b</span><span class="err">}</span><span class="s1">'; —-这里{b}括号是必须的
</span></code></pre></div></div>
<p>::JSON 表示声明前面的字符串为一个JSON字符串对象，而且PgSQL中的JSON、JSONB对象 Key的声明必须是字符串
在获取一个JSON对象时，除非是JSON数组中的下标，必须要要用{}将JSON对象的Key包裹起来，否则会抛出异常</p>

<ul>
  <li>计算在每分钟内插入数据的数量</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">tmp</span><span class="p">.</span><span class="k">count</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="nb">date</span>
<span class="k">FROM</span> <span class="p">(</span>
         <span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">count</span><span class="p">,</span> <span class="n">date_trunc</span><span class="p">(</span><span class="s1">'minute'</span><span class="p">,</span> <span class="n">created_at</span><span class="p">)</span> <span class="nb">date</span>
         <span class="k">FROM</span> <span class="n">ads_tracking_campaigns</span>
         <span class="k">WHERE</span> <span class="n">creator_id</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">GROUP</span> <span class="k">BY</span> <span class="nb">date</span>
         <span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
     <span class="p">)</span> <span class="n">tmp</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="k">count</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">tmp</span><span class="p">.</span><span class="k">count</span> <span class="k">DESC</span>
<span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>
<p>主要是抹掉时间中的秒，并以时间进行分组</p>

<ul>
  <li>Hstore基本使用</li>
</ul>

<p>最近用的的记录。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 根据key查询  存在key=_gio的数据</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">ios_params</span> <span class="o">?</span> <span class="s1">'_gio'</span> <span class="k">OR</span> <span class="n">android_params</span> <span class="o">?</span> <span class="s1">'_gio'</span><span class="p">;</span>

<span class="c1">-- 查询一条数据，指定条件 k=_gio &amp; value !='非'</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">ios_params</span> <span class="o">-&gt;</span> <span class="s1">'_gio'</span> <span class="o">!=</span> <span class="s1">'非'</span><span class="p">;</span>

<span class="c1">-- 仅查询_gio字段值，指定条件 k=_gio  &amp; value !=''</span>
<span class="k">SELECT</span> <span class="n">ios_params</span> <span class="o">-&gt;</span> <span class="s1">'_gio'</span> <span class="k">as</span> <span class="n">_gio</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">ios_params</span> <span class="o">-&gt;</span> <span class="s1">'_gio'</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">;</span>

<span class="c1">-- 插入</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">books</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<span class="k">VALUES</span>
   <span class="p">(</span>
      <span class="s1">'PostgreSQL Tutorial'</span><span class="p">,</span>
      <span class="s1">'"paperback" =&gt; "243",
      "publisher" =&gt; "postgresqltutorial.com",
      "language"  =&gt; "English",
      "ISBN-13"   =&gt; "978-1449370000",
       "weight"   =&gt; "11.2 ounces"'</span>
   <span class="p">);</span>

<span class="c1">-- 向已有Hstore记录中，新增一对kv</span>

<span class="k">UPDATE</span> <span class="n">ads_tracking</span>
<span class="k">SET</span> <span class="n">ios_params</span> <span class="o">=</span> <span class="n">ios_params</span> <span class="o">||</span> <span class="s1">'"freeshipping"=&gt;"测试"'</span> <span class="p">::</span> <span class="n">hstore</span> <span class="k">WHERE</span> <span class="n">ios_params</span> <span class="o">?</span> <span class="s1">'_gio'</span><span class="p">;</span>

<span class="c1">-- 最终ios_params值新增freeshipping =&gt; 测试：</span>
<span class="c1">-- _gio =&gt; 非,</span>
<span class="c1">-- freeshipping =&gt; 测试</span>

<span class="c1">-- 从已有Hstore记录中删除指定key</span>
<span class="k">UPDATE</span> <span class="n">ads_tracking</span>
<span class="k">SET</span> <span class="n">ios_params</span> <span class="o">=</span> <span class="k">delete</span><span class="p">(</span><span class="n">ios_params</span><span class="p">,</span> <span class="s1">'freeshipping'</span><span class="p">)</span> <span class="k">WHERE</span> <span class="n">ios_params</span> <span class="o">?</span> <span class="s1">'_gio'</span><span class="p">;</span>

<span class="c1">-- 检查hstore列中特定key-value对</span>
<span class="k">SELECT</span> <span class="n">ios_params</span> <span class="o">-&gt;</span> <span class="s1">'_gio'</span> <span class="k">as</span> <span class="n">_gio</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">ios_params</span> <span class="o">@&gt;</span> <span class="s1">'"_gio" =&gt; "非"'</span> <span class="p">::</span> <span class="n">hstore</span><span class="p">;</span>

<span class="c1">-- 查询包含多个特定key的记录(同时含有两个key)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">android_params</span> <span class="o">?&amp;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'_gio'</span><span class="p">,</span> <span class="s1">'gio'</span><span class="p">];</span>

<span class="c1">-- 返回Hstore的所有key</span>
<span class="k">SELECT</span> <span class="n">akeys</span><span class="p">(</span><span class="n">android_params</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">android_params</span> <span class="o">?&amp;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'_gio'</span><span class="p">,</span> <span class="s1">'gio'</span><span class="p">];</span>

<span class="c1">-- 返回Hstore的所有value</span>
<span class="k">SELECT</span> <span class="n">avals</span><span class="p">(</span><span class="n">android_params</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">android_params</span> <span class="o">?&amp;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'_gio'</span><span class="p">,</span> <span class="s1">'gio'</span><span class="p">];</span>

<span class="c1">-- 转换hstore为json</span>
<span class="k">SELECT</span> <span class="n">hstore_to_json</span><span class="p">(</span><span class="n">android_params</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">android_params</span> <span class="o">?&amp;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'_gio'</span><span class="p">,</span> <span class="s1">'gio'</span><span class="p">];</span>

<span class="c1">-- 转换hstore为集合</span>
<span class="k">SELECT</span> <span class="k">each</span><span class="p">(</span><span class="n">android_params</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">ads_tracking</span> <span class="k">WHERE</span> <span class="n">android_params</span> <span class="o">?&amp;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'_gio'</span><span class="p">,</span> <span class="s1">'gio'</span><span class="p">];</span>
</code></pre></div></div>

<ul>
  <li>获取系统中秒级的时间</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">floor</span><span class="p">(</span><span class="k">extract</span><span class="p">(</span><span class="n">epoch</span> <span class="k">from</span><span class="p">(</span><span class="k">current_timestamp</span> <span class="o">-</span> <span class="nb">timestamp</span> <span class="s1">'1970-01-01 00:00:00'</span><span class="p">)));</span>

<span class="c1">-- 毫秒</span>
<span class="k">select</span> <span class="n">floor</span><span class="p">(</span><span class="k">extract</span><span class="p">(</span><span class="n">epoch</span> <span class="k">from</span><span class="p">((</span><span class="k">current_timestamp</span> <span class="o">-</span> <span class="nb">timestamp</span> <span class="s1">'1970-01-01 00:00:00'</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">)));</span>
</code></pre></div></div>

<ul>
  <li>分析索引使用情况和查询时间</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">explain</span> <span class="p">(</span><span class="k">analyze</span><span class="p">,</span><span class="k">verbose</span><span class="p">,</span><span class="n">timing</span><span class="p">,</span><span class="n">costs</span><span class="p">,</span><span class="n">buffers</span><span class="p">)(</span>
    <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ads_tracking_campaigns</span> <span class="k">WHERE</span> <span class="n">project_id</span> <span class="o">=</span> <span class="mi">35076</span> <span class="k">AND</span> <span class="n">name</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'PPSZ00014282/iOS'</span><span class="p">,</span><span class="s1">'36663/iOS'</span><span class="p">,</span><span class="s1">'100562/iOS'</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></div>
